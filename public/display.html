<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>リアルタイム文字起こし - 表示画面</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: "Hiragino Kaku Gothic ProN", "Hiragino Sans", "Yu Gothic Medium", "Meiryo", "MS Gothic", sans-serif;
            background-color: #000;
            color: #fff;
            overflow: hidden;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }
        
        .header {
            background-color: #1a1a1a;
            padding: 15px 30px;
            border-bottom: 2px solid #333;
            flex-shrink: 0;
        }
        
        .title {
            font-size: 24px;
            font-weight: bold;
            text-align: center;
            color: #fff;
        }
        
        .status-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 10px;
            font-size: 14px;
            color: #ccc;
        }
        
        .connection-status {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background-color: #dc3545;
        }
        
        .status-indicator.connected {
            background-color: #28a745;
        }
        
        .current-time {
            font-family: monospace;
        }
        
        .font-controls {
            flex: 1;
            text-align: center;
        }
        
        .settings-btn {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.3s;
        }
        
        .settings-btn:hover {
            background-color: #0056b3;
        }
        
        .font-settings-panel {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.9);
            z-index: 1000;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        .settings-content {
            background-color: #2a2a2a;
            padding: 30px;
            border-radius: 10px;
            width: 500px;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .settings-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            color: white;
        }
        
        .close-btn {
            background: none;
            border: none;
            color: white;
            font-size: 20px;
            cursor: pointer;
            padding: 5px 10px;
        }
        
        .close-btn:hover {
            background-color: #444;
            border-radius: 4px;
        }
        
        .setting-group {
            margin-bottom: 20px;
        }
        
        .setting-group label {
            display: block;
            color: white;
            margin-bottom: 8px;
            font-weight: bold;
        }
        
        .setting-group select {
            width: 100%;
            padding: 8px;
            border: 1px solid #555;
            border-radius: 4px;
            background-color: #444;
            color: white;
            font-size: 14px;
        }
        
        .size-controls {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .size-controls input[type="range"] {
            flex: 1;
        }
        
        .size-controls span {
            color: white;
            min-width: 50px;
            text-align: right;
            font-family: monospace;
        }
        
        .color-controls {
            display: flex;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .color-controls input[type="color"] {
            width: 50px;
            height: 35px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        
        .preset-color {
            padding: 6px 12px;
            border: 1px solid #555;
            border-radius: 4px;
            background-color: #444;
            color: white;
            cursor: pointer;
            font-size: 12px;
            transition: background-color 0.3s;
        }
        
        .preset-color:hover {
            background-color: #555;
        }
        
        .reset-btn {
            width: 100%;
            padding: 12px;
            background-color: #dc3545;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
        }
        
        .reset-btn:hover {
            background-color: #c82333;
        }
        
        .clear-btn {
            width: 100%;
            padding: 12px;
            background-color: #ffc107;
            color: #000;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            margin-top: 10px;
        }
        
        .clear-btn:hover {
            background-color: #e0a800;
        }
        
        .main-content {
            flex: 1;
            padding: 30px;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        
        .continuous-text-container {
            flex: 1;
            overflow-y: auto;
            background-color: #111;
            border-radius: 10px;
            padding: 30px;
            border: 2px solid #333;
            display: flex;
            align-items: flex-start;
        }
        
        .continuous-text {
            font-size: 20px;
            line-height: 1.6;
            color: #fff;
            word-wrap: break-word;
            white-space: pre-wrap;
            width: 100%;
            min-height: 100%;
            font-family: var(--message-font-family, "Hiragino Kaku Gothic ProN", "Hiragino Sans", "Yu Gothic Medium", "Meiryo", "MS Gothic", sans-serif);
        }
        
        .continuous-text.waiting {
            color: #666;
            font-style: italic;
            text-align: center;
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 200px;
        }
        
        .footer {
            background-color: #1a1a1a;
            padding: 10px 30px;
            border-top: 2px solid #333;
            text-align: center;
            font-size: 12px;
            color: #666;
            flex-shrink: 0;
        }
        
        /* スクロールバーのスタイル */
        .continuous-text-container::-webkit-scrollbar {
            width: 8px;
        }
        
        .continuous-text-container::-webkit-scrollbar-track {
            background: #2a2a2a;
            border-radius: 4px;
        }
        
        .continuous-text-container::-webkit-scrollbar-thumb {
            background: #555;
            border-radius: 4px;
        }
        
        .continuous-text-container::-webkit-scrollbar-thumb:hover {
            background: #777;
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="title">リアルタイム文字起こし</div>
        <div class="status-bar">
            <div class="connection-status">
                <div id="statusIndicator" class="status-indicator"></div>
                <span id="connectionText">接続中...</span>
            </div>
            <div class="font-controls">
                <button id="settingsBtn" class="settings-btn">⚙️ フォント設定</button>
            </div>
            <div class="current-time" id="currentTime"></div>
        </div>
    </div>
    
    <!-- フォント設定パネル -->
    <div id="fontSettingsPanel" class="font-settings-panel" style="display: none;">
        <div class="settings-header">
            <h3>フォント設定</h3>
            <button id="closeSettingsBtn" class="close-btn">✕</button>
        </div>
        <div class="settings-content">
            <div class="setting-group">
                <label for="fontFamily">フォント</label>
                <select id="fontFamily">
                    <option value="Hiragino Kaku Gothic ProN, Hiragino Sans, Yu Gothic Medium, Meiryo, MS Gothic, sans-serif">ヒラギノ角ゴ（標準）</option>
                    <option value="Yu Gothic Medium, YuGothic, Hiragino Kaku Gothic ProN, Meiryo, sans-serif">游ゴシック</option>
                    <option value="MS Gothic, Osaka-mono, monospace">MS ゴシック</option>
                    <option value="Meiryo, Hiragino Kaku Gothic ProN, sans-serif">メイリオ</option>
                    <option value="Arial, sans-serif">Arial</option>
                    <option value="Times New Roman, serif">Times New Roman</option>
                    <option value="Courier New, monospace">Courier New</option>
                </select>
            </div>
            
            <div class="setting-group">
                <label for="fontSize">文字サイズ</label>
                <div class="size-controls">
                    <input type="range" id="fontSize" min="12" max="60" value="20" step="2">
                    <span id="fontSizeValue">20px</span>
                </div>
            </div>
            
            <div class="setting-group">
                <label for="lineHeight">行間</label>
                <div class="size-controls">
                    <input type="range" id="lineHeight" min="1.0" max="2.5" value="1.6" step="0.1">
                    <span id="lineHeightValue">1.6</span>
                </div>
            </div>
            
            <div class="setting-group">
                <label for="textColor">文字色</label>
                <div class="color-controls">
                    <input type="color" id="textColor" value="#ffffff">
                    <button class="preset-color" data-color="#ffffff">白</button>
                    <button class="preset-color" data-color="#000000">黒</button>
                    <button class="preset-color" data-color="#007bff">青</button>
                    <button class="preset-color" data-color="#28a745">緑</button>
                </div>
            </div>
            
            <div class="setting-group">
                <label for="backgroundColor">背景色</label>
                <div class="color-controls">
                    <input type="color" id="backgroundColor" value="#000000">
                    <button class="preset-color" data-bg="#000000">黒</button>
                    <button class="preset-color" data-bg="#ffffff">白</button>
                    <button class="preset-color" data-bg="#1a1a1a">グレー</button>
                    <button class="preset-color" data-bg="#0d1117">濃い青</button>
                </div>
            </div>
            
            <div class="setting-group">
                <button id="resetSettings" class="reset-btn">デフォルトに戻す</button>
            </div>
            
            <div class="setting-group">
                <button id="clearText" class="clear-btn">テキストをクリア</button>
            </div>
        </div>
    </div>
    
    <div class="main-content">
        <div class="continuous-text-container" id="continuousTextContainer">
            <div class="continuous-text" id="continuousText">
                メッセージの受信を待っています...
            </div>
        </div>
    </div>
    
    <div class="footer">
        プロジェクター表示用画面 - オペレーター画面: <span id="operatorUrl"></span>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();
        const statusIndicator = document.getElementById('statusIndicator');
        const connectionText = document.getElementById('connectionText');
        const continuousTextContainer = document.getElementById('continuousTextContainer');
        const continuousText = document.getElementById('continuousText');
        const currentTime = document.getElementById('currentTime');
        const operatorUrl = document.getElementById('operatorUrl');
        
        // 連続テキストを管理
        let fullText = '';
        let hasMessages = false;
        
        // フォント設定関連
        const settingsBtn = document.getElementById('settingsBtn');
        const fontSettingsPanel = document.getElementById('fontSettingsPanel');
        const closeSettingsBtn = document.getElementById('closeSettingsBtn');
        const fontFamily = document.getElementById('fontFamily');
        const fontSize = document.getElementById('fontSize');
        const fontSizeValue = document.getElementById('fontSizeValue');
        const lineHeight = document.getElementById('lineHeight');
        const lineHeightValue = document.getElementById('lineHeightValue');
        const textColor = document.getElementById('textColor');
        const backgroundColor = document.getElementById('backgroundColor');
        const resetSettings = document.getElementById('resetSettings');
        const clearText = document.getElementById('clearText');
        
        // フォント設定のデフォルト値
        const defaultSettings = {
            fontFamily: 'Hiragino Kaku Gothic ProN, Hiragino Sans, Yu Gothic Medium, Meiryo, MS Gothic, sans-serif',
            fontSize: 20,
            lineHeight: 1.6,
            textColor: '#ffffff',
            backgroundColor: '#000000'
        };
        
        // ローカルストレージから設定を読み込み
        function loadFontSettings() {
            const saved = localStorage.getItem('displayFontSettings');
            if (saved) {
                return { ...defaultSettings, ...JSON.parse(saved) };
            }
            return defaultSettings;
        }
        
        // 設定をローカルストレージに保存
        function saveFontSettings() {
            const settings = {
                fontFamily: fontFamily.value,
                fontSize: parseInt(fontSize.value),
                lineHeight: parseFloat(lineHeight.value),
                textColor: textColor.value,
                backgroundColor: backgroundColor.value
            };
            localStorage.setItem('displayFontSettings', JSON.stringify(settings));
            return settings;
        }
        
        // フォント設定を適用
        function applyFontSettings(settings) {
            // 背景色
            document.body.style.backgroundColor = settings.backgroundColor;
            
            // 連続テキストのスタイル
            continuousText.style.fontFamily = settings.fontFamily;
            continuousText.style.fontSize = settings.fontSize + 'px';
            continuousText.style.lineHeight = settings.lineHeight;
            continuousText.style.color = settings.textColor;
            
            // CSS変数を設定
            document.documentElement.style.setProperty('--message-font-family', settings.fontFamily);
            document.documentElement.style.setProperty('--message-font-size', settings.fontSize + 'px');
            document.documentElement.style.setProperty('--message-line-height', settings.lineHeight);
            document.documentElement.style.setProperty('--message-text-color', settings.textColor);
        }
        
        // 設定パネルの値を更新
        function updateSettingsPanel(settings) {
            fontFamily.value = settings.fontFamily;
            fontSize.value = settings.fontSize;
            fontSizeValue.textContent = settings.fontSize + 'px';
            lineHeight.value = settings.lineHeight;
            lineHeightValue.textContent = settings.lineHeight;
            textColor.value = settings.textColor;
            backgroundColor.value = settings.backgroundColor;
        }
        
        // 初期設定の適用
        const currentSettings = loadFontSettings();
        applyFontSettings(currentSettings);
        updateSettingsPanel(currentSettings);
        
        // 現在時刻の表示更新
        function updateCurrentTime() {
            const now = new Date();
            currentTime.textContent = now.toLocaleTimeString('ja-JP');
        }
        
        // 1秒ごとに時刻を更新
        updateCurrentTime();
        setInterval(updateCurrentTime, 1000);
        
        // オペレーター画面のURLを表示
        operatorUrl.textContent = window.location.origin + '/';
        
        // Socket.io接続イベント
        socket.on('connect', () => {
            statusIndicator.className = 'status-indicator connected';
            connectionText.textContent = '接続済み';
            console.log('表示画面がサーバーに接続されました:', socket.id);
        });
        
        socket.on('disconnect', () => {
            statusIndicator.className = 'status-indicator';
            connectionText.textContent = '切断';
            console.log('表示画面がサーバーから切断されました');
        });
        
        socket.on('connect_error', (error) => {
            statusIndicator.className = 'status-indicator';
            connectionText.textContent = '接続エラー';
            console.error('接続エラー:', error);
        });
        
        // メッセージ受信
        socket.on('text_received', (message) => {
            addToContinuousText(message.text);
        });
        
        // 連続テキストに追加
        function addToContinuousText(text) {
            // 初回メッセージの場合、待機メッセージを削除
            if (!hasMessages) {
                hasMessages = true;
                fullText = '';
                continuousText.className = 'continuous-text';
            }
            
            // ●を改行に変換
            const processedText = text.replace(/●/g, '\n');
            
            // テキストを連結（スペースで区切り）
            if (fullText.trim() === '') {
                fullText = processedText;
            } else {
                // 前のテキストが改行で終わっていない場合はスペースを追加
                if (!fullText.endsWith('\n') && !processedText.startsWith('\n')) {
                    fullText += ' ';
                }
                fullText += processedText;
            }
            
            // 表示を更新
            continuousText.textContent = fullText;
            
            // 現在の設定を適用
            const settings = loadFontSettings();
            applyFontSettings(settings);
            
            // 最下部までスクロール
            continuousTextContainer.scrollTop = continuousTextContainer.scrollHeight;
        }
        
        // フォント設定イベントリスナー
        settingsBtn.addEventListener('click', () => {
            fontSettingsPanel.style.display = 'flex';
        });
        
        closeSettingsBtn.addEventListener('click', () => {
            fontSettingsPanel.style.display = 'none';
        });
        
        // 設定パネルの外側をクリックで閉じる
        fontSettingsPanel.addEventListener('click', (e) => {
            if (e.target === fontSettingsPanel) {
                fontSettingsPanel.style.display = 'none';
            }
        });
        
        // フォント設定の変更イベント
        fontFamily.addEventListener('change', () => {
            const settings = saveFontSettings();
            applyFontSettings(settings);
        });
        
        fontSize.addEventListener('input', () => {
            fontSizeValue.textContent = fontSize.value + 'px';
            const settings = saveFontSettings();
            applyFontSettings(settings);
        });
        
        lineHeight.addEventListener('input', () => {
            lineHeightValue.textContent = lineHeight.value;
            const settings = saveFontSettings();
            applyFontSettings(settings);
        });
        
        textColor.addEventListener('change', () => {
            const settings = saveFontSettings();
            applyFontSettings(settings);
        });
        
        backgroundColor.addEventListener('change', () => {
            const settings = saveFontSettings();
            applyFontSettings(settings);
        });
        
        // プリセット色ボタン
        document.querySelectorAll('.preset-color').forEach(btn => {
            btn.addEventListener('click', () => {
                if (btn.hasAttribute('data-color')) {
                    textColor.value = btn.getAttribute('data-color');
                    const settings = saveFontSettings();
                    applyFontSettings(settings);
                }
                if (btn.hasAttribute('data-bg')) {
                    backgroundColor.value = btn.getAttribute('data-bg');
                    const settings = saveFontSettings();
                    applyFontSettings(settings);
                }
            });
        });
        
        // リセットボタン
        resetSettings.addEventListener('click', () => {
            if (confirm('フォント設定をデフォルトに戻しますか？')) {
                localStorage.removeItem('displayFontSettings');
                applyFontSettings(defaultSettings);
                updateSettingsPanel(defaultSettings);
            }
        });
        
        // テキストクリアボタン
        clearText.addEventListener('click', () => {
            if (confirm('表示されているテキストをすべてクリアしますか？')) {
                fullText = '';
                hasMessages = false;
                continuousText.textContent = 'メッセージの受信を待っています...';
                continuousText.className = 'continuous-text waiting';
            }
        });
        
        // キーボードショートカット
        document.addEventListener('keydown', (e) => {
            switch(e.key) {
                case 'F5':
                    // F5でページリフレッシュ（通常動作）
                    break;
                case 'F11':
                    // F11でフルスクリーン切り替え
                    if (document.fullscreenElement) {
                        document.exitFullscreen();
                    } else {
                        document.documentElement.requestFullscreen();
                    }
                    e.preventDefault();
                    break;
                case 'Escape':
                    // Escapeでフルスクリーン解除 or 設定パネルを閉じる
                    if (fontSettingsPanel.style.display === 'flex') {
                        fontSettingsPanel.style.display = 'none';
                    } else if (document.fullscreenElement) {
                        document.exitFullscreen();
                    }
                    break;
                case 's':
                case 'S':
                    // Sキーで設定パネル開閉
                    if (e.ctrlKey || e.metaKey) {
                        e.preventDefault();
                        return;
                    }
                    if (fontSettingsPanel.style.display === 'flex') {
                        fontSettingsPanel.style.display = 'none';
                    } else {
                        fontSettingsPanel.style.display = 'flex';
                    }
                    e.preventDefault();
                    break;
            }
        });
    </script>
</body>
</html>
