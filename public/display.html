<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>„É™„Ç¢„É´„Çø„Ç§„É†ÊñáÂ≠óËµ∑„Åì„Åó - Ë°®Á§∫ÁîªÈù¢</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: "Hiragino Kaku Gothic ProN", "Hiragino Sans", "Yu Gothic Medium", "Meiryo", "MS Gothic", sans-serif;
            background-color: #000;
            color: #fff;
            overflow: hidden;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }
        
        .header {
            background-color: #1a1a1a;
            padding: 15px 30px;
            border-bottom: 2px solid #333;
            flex-shrink: 0;
        }
        
        .title {
            font-size: 24px;
            font-weight: bold;
            text-align: center;
            color: #fff;
        }
        
        .status-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 10px;
            font-size: 14px;
            color: #ccc;
        }
        
        .connection-status {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background-color: #dc3545;
        }
        
        .status-indicator.connected {
            background-color: #28a745;
        }
        
        .current-time {
            font-family: monospace;
        }
        
        .font-controls {
            flex: 1;
            text-align: center;
        }
        
        .settings-btn {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.3s;
        }
        
        .settings-btn:hover {
            background-color: #0056b3;
        }
        
        .main-content {
            flex: 1;
            padding: 30px;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        
        .text-display-area {
            flex: 1;
            background-color: #111;
            border-radius: 10px;
            border: 2px solid #333;
            padding: 30px;
            overflow: hidden;
            position: relative;
            display: flex;
            flex-direction: column;
            justify-content: flex-end;
        }
        
        .text-lines {
            font-size: 20px;
            line-height: 1.6;
            color: #fff;
            word-wrap: break-word;
            white-space: pre-wrap;
            transition: transform 0.8s ease-out;
        }
        
        .text-line {
            margin: 0;
            padding: 0;
        }
        
        .waiting-message {
            color: #666;
            font-style: italic;
            text-align: center;
            padding: 50px 0;
        }
        
        .footer {
            background-color: #1a1a1a;
            padding: 10px 30px;
            border-top: 2px solid #333;
            text-align: center;
            font-size: 12px;
            color: #666;
            flex-shrink: 0;
        }
        
        /* „Éá„Éê„ÉÉ„Ç∞Áî® */
        .debug-info {
            position: fixed;
            top: 10px;
            right: 10px;
            background-color: rgba(255, 255, 255, 0.1);
            padding: 10px;
            border-radius: 4px;
            font-size: 12px;
            font-family: monospace;
            z-index: 1000;
        }
        
        /* Ë®≠ÂÆö„Éë„Éç„É´ */
        .settings-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 2000;
        }
        
        .settings-panel {
            background-color: #1a1a1a;
            border-radius: 10px;
            padding: 30px;
            width: 600px;
            max-width: 90vw;
            max-height: 90vh;
            overflow-y: auto;
            border: 2px solid #333;
        }
        
        .settings-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 1px solid #333;
        }
        
        .settings-title {
            font-size: 20px;
            font-weight: bold;
            color: #fff;
        }
        
        .close-btn {
            background: none;
            border: none;
            color: #fff;
            font-size: 24px;
            cursor: pointer;
            padding: 5px;
            border-radius: 3px;
            transition: background-color 0.3s;
        }
        
        .close-btn:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }
        
        .settings-tabs {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 1px solid #333;
        }
        
        .tab-btn {
            background: none;
            border: none;
            color: #ccc;
            padding: 10px 20px;
            cursor: pointer;
            font-size: 14px;
            border-bottom: 2px solid transparent;
            transition: all 0.3s;
        }
        
        .tab-btn.active {
            color: #fff;
            border-bottom-color: #007bff;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .setting-group {
            margin-bottom: 25px;
        }
        
        .setting-label {
            display: block;
            color: #fff;
            font-weight: bold;
            margin-bottom: 8px;
        }
        
        .setting-row {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 15px;
        }
        
        .setting-slider {
            flex: 1;
            -webkit-appearance: none;
            appearance: none;
            height: 6px;
            background: #333;
            border-radius: 3px;
            outline: none;
        }
        
        .setting-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            background: #007bff;
            border-radius: 50%;
            cursor: pointer;
        }
        
        .setting-slider::-moz-range-thumb {
            width: 20px;
            height: 20px;
            background: #007bff;
            border-radius: 50%;
            cursor: pointer;
            border: none;
        }
        
        .setting-input {
            width: 80px;
            padding: 8px;
            background-color: #333;
            border: 1px solid #555;
            border-radius: 4px;
            color: #fff;
            font-size: 14px;
        }
        
        .setting-input:focus {
            outline: none;
            border-color: #007bff;
        }
        
        .setting-unit {
            color: #ccc;
            font-size: 14px;
            width: 30px;
        }
        
        .setting-select {
            width: 200px;
            padding: 8px;
            background-color: #333;
            border: 1px solid #555;
            border-radius: 4px;
            color: #fff;
            font-size: 14px;
        }
        
        .setting-select:focus {
            outline: none;
            border-color: #007bff;
        }
        
        .color-input {
            width: 60px;
            height: 40px;
            padding: 0;
            border: 1px solid #555;
            border-radius: 4px;
            background: transparent;
            cursor: pointer;
        }
        
        .color-input::-webkit-color-swatch-wrapper {
            padding: 0;
        }
        
        .color-input::-webkit-color-swatch {
            border: none;
            border-radius: 3px;
        }
        
        .checkbox-wrapper {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .setting-checkbox {
            width: 20px;
            height: 20px;
            accent-color: #007bff;
        }
        
        .settings-actions {
            display: flex;
            gap: 15px;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid #333;
        }
        
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.3s;
        }
        
        .btn-primary {
            background-color: #007bff;
            color: white;
        }
        
        .btn-primary:hover {
            background-color: #0056b3;
        }
        
        .btn-secondary {
            background-color: #6c757d;
            color: white;
        }
        
        .btn-secondary:hover {
            background-color: #545b62;
        }
        
        .btn-danger {
            background-color: #dc3545;
            color: white;
        }
        
        .btn-danger:hover {
            background-color: #c82333;
        }
        
        .preview-info {
            background-color: #2a2a2a;
            padding: 15px;
            border-radius: 4px;
            margin-top: 15px;
            font-size: 14px;
            color: #ccc;
        }
        
        .file-input {
            display: none;
        }
        
        .file-label {
            display: inline-block;
            padding: 10px 20px;
            background-color: #28a745;
            color: white;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.3s;
        }
        
        .file-label:hover {
            background-color: #218838;
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="title">„É™„Ç¢„É´„Çø„Ç§„É†ÊñáÂ≠óËµ∑„Åì„Åó</div>
        <div class="status-bar">
            <div class="connection-status">
                <div id="statusIndicator" class="status-indicator"></div>
                <span id="connectionText">Êé•Á∂ö‰∏≠...</span>
            </div>
            <div class="font-controls">
                <button id="settingsBtn" class="settings-btn">‚öôÔ∏è Ë°®Á§∫Ë®≠ÂÆö</button>
            </div>
            <div class="current-time" id="currentTime"></div>
        </div>
    </div>
    
    <div class="main-content">
        <div class="text-display-area" id="textDisplayArea">
            <div class="waiting-message" id="waitingMessage">
                „É°„ÉÉ„Çª„Éº„Ç∏„ÅÆÂèó‰ø°„ÇíÂæÖ„Å£„Å¶„ÅÑ„Åæ„Åô...
            </div>
            <div class="text-lines" id="textLines" style="display: none;"></div>
        </div>
    </div>
    
    <div class="footer">
        „Éó„É≠„Ç∏„Çß„ÇØ„Çø„ÉºË°®Á§∫Áî®ÁîªÈù¢ - „Ç™„Éö„É¨„Éº„Çø„ÉºÁîªÈù¢: <span id="operatorUrl"></span>
    </div>

    <!-- „Éá„Éê„ÉÉ„Ç∞ÊÉÖÂ†± -->
    <div class="debug-info" id="debugInfo">
        Ë°å„Éá„Éº„Çø: 0Ë°å<br>
        Ë°®Á§∫Ë°åÊï∞: 10Ë°åÂõ∫ÂÆö<br>
        „Çπ„ÇØ„É≠„Éº„É´: „Å™„Åó<br>
        „Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥: ÂÅúÊ≠¢
    </div>

    <!-- Ë®≠ÂÆö„Éë„Éç„É´ -->
    <div class="settings-modal" id="settingsModal">
        <div class="settings-panel">
            <div class="settings-header">
                <h2 class="settings-title">Ë°®Á§∫Ë®≠ÂÆö</h2>
                <button class="close-btn" id="closeBtn">√ó</button>
            </div>
            
            <div class="settings-tabs">
                <button class="tab-btn active" data-tab="display">Ë°®Á§∫Ë®≠ÂÆö</button>
                <button class="tab-btn" data-tab="scroll">„Çπ„ÇØ„É≠„Éº„É´Ë®≠ÂÆö</button>
                <button class="tab-btn" data-tab="config">Ë®≠ÂÆöÁÆ°ÁêÜ</button>
            </div>
            
            <!-- Ë°®Á§∫Ë®≠ÂÆö„Çø„Éñ -->
            <div class="tab-content active" id="displayTab">
                <div class="setting-group">
                    <label class="setting-label">„Éï„Ç©„É≥„Éà„Çµ„Ç§„Ç∫</label>
                    <div class="setting-row">
                        <input type="range" class="setting-slider" id="fontSizeSlider" min="12" max="48" value="20">
                        <input type="number" class="setting-input" id="fontSizeInput" min="12" max="48" value="20">
                        <span class="setting-unit">px</span>
                    </div>
                </div>
                
                <div class="setting-group">
                    <label class="setting-label">Ë°åÈñìÈöî</label>
                    <div class="setting-row">
                        <input type="range" class="setting-slider" id="lineHeightSlider" min="1.0" max="2.5" step="0.1" value="1.6">
                        <input type="number" class="setting-input" id="lineHeightInput" min="1.0" max="2.5" step="0.1" value="1.6">
                        <span class="setting-unit">ÂÄç</span>
                    </div>
                </div>
                
                <div class="setting-group">
                    <label class="setting-label">„Éï„Ç©„É≥„Éà„Éï„Çß„Ç§„Çπ</label>
                    <div class="setting-row">
                        <select class="setting-select" id="fontFamilySelect">
                            <option value="system">„Ç∑„Çπ„ÉÜ„É†„Éï„Ç©„É≥„Éà</option>
                            <option value="hiragino">„Éí„É©„ÇÆ„ÉéËßí„Ç¥</option>
                            <option value="yugothic">Yu Gothic</option>
                            <option value="meiryo">„É°„Ç§„É™„Ç™</option>
                            <option value="msgothic">MS Gothic</option>
                            <option value="noto">Noto Sans JP</option>
                            <option value="roboto">Roboto</option>
                            <option value="arial">Arial</option>
                            <option value="helvetica">Helvetica</option>
                            <option value="times">Times New Roman</option>
                            <option value="georgia">Georgia</option>
                            <option value="courier">Courier New</option>
                        </select>
                    </div>
                </div>
                
                <div class="setting-group">
                    <label class="setting-label">„Éï„Ç©„É≥„Éà„Çπ„Çø„Ç§„É´</label>
                    <div class="setting-row">
                        <div class="checkbox-wrapper">
                            <input type="checkbox" class="setting-checkbox" id="fontBoldCheck">
                            <label for="fontBoldCheck">„Éú„Éº„É´„ÉâÔºàÂ§™Â≠óÔºâ</label>
                        </div>
                    </div>
                </div>
                
                <div class="setting-group">
                    <label class="setting-label">„Éï„Ç©„É≥„ÉàËâ≤</label>
                    <div class="setting-row">
                        <input type="color" class="color-input" id="fontColorPicker" value="#ffffff">
                        <input type="text" class="setting-input" id="fontColorInput" value="#ffffff" style="width: 100px;">
                    </div>
                </div>
                
                <div class="setting-group">
                    <label class="setting-label">ËÉåÊôØËâ≤</label>
                    <div class="setting-row">
                        <input type="color" class="color-input" id="bgColorPicker" value="#000000">
                        <input type="text" class="setting-input" id="bgColorInput" value="#000000" style="width: 100px;">
                    </div>
                </div>
            </div>
            
            <!-- „Çπ„ÇØ„É≠„Éº„É´Ë®≠ÂÆö„Çø„Éñ -->
            <div class="tab-content" id="scrollTab">
                <div class="setting-group">
                    <label class="setting-label">„Çπ„ÇØ„É≠„Éº„É´ÈÄüÂ∫¶</label>
                    <div class="setting-row">
                        <input type="range" class="setting-slider" id="scrollSpeedSlider" min="0.2" max="1.5" step="0.1" value="0.8">
                        <input type="number" class="setting-input" id="scrollSpeedInput" min="0.2" max="1.5" step="0.1" value="0.8">
                        <span class="setting-unit">Áßí</span>
                    </div>
                </div>
                
                <div class="setting-group">
                    <label class="setting-label">ÊúÄÂ§ßË°®Á§∫Ë°åÊï∞</label>
                    <div class="setting-row">
                        <input type="range" class="setting-slider" id="maxLinesSlider" min="1" max="20" value="10">
                        <input type="number" class="setting-input" id="maxLinesInput" min="1" max="99" value="10">
                        <span class="setting-unit">Ë°å</span>
                    </div>
                </div>
                
                <div class="setting-group">
                    <label class="setting-label">1Ë°åÊñáÂ≠óÊï∞</label>
                    <div class="setting-row">
                        <input type="range" class="setting-slider" id="charsPerLineSlider" min="10" max="80" value="30">
                        <input type="number" class="setting-input" id="charsPerLineInput" min="1" max="99" value="30">
                        <span class="setting-unit">ÊñáÂ≠ó</span>
                    </div>
                </div>
                
                <div class="preview-info" id="previewInfo">
                    ÁèæÂú®„ÅÆË®≠ÂÆö„Åß„Éó„É¨„Éì„É•„ÉºË°®Á§∫„Åï„Çå„Å¶„ÅÑ„Åæ„Åô
                </div>
            </div>
            
            <!-- Ë®≠ÂÆöÁÆ°ÁêÜ„Çø„Éñ -->
            <div class="tab-content" id="configTab">
                <div class="setting-group">
                    <label class="setting-label">Ë®≠ÂÆö„Éï„Ç°„Ç§„É´</label>
                    <div class="setting-row">
                        <label for="configFile" class="file-label">üìÅ Ë®≠ÂÆö„ÇíË™≠„ÅøËæº„Åø</label>
                        <input type="file" class="file-input" id="configFile" accept=".json">
                    </div>
                </div>
                
                <div class="settings-actions">
                    <button class="btn btn-primary" id="saveConfigBtn">üíæ Ë®≠ÂÆö„Çí‰øùÂ≠ò</button>
                    <button class="btn btn-secondary" id="downloadConfigBtn">üì• Ë®≠ÂÆö„Çí„ÉÄ„Ç¶„É≥„É≠„Éº„Éâ</button>
                    <button class="btn btn-danger" id="resetConfigBtn">üîÑ Ë®≠ÂÆö„Çí„É™„Çª„ÉÉ„Éà</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        console.log('=== Ë®≠ÂÆö„Éë„Éç„É´Ê©üËÉΩ‰ªò„Åçdisplay.html ÈñãÂßã ===');
        
        // DOMË¶ÅÁ¥†„ÅÆÂèñÂæó
        const statusIndicator = document.getElementById('statusIndicator');
        const connectionText = document.getElementById('connectionText');
        const textDisplayArea = document.getElementById('textDisplayArea');
        const waitingMessage = document.getElementById('waitingMessage');
        const textLines = document.getElementById('textLines');
        const currentTime = document.getElementById('currentTime');
        const operatorUrl = document.getElementById('operatorUrl');
        const debugInfo = document.getElementById('debugInfo');
        
        // Ë®≠ÂÆö„Éë„Éç„É´Ë¶ÅÁ¥†
        const settingsBtn = document.getElementById('settingsBtn');
        const settingsModal = document.getElementById('settingsModal');
        const closeBtn = document.getElementById('closeBtn');
        
        // „ÉÜ„Ç≠„Çπ„ÉàÁÆ°ÁêÜ
        let textLineArray = [];
        let hasMessages = false;
        let isAnimating = false;
        
        // Ë®≠ÂÆö„Ç™„Éñ„Ç∏„Çß„ÇØ„Éà
        const settings = {
            fontSize: 20,
            lineHeight: 1.6,
            fontFamily: 'system',
            fontBold: false,
            fontColor: '#ffffff',
            backgroundColor: '#000000',
            maxCharsPerLine: 30,
            maxVisibleLines: 10,
            animationDuration: 0.8
        };
        
        // „Éá„Éï„Ç©„É´„ÉàË®≠ÂÆö
        const defaultSettings = { ...settings };
        
        // Ë®≠ÂÆö„ÅÆË™≠„ÅøËæº„Åø
        function loadSettings() {
            try {
                const saved = localStorage.getItem('displaySettings');
                if (saved) {
                    const parsed = JSON.parse(saved);
                    Object.assign(settings, parsed);
                    console.log('Ë®≠ÂÆö„ÇíË™≠„ÅøËæº„Åø„Åæ„Åó„Åü:', settings);
                }
            } catch (error) {
                console.error('Ë®≠ÂÆö„ÅÆË™≠„ÅøËæº„Åø„Å´Â§±Êïó:', error);
            }
        }
        
        // Ë®≠ÂÆö„ÅÆ‰øùÂ≠ò
        function saveSettings() {
            try {
                localStorage.setItem('displaySettings', JSON.stringify(settings));
                console.log('Ë®≠ÂÆö„Çí‰øùÂ≠ò„Åó„Åæ„Åó„Åü:', settings);
            } catch (error) {
                console.error('Ë®≠ÂÆö„ÅÆ‰øùÂ≠ò„Å´Â§±Êïó:', error);
            }
        }
        
        // Ë®≠ÂÆö„ÇíUI„Å´ÂèçÊò†
        function updateSettingsUI() {
            // „Éï„Ç©„É≥„ÉàË®≠ÂÆö
            document.getElementById('fontSizeSlider').value = settings.fontSize;
            document.getElementById('fontSizeInput').value = settings.fontSize;
            document.getElementById('lineHeightSlider').value = settings.lineHeight;
            document.getElementById('lineHeightInput').value = settings.lineHeight;
            document.getElementById('fontFamilySelect').value = settings.fontFamily;
            document.getElementById('fontBoldCheck').checked = settings.fontBold;
            document.getElementById('fontColorPicker').value = settings.fontColor;
            document.getElementById('fontColorInput').value = settings.fontColor;
            document.getElementById('bgColorPicker').value = settings.backgroundColor;
            document.getElementById('bgColorInput').value = settings.backgroundColor;
            
            // „Çπ„ÇØ„É≠„Éº„É´Ë®≠ÂÆö
            document.getElementById('scrollSpeedSlider').value = settings.animationDuration;
            document.getElementById('scrollSpeedInput').value = settings.animationDuration;
            document.getElementById('maxLinesSlider').value = settings.maxVisibleLines;
            document.getElementById('maxLinesInput').value = settings.maxVisibleLines;
            document.getElementById('charsPerLineSlider').value = settings.maxCharsPerLine;
            document.getElementById('charsPerLineInput').value = settings.maxCharsPerLine;
        }
        
        // „Éï„Ç©„É≥„Éà„Éï„Ç°„Éü„É™„Éº„ÅÆ„Éû„ÉÉ„Éî„É≥„Ç∞
        const fontFamilyMap = {
            system: '"Hiragino Kaku Gothic ProN", "Hiragino Sans", "Yu Gothic Medium", "Meiryo", "MS Gothic", sans-serif',
            hiragino: '"Hiragino Kaku Gothic ProN", "Hiragino Sans", sans-serif',
            yugothic: '"Yu Gothic Medium", "Yu Gothic", "YuGothic", sans-serif',
            meiryo: '"Meiryo", "„É°„Ç§„É™„Ç™", sans-serif',
            msgothic: '"MS Gothic", "Ôº≠Ôº≥ „Ç¥„Ç∑„ÉÉ„ÇØ", monospace',
            noto: '"Noto Sans JP", sans-serif',
            roboto: '"Roboto", sans-serif',
            arial: '"Arial", sans-serif',
            helvetica: '"Helvetica Neue", "Helvetica", sans-serif',
            times: '"Times New Roman", "Times", serif',
            georgia: '"Georgia", serif',
            courier: '"Courier New", "Courier", monospace'
        };
        
        // Ë°®Á§∫„Çπ„Çø„Ç§„É´„ÇíÊõ¥Êñ∞
        function updateDisplayStyle() {
            // „Éï„Ç©„É≥„ÉàË®≠ÂÆö
            textLines.style.fontSize = settings.fontSize + 'px';
            textLines.style.lineHeight = settings.lineHeight;
            textLines.style.fontFamily = fontFamilyMap[settings.fontFamily] || fontFamilyMap.system;
            textLines.style.fontWeight = settings.fontBold ? 'bold' : 'normal';
            textLines.style.color = settings.fontColor;
            
            // ËÉåÊôØËâ≤
            document.body.style.backgroundColor = settings.backgroundColor;
            
            // Ë°®Á§∫„Ç®„É™„Ç¢„ÅÆÈ´ò„Åï„ÇíÂÜçË®àÁÆó
            const lineHeight = settings.fontSize * settings.lineHeight;
            textDisplayArea.style.height = `calc(${settings.maxVisibleLines} * ${lineHeight}px)`;
            
            // „Çπ„ÇØ„É≠„Éº„É´„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥„ÅÆÊôÇÈñì„ÇÇÊõ¥Êñ∞
            textLines.style.transition = `transform ${settings.animationDuration}s ease-out`;
            
            console.log('Ë°®Á§∫„Çπ„Çø„Ç§„É´„ÇíÊõ¥Êñ∞:', {
                fontSize: settings.fontSize,
                lineHeight: settings.lineHeight,
                fontFamily: settings.fontFamily,
                fontBold: settings.fontBold,
                fontColor: settings.fontColor,
                backgroundColor: settings.backgroundColor,
                maxVisibleLines: settings.maxVisibleLines,
                animationDuration: settings.animationDuration
            });
        }
        
        // Ë®≠ÂÆö„Éë„Éç„É´„ÅÆÂàùÊúüÂåñ
        function initSettingsPanel() {
            // „Çø„ÉñÂàá„ÇäÊõø„Åà
            const tabBtns = document.querySelectorAll('.tab-btn');
            const tabContents = document.querySelectorAll('.tab-content');
            
            tabBtns.forEach(btn => {
                btn.addEventListener('click', () => {
                    const targetTab = btn.getAttribute('data-tab');
                    
                    tabBtns.forEach(b => b.classList.remove('active'));
                    tabContents.forEach(c => c.classList.remove('active'));
                    
                    btn.classList.add('active');
                    document.getElementById(targetTab + 'Tab').classList.add('active');
                });
            });
            
            // Ë®≠ÂÆöÂÄ§„ÅÆÂêåÊúüÈñ¢Êï∞
            function syncSliderInput(sliderId, inputId, settingKey) {
                const slider = document.getElementById(sliderId);
                const input = document.getElementById(inputId);
                
                slider.addEventListener('input', () => {
                    const value = parseFloat(slider.value);
                    input.value = value;
                    settings[settingKey] = value;
                    updateDisplayStyle();
                    saveSettings();
                });
                
                input.addEventListener('change', () => {
                    const value = parseFloat(input.value);
                    if (!isNaN(value)) {
                        slider.value = value;
                        settings[settingKey] = value;
                        updateDisplayStyle();
                        saveSettings();
                    }
                });
            }
            
            // ÂêÑË®≠ÂÆö„ÅÆÂêåÊúü
            syncSliderInput('fontSizeSlider', 'fontSizeInput', 'fontSize');
            syncSliderInput('lineHeightSlider', 'lineHeightInput', 'lineHeight');
            syncSliderInput('scrollSpeedSlider', 'scrollSpeedInput', 'animationDuration');
            syncSliderInput('maxLinesSlider', 'maxLinesInput', 'maxVisibleLines');
            syncSliderInput('charsPerLineSlider', 'charsPerLineInput', 'maxCharsPerLine');
            
            // „Éï„Ç©„É≥„Éà„Éï„Çß„Ç§„ÇπÈÅ∏Êäû
            document.getElementById('fontFamilySelect').addEventListener('change', (e) => {
                settings.fontFamily = e.target.value;
                updateDisplayStyle();
                saveSettings();
            });
            
            // „Éú„Éº„É´„ÉâË®≠ÂÆö
            document.getElementById('fontBoldCheck').addEventListener('change', (e) => {
                settings.fontBold = e.target.checked;
                updateDisplayStyle();
                saveSettings();
            });
            
            // „Éï„Ç©„É≥„ÉàËâ≤Ë®≠ÂÆö
            function syncColorInputs(pickerId, inputId, settingKey) {
                const picker = document.getElementById(pickerId);
                const input = document.getElementById(inputId);
                
                picker.addEventListener('input', () => {
                    const color = picker.value;
                    input.value = color;
                    settings[settingKey] = color;
                    updateDisplayStyle();
                    saveSettings();
                });
                
                input.addEventListener('change', () => {
                    const color = input.value;
                    if (/^#[0-9A-F]{6}$/i.test(color)) {
                        picker.value = color;
                        settings[settingKey] = color;
                        updateDisplayStyle();
                        saveSettings();
                    }
                });
            }
            
            syncColorInputs('fontColorPicker', 'fontColorInput', 'fontColor');
            syncColorInputs('bgColorPicker', 'bgColorInput', 'backgroundColor');
            
            // Ë®≠ÂÆö„Éï„Ç°„Ç§„É´„ÅÆË™≠„ÅøËæº„Åø
            document.getElementById('configFile').addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        try {
                            const config = JSON.parse(e.target.result);
                            Object.assign(settings, config);
                            updateSettingsUI();
                            updateDisplayStyle();
                            saveSettings();
                            alert('Ë®≠ÂÆö„ÇíË™≠„ÅøËæº„Åø„Åæ„Åó„Åü');
                        } catch (error) {
                            alert('Ë®≠ÂÆö„Éï„Ç°„Ç§„É´„ÅÆË™≠„ÅøËæº„Åø„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
                        }
                    };
                    reader.readAsText(file);
                }
            });
            
            // Ë®≠ÂÆö„ÅÆ‰øùÂ≠ò
            document.getElementById('saveConfigBtn').addEventListener('click', () => {
                saveSettings();
                alert('Ë®≠ÂÆö„Çí‰øùÂ≠ò„Åó„Åæ„Åó„Åü');
            });
            
            // Ë®≠ÂÆö„ÅÆ„ÉÄ„Ç¶„É≥„É≠„Éº„Éâ
            document.getElementById('downloadConfigBtn').addEventListener('click', () => {
                const config = JSON.stringify(settings, null, 2);
                const blob = new Blob([config], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'display_settings.json';
                a.click();
                URL.revokeObjectURL(url);
            });
            
            // Ë®≠ÂÆö„ÅÆ„É™„Çª„ÉÉ„Éà
            document.getElementById('resetConfigBtn').addEventListener('click', () => {
                if (confirm('Ë®≠ÂÆö„Çí„É™„Çª„ÉÉ„Éà„Åó„Åæ„Åô„ÅãÔºü')) {
                    Object.assign(settings, defaultSettings);
                    updateSettingsUI();
                    updateDisplayStyle();
                    saveSettings();
                    alert('Ë®≠ÂÆö„Çí„É™„Çª„ÉÉ„Éà„Åó„Åæ„Åó„Åü');
                }
            });
        }
        
        // „Éë„Éç„É´„ÅÆË°®Á§∫/ÈùûË°®Á§∫
        settingsBtn.addEventListener('click', () => {
            settingsModal.style.display = 'flex';
        });
        
        closeBtn.addEventListener('click', () => {
            settingsModal.style.display = 'none';
        });
        
        settingsModal.addEventListener('click', (e) => {
            if (e.target === settingsModal) {
                settingsModal.style.display = 'none';
            }
        });
        
        // ÁèæÂú®ÊôÇÂàª„ÅÆË°®Á§∫Êõ¥Êñ∞
        function updateCurrentTime() {
            const now = new Date();
            currentTime.textContent = now.toLocaleTimeString('ja-JP');
        }
        
        updateCurrentTime();
        setInterval(updateCurrentTime, 1000);
        
        // „Ç™„Éö„É¨„Éº„Çø„ÉºÁîªÈù¢„ÅÆURL„ÇíË°®Á§∫
        operatorUrl.textContent = window.location.origin + '/';
        
        // „Éá„Éê„ÉÉ„Ç∞ÊÉÖÂ†±Êõ¥Êñ∞
        function updateDebugInfo() {
            const totalLines = textLineArray.length;
            const visibleLines = Math.min(totalLines, settings.maxVisibleLines);
            const needsScroll = totalLines > settings.maxVisibleLines;
            const animStatus = isAnimating ? 'ÂÆüË°å‰∏≠' : 'ÂÅúÊ≠¢';
            
            debugInfo.innerHTML = `Ë°å„Éá„Éº„Çø: ${totalLines}Ë°å<br>Ë°®Á§∫Ë°åÊï∞: ${visibleLines}/${settings.maxVisibleLines}Ë°å<br>„Çπ„ÇØ„É≠„Éº„É´: ${needsScroll ? '„ÅÇ„Çä' : '„Å™„Åó'}<br>„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥: ${animStatus}`;
        }
        
        // ÂÖ®ËßíÊñáÂ≠óÂà§ÂÆö
        function isFullWidth(char) {
            const code = char.charCodeAt(0);
            return (code >= 0x3000 && code <= 0x9FAF) || 
                   (code >= 0xFF01 && code <= 0xFF5E) || 
                   (code >= 0xFF61 && code <= 0xFF9F);
        }
        
        // „ÉÜ„Ç≠„Çπ„Éà„ÇíË°å„Å´ÂàÜÂâ≤
        function splitTextIntoLines(text) {
            const lines = text.split('\n');
            const resultLines = [];
            
            for (const line of lines) {
                if (line.length === 0) {
                    resultLines.push('');
                    continue;
                }
                
                let currentLine = '';
                let currentWidth = 0;
                
                for (const char of line) {
                    const charWidth = isFullWidth(char) ? 2 : 1;
                    
                    if (currentWidth + charWidth > settings.maxCharsPerLine * 2) {
                        resultLines.push(currentLine);
                        currentLine = char;
                        currentWidth = charWidth;
                    } else {
                        currentLine += char;
                        currentWidth += charWidth;
                    }
                }
                
                if (currentLine.length > 0) {
                    resultLines.push(currentLine);
                }
            }
            
            return resultLines;
        }
        
        // Ë°®Á§∫„ÇíÊõ¥Êñ∞
        function updateDisplay() {
            if (textLineArray.length === 0) {
                waitingMessage.style.display = 'block';
                textLines.style.display = 'none';
                return;
            }
            
            waitingMessage.style.display = 'none';
            textLines.style.display = 'block';
            
            // ÊúÄÊñ∞„ÅÆÊåáÂÆöË°åÊï∞„ÇíÂèñÂæó
            const visibleLines = textLineArray.slice(-settings.maxVisibleLines);
            
            // HTML„ÇíÁîüÊàê
            const html = visibleLines.map(line => 
                `<div class="text-line">${line || '&nbsp;'}</div>`
            ).join('');
            
            textLines.innerHTML = html;
            
            console.log(`Ë°®Á§∫Êõ¥Êñ∞: ÂÖ®${textLineArray.length}Ë°å‰∏≠„ÄÅÊúÄÊñ∞${visibleLines.length}Ë°å„ÇíË°®Á§∫`);
        }
        
        // „Çπ„ÇØ„É≠„Éº„É´„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥ÂÆüË°å
        function performScrollAnimation() {
            if (isAnimating || textLineArray.length <= settings.maxVisibleLines) {
                updateDisplay();
                return;
            }
            
            console.log('„Çπ„ÇØ„É≠„Éº„É´„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥ÈñãÂßã');
            isAnimating = true;
            updateDebugInfo();
            
            // ÁèæÂú®„ÅÆË°å„ÅÆÈ´ò„Åï„ÇíÂãïÁöÑ„Å´Ë®àÁÆó
            const lineHeight = settings.fontSize * settings.lineHeight;
            console.log(`Ë®àÁÆó„Åï„Çå„ÅüË°å„ÅÆÈ´ò„Åï: ${lineHeight}px („Éï„Ç©„É≥„Éà„Çµ„Ç§„Ç∫: ${settings.fontSize}px √ó Ë°åÈñìÈöî: ${settings.lineHeight})`);
            
            // ÁèæÂú®Ë°®Á§∫„Åï„Çå„Å¶„ÅÑ„ÇãË°å„ÇíÂèñÂæó
            const currentVisibleLines = textLineArray.slice(-(settings.maxVisibleLines + 1), -1);
            
            // ÁèæÂú®„ÅÆË°å„ÇíË°®Á§∫
            textLines.innerHTML = currentVisibleLines.map(line => 
                `<div class="text-line">${line || '&nbsp;'}</div>`
            ).join('');
            
            // „Ç≥„É≥„ÉÜ„ÉäÂÖ®‰Ωì„Çí1Ë°åÂàÜ‰∏ä„Å´ÁßªÂãï
            setTimeout(() => {
                textLines.style.transition = `transform ${settings.animationDuration}s ease-out`;
                
                // ÂãïÁöÑ„Å´Ë®àÁÆó„Åï„Çå„ÅüË°å„ÅÆÈ´ò„Åï„Çí‰ΩøÁî®
                textLines.style.transform = `translateY(-${lineHeight}px)`;
                console.log(`„Çπ„ÇØ„É≠„Éº„É´ÂÆüË°å: translateY(-${lineHeight}px)`);
                
                // „Çπ„ÇØ„É≠„Éº„É´ÂÆå‰∫ÜÂæå„ÄÅÊ≠£Â∏∏Áä∂ÊÖã„Å´Âæ©ÂÖÉ
                setTimeout(() => {
                    textLines.style.transition = 'none';
                    textLines.style.transform = 'translateY(0)';
                    updateDisplay();
                    isAnimating = false;
                    updateDebugInfo();
                    console.log('„Çπ„ÇØ„É≠„Éº„É´„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥ÂÆå‰∫Ü');
                }, settings.animationDuration * 1000);
            }, 16);
        }
        
        // „ÉÜ„Ç≠„Çπ„ÉàËøΩÂä†
        function addText(text) {
            console.log('„ÉÜ„Ç≠„Çπ„ÉàËøΩÂä†:', text);
            
            // ‚óè„ÇíÊîπË°å„Å´Â§âÊèõ
            const processedText = text.replace(/‚óè/g, '\n');
            
            // Êó¢Â≠ò„ÉÜ„Ç≠„Çπ„Éà„Å®ÁµêÂêà
            let fullText = '';
            if (textLineArray.length > 0) {
                fullText = textLineArray.join('\n') + ' ' + processedText;
            } else {
                fullText = processedText;
            }
            
            // Ë°å„Å´ÂàÜÂâ≤
            const newLines = splitTextIntoLines(fullText);
            const previousLineCount = textLineArray.length;
            textLineArray = newLines;
            
            console.log(`Ë°åÊï∞Â§âÂåñ: ${previousLineCount} ‚Üí ${textLineArray.length}`);
            
            // ÂàùÂõû„É°„ÉÉ„Çª„Éº„Ç∏„ÅÆÂ†¥Âêà
            if (!hasMessages) {
                hasMessages = true;
                updateDisplay();
                updateDebugInfo();
                return;
            }
            
            // Ë°å„ÅåÂ¢ó„Åà„ÅüÂ†¥Âêà„ÅØ„Çπ„ÇØ„É≠„Éº„É´„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥
            if (textLineArray.length > previousLineCount) {
                performScrollAnimation();
            } else {
                updateDisplay();
            }
            
            updateDebugInfo();
        }
        
        // ÂàùÊúüÂåñ
        function initialize() {
            console.log('ÂàùÊúüÂåñÈñãÂßã');
            
            // Ë®≠ÂÆö„ÇíË™≠„ÅøËæº„Åø
            loadSettings();
            
            // Ë®≠ÂÆö„Éë„Éç„É´„ÇíÂàùÊúüÂåñ
            initSettingsPanel();
            
            // UI„Å´Ë®≠ÂÆö„ÇíÂèçÊò†
            updateSettingsUI();
            
            // Ë°®Á§∫„Çπ„Çø„Ç§„É´„ÇíÈÅ©Áî®
            updateDisplayStyle();
            
            console.log('ÂàùÊúüÂåñÂÆå‰∫Ü');
        }
        
        // Socket.io„É©„Ç§„Éñ„É©„É™„ÇíÂãïÁöÑ„Å´Ë™≠„ÅøËæº„Åø
        const script = document.createElement('script');
        script.src = '/socket.io/socket.io.js';
        script.onload = function() {
            console.log('Socket.IOË™≠„ÅøËæº„ÅøÂÆå‰∫Ü');
            startSocketConnection();
        };
        script.onerror = function() {
            console.error('Socket.IOË™≠„ÅøËæº„ÅøÂ§±Êïó');
            connectionText.textContent = '„É©„Ç§„Éñ„É©„É™Ë™≠„ÅøËæº„ÅøÂ§±Êïó';
        };
        document.head.appendChild(script);
        
        function startSocketConnection() {
            const isLocalDevelopment = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';
            const socketUrl = isLocalDevelopment ? 'http://localhost:3000' : '';
            
            const socket = io(socketUrl);
            
            socket.on('connect', () => {
                statusIndicator.className = 'status-indicator connected';
                connectionText.textContent = 'Êé•Á∂öÊ∏à„Åø';
                console.log('Êé•Á∂öÊàêÂäü:', socket.id);
            });
            
            socket.on('disconnect', () => {
                statusIndicator.className = 'status-indicator';
                connectionText.textContent = 'ÂàáÊñ≠';
            });
            
            socket.on('connect_error', (error) => {
                statusIndicator.className = 'status-indicator';
                connectionText.textContent = 'Êé•Á∂ö„Ç®„É©„Éº';
                console.error('Êé•Á∂ö„Ç®„É©„Éº:', error);
            });
            
            socket.on('text_received', (message) => {
                console.log('„É°„ÉÉ„Çª„Éº„Ç∏Âèó‰ø°:', message);
                addText(message.text);
            });
        }
        
        // „Ç¢„Éó„É™„Ç±„Éº„Ç∑„Éß„É≥ÈñãÂßã
        initialize();
        updateDebugInfo();
        
        console.log('JavaScriptÂàùÊúüÂåñÂÆå‰∫Ü');
    </script>
</body>
</html>
