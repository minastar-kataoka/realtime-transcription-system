<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>リアルタイム文字起こしシステム</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        
        .container {
            background-color: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 30px;
        }
        
        .status {
            background-color: #e8f5e8;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
            border-left: 4px solid #4CAF50;
        }
        
        .status.connecting {
            background-color: #fff3cd;
            border-left-color: #ffc107;
        }
        
        .status.error {
            background-color: #f8d7da;
            border-left-color: #dc3545;
        }
        
        .info-box {
            background-color: #d1ecf1;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
            border-left: 4px solid #17a2b8;
        }
        
        .test-section {
            margin-top: 30px;
            padding: 20px;
            background-color: #f8f9fa;
            border-radius: 5px;
        }
        
        .test-section h3 {
            color: #495057;
            margin-top: 0;
        }
        
        .test-list {
            margin-top: 15px;
        }
        
        .test-list li {
            margin-bottom: 8px;
            padding-left: 10px;
        }
        
        .login-section {
            background-color: #f8f9fa;
            padding: 20px;
            border-radius: 5px;
            margin-bottom: 20px;
        }
        
        .input-group {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        
        .input-group input {
            flex: 1;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 3px;
            font-size: 16px;
        }
        
        .input-group button {
            padding: 10px 20px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            font-size: 16px;
        }
        
        .input-group button:hover {
            background-color: #0056b3;
        }
        
        .input-group button:disabled {
            background-color: #6c757d;
            cursor: not-allowed;
        }
        
        .main-section {
            margin-top: 20px;
        }
        
        .sender-panel {
            background-color: #e3f2fd;
            padding: 20px;
            border-radius: 5px;
            margin-bottom: 20px;
            border-left: 4px solid #2196f3;
        }
        
        .sender-status {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-top: 15px;
        }
        
        .current-sender-info {
            font-size: 18px;
            font-weight: bold;
        }
        
        .next-sender-btn {
            padding: 10px 20px;
            background-color: #2196f3;
            color: white;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
        }
        
        .next-sender-btn:hover:not(:disabled) {
            background-color: #1976d2;
        }
        
        .next-sender-btn:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }
        
        .sender-message {
            margin-top: 15px;
            padding: 10px;
            border-radius: 3px;
            font-weight: bold;
        }
        
        .sender-message.has-permission {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .input-panel {
            background-color: #f8f9fa;
            padding: 20px;
            border-radius: 5px;
            margin-bottom: 20px;
            border-left: 4px solid #6c757d;
        }
        
        .input-panel.active {
            border-left-color: #28a745;
            background-color: #f8fff8;
        }
        
        .input-area {
            margin-top: 15px;
        }
        
        .input-area textarea {
            width: 100%;
            height: 100px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 3px;
            font-size: 16px;
            font-family: Arial, sans-serif;
            resize: vertical;
            box-sizing: border-box;
        }
        
        .input-area textarea:disabled {
            background-color: #f5f5f5;
            color: #6c757d;
        }
        
        .input-area textarea:focus {
            outline: none;
            border-color: #007bff;
        }
        
        .input-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 10px;
            gap: 15px;
        }
        
        .send-btn {
            padding: 10px 30px;
            background-color: #28a745;
            color: white;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            flex-shrink: 0;
        }
        
        .send-btn:hover:not(:disabled) {
            background-color: #218838;
        }
        
        .send-btn.has-permission {
            background-color: #28a745;
            box-shadow: 0 0 15px rgba(40, 167, 69, 0.4);
            font-size: 18px;
            padding: 12px 40px;
            font-weight: bold;
            animation: buttonPulse 2s ease-in-out infinite alternate;
        }
        
        @keyframes buttonPulse {
            from {
                box-shadow: 0 0 15px rgba(40, 167, 69, 0.4);
            }
            to {
                box-shadow: 0 0 25px rgba(40, 167, 69, 0.6);
            }
        }
        
        .send-btn.has-permission:hover {
            background-color: #218838;
            box-shadow: 0 0 30px rgba(40, 167, 69, 0.6);
        }
        
        .send-btn:disabled {
            background-color: #6c757d;
            cursor: not-allowed;
            box-shadow: none;
            animation: none;
        }
        
        .input-status {
            color: #6c757d;
            font-size: 14px;
            flex: 1;
        }
        
        .input-status.active {
            color: #28a745;
            font-weight: bold;
        }
        
        .three-tier-layout {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .tier-panel {
            border-radius: 8px;
            padding: 15px;
            border-left: 4px solid #6c757d;
            transition: all 0.3s ease;
        }
        
        /* 通常時（左側のみ枠線） */
        .tier-previous {
            background-color: #f0f8ff;
            border-left: 4px solid #17a2b8;  /* 水色・左のみ */
        }
        
        .tier-current {
            background-color: #f8fff8;
            border-left: 4px solid #28a745;  /* 緑色・左のみ */
        }
        
        .tier-next {
            background-color: #fff8dc;
            border-left: 4px solid #ffc107;  /* ベージュ・左のみ */
        }
        
        /* 送信権表示時（4方向全て枠線） */
        .tier-previous.has-sender-permission {
            border: 4px solid #17a2b8 !important;       /* 水色・4方向全て */
            border-left-width: 4px !important;          /* 左側も4px */
        }
        
        .tier-current.has-sender-permission {
            border: 4px solid #28a745 !important;       /* 緑色・4方向全て */
            border-left-width: 4px !important;          /* 左側も4px */
        }
        
        .tier-next.has-sender-permission {
            border: 4px solid #ffc107 !important;       /* ベージュ・4方向全て */
            border-left-width: 4px !important;          /* 左側も4px */
        }
        
        .tier-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 10px;
            font-size: 14px;
            font-weight: bold;
        }
        
        .tier-user-name {
            color: #007bff;
            font-size: 16px;
        }
        
        .char-counter {
            font-size: 12px;
            color: #6c757d;
            font-family: monospace;
            margin-left: 8px;
        }
        
        .tier-status {
            margin-left: auto;
            color: #28a745;
            font-size: 12px;
            font-weight: normal;
            margin-right: 10px;
        }
        
        .tier-status.waiting {
            color: #6c757d;
        }
        
        .tier-content {
            background-color: white;
            padding: 12px;
            border-radius: 4px;
            border: 1px solid #ddd;
            min-height: 50px;
            font-size: 16px;
            line-height: 1.4;
            color: #333;
        }
        
        .tier-content.empty {
            color: #999;
            font-style: italic;
        }
        
        .tier-input-area {
            position: relative;
        }
        
        .tier-input-area textarea {
            width: 100%;
            height: 80px;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 4px;
            font-size: 16px;
            font-family: Arial, sans-serif;
            resize: vertical;
            box-sizing: border-box;
            transition: border-color 0.3s ease;
        }
        
        .tier-input-area textarea:focus {
            outline: none;
            border-color: #28a745;
        }
        
        .tier-input-area textarea.has-permission {
            border-color: #28a745;
            border-width: 3px;
            box-shadow: 0 0 0 3px rgba(40, 167, 69, 0.1);
            background-color: #f8fff8;
        }
        
        .tier-input-area textarea.has-permission::placeholder {
            color: #28a745;
            opacity: 0.7;
        }
        
        .tier-input-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 8px;
            gap: 15px;
        }
        
        .messages-panel {
            background-color: #ffffff;
            padding: 20px;
            border-radius: 5px;
            margin-bottom: 20px;
            border: 1px solid #ddd;
            max-height: 300px;
            overflow-y: auto;
        }
        
        .messages-list {
            margin-top: 15px;
        }
        
        .message-item {
            padding: 10px;
            margin-bottom: 10px;
            background-color: #f8f9fa;
            border-radius: 3px;
            border-left: 4px solid #007bff;
        }
        
        .message-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
            font-size: 12px;
            color: #6c757d;
        }
        
        .message-sender {
            font-weight: bold;
            color: #007bff;
        }
        
        .message-text {
            font-size: 16px;
            line-height: 1.4;
        }
        
        .no-messages {
            color: #6c757d;
            text-align: center;
            font-style: italic;
        }
        
        .participants-panel {
            background-color: #f8f9fa;
            padding: 20px;
            border-radius: 5px;
            margin-bottom: 20px;
        }
        
        .participants-list {
            margin-top: 15px;
        }
        
        .participant-item {
            display: flex;
            align-items: center;
            padding: 10px;
            margin-bottom: 8px;
            background-color: white;
            border-radius: 3px;
            border-left: 4px solid #28a745;
            transition: all 0.3s ease;
        }
        
        .participant-item.has-sender-permission {
            border-left-color: #2196f3;
            background-color: #e3f2fd;
            box-shadow: 0 2px 4px rgba(33, 150, 243, 0.2);
        }
        
        .participant-name {
            font-weight: bold;
            margin-right: 10px;
        }
        
        .participant-status {
            color: #666;
            font-size: 0.9em;
        }
        
        .messages-controls {
            display: flex;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .export-btn {
            padding: 8px 16px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            transition: background-color 0.3s;
        }
        
        .export-btn:hover {
            background-color: #0056b3;
        }
        
        .export-btn:disabled {
            background-color: #6c757d;
            cursor: not-allowed;
        }
        
        .clear-log-btn {
            padding: 8px 16px;
            background-color: #dc3545;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            transition: background-color 0.3s;
        }
        
        .clear-log-btn:hover {
            background-color: #c82333;
        }
        
        .clear-log-btn:disabled {
            background-color: #6c757d;
            cursor: not-allowed;
        }
        
        .log-stats {
            font-size: 12px;
            color: #6c757d;
            margin-left: auto;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>リアルタイム文字起こしシステム</h1>
        
        <div id="status" class="status connecting">
            <strong>接続状況:</strong> <span id="statusText">サーバーに接続中...</span>
        </div>
                
        <!-- 参加前の画面 -->
        <div id="loginSection" class="login-section">
            <h3>参加者名を入力してください</h3>
            <div class="input-group">
                <input type="text" id="nameInput" placeholder="例: オペレーター1" maxlength="20">
                <button id="joinBtn">参加</button>
            </div>
        </div>
        
        <!-- 参加後の画面 -->
        <div id="mainSection" class="main-section" style="display: none;">
            <!-- 3段表示エリア -->
            <div class="three-tier-layout">
                <!-- 上段：前の人の入力状況 -->
                <div class="tier-panel tier-previous">
                    <div class="tier-header">
                        <span id="previousUserName" class="tier-user-name">前の人</span>
                    </div>
                    <div id="previousUserInput" class="tier-content">
                        待機中...
                    </div>
                </div>
                
                <!-- 中段：自分の入力エリア -->
                <div class="tier-panel tier-current">
                    <div class="tier-header">
                        <span id="currentUserName" class="tier-user-name">あなた</span>
                        <span id="charCounter" class="char-counter">0文字</span>
                        <span id="currentInputStatus" class="tier-status">入力可能・送信権待ち</span>
                    </div>
                    <div class="tier-input-area">
                        <textarea id="textInput" placeholder="ここに文字起こし内容を入力してください..."></textarea>
                        <div class="tier-input-controls">
                            <button id="sendBtn" class="send-btn" disabled>送信</button>
                            <span class="keyboard-hint">Ctrl+Enter または F12 でも送信</span>
                        </div>
                    </div>
                </div>
                
                <!-- 下段：次の人の入力状況 -->
                <div class="tier-panel tier-next">
                    <div class="tier-header">
                        <span id="nextUserName" class="tier-user-name">次の人</span>
                    </div>
                    <div id="nextUserInput" class="tier-content">
                        待機中...
                    </div>
                </div>
            </div>
            
            <div class="messages-panel">
                <h3>送信済みメッセージ</h3>
                <div class="messages-controls" style="margin-bottom: 15px;">
                    <button id="exportTextBtn" class="export-btn">テキストのみエクスポート</button>
                    <button id="exportTimecodeBtn" class="export-btn">タイムコード付きエクスポート</button>
                    <button id="clearLogBtn" class="clear-log-btn">ログクリア</button>
                    <span id="logStats" class="log-stats">ログ: 0件</span>
                </div>
                <div id="messagesList" class="messages-list">
                    <p class="no-messages">まだメッセージがありません</p>
                </div>
            </div>
            
            <div class="participants-panel">
                <h3>参加者一覧 (<span id="participantCount">0</span>名)</h3>
                <div id="participantsList" class="participants-list">
                    <!-- 参加者一覧がここに表示される -->
                </div>
            </div>
        </div>
        
        <div class="info-box">
            <h3>LAN内アクセス方法</h3>
            <p>他のデバイスからアクセスする場合は、サーバーコンソールに表示されているLAN内URLを使用してください。</p>
            <div class="connection-info">
                参加後に実際のURLが表示されます
            </div>
            
            <!-- QRコード表示エリアを追加 -->
            <div class="qr-section" style="margin-top: 20px; border-top: 1px solid #ddd; padding-top: 15px;">
                <h4 style="color: #495057; margin-bottom: 10px; font-size: 14px;">表示用画面 QRコード</h4>
                <div id="qrcode" style="text-align: center; margin: 10px 0;"></div>
                <p style="font-size: 12px; color: #666; text-align: center;">
                    スマートフォンやタブレットで読み取って表示用画面にアクセス
                </p>
            </div>
        </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();
        const statusDiv = document.getElementById('status');
        const statusText = document.getElementById('statusText');
        
        const loginSection = document.getElementById('loginSection');
        const mainSection = document.getElementById('mainSection');
        const nameInput = document.getElementById('nameInput');
        const joinBtn = document.getElementById('joinBtn');
        const participantsList = document.getElementById('participantsList');
        const participantCount = document.getElementById('participantCount');
        
        const textInput = document.getElementById('textInput');
        const sendBtn = document.getElementById('sendBtn');
        const messagesList = document.getElementById('messagesList');
        
        // ログエクスポート用の要素
        const exportTextBtn = document.getElementById('exportTextBtn');
        const exportTimecodeBtn = document.getElementById('exportTimecodeBtn');
        const clearLogBtn = document.getElementById('clearLogBtn');
        const logStats = document.getElementById('logStats');
        
        // 3段表示用の要素
        const previousUserName = document.getElementById('previousUserName');
        const previousUserInput = document.getElementById('previousUserInput');
        const currentUserName = document.getElementById('currentUserName');
        const currentInputStatus = document.getElementById('currentInputStatus');
        const nextUserName = document.getElementById('nextUserName');
        const nextUserInput = document.getElementById('nextUserInput');
        const tierCurrent = document.querySelector('.tier-current');
        const charCounter = document.getElementById('charCounter');
        
        let isJoined = false;
        let myParticipant = null;
        let currentSender = null;
        let typingUsers = new Map(); // ユーザーの入力状況を管理
        let typingTimeout = null;
        let allParticipants = []; // 全参加者を保持
        let messageCount = 0; // ログ件数をトラッキング
        
        // Socket.io接続イベント
        socket.on('connect', () => {
            statusDiv.className = 'status';
            statusText.textContent = 'サーバーに接続されました';
            
            console.log('Socket.io接続成功:', socket.id);
        });
        
        socket.on('disconnect', () => {
            statusDiv.className = 'status error';
            statusText.textContent = 'サーバーとの接続が切断されました';
            
            console.log('Socket.io接続切断');
        });
        
        socket.on('connect_error', (error) => {
            statusDiv.className = 'status error';
            statusText.textContent = 'サーバーに接続できませんでした';
            
            console.error('Socket.io接続エラー:', error);
        });
        
        // 参加関連のイベント
        socket.on('joined', (data) => {
            if (data.success) {
                isJoined = true;
                myParticipant = data.participant;
                loginSection.style.display = 'none';
                mainSection.style.display = 'block';
                
                // 自分の名前を表示
                currentUserName.textContent = data.participant.name;
                
                // 実際のURLを表示とQRコード生成 ← 新規追加
                if (data.serverInfo) {
                    updateConnectionInfo(data.serverInfo);
                    generateDisplayQR(data.serverInfo.displayUrl);
                }
                
                console.log('参加完了:', data.participant);
            }
        });
        
        socket.on('participants_updated', (data) => {
            allParticipants = data.participants;
            updateParticipantsList(data.participants, data.currentSender);
            updateSenderInfo(data.currentSender);
            updateInputState(data.currentSender);
            updateThreeTierDisplay(data.participants, data.currentSender);
            
            if (data.participants.length >= 1 && data.currentSender) {
            }
        });
        
        socket.on('sender_updated', (data) => {
            updateSenderInfo(data.currentSender);
            updateInputState(data.currentSender);
            updateParticipantsList(null, data.currentSender); // 参加者一覧は更新せず送信権表示のみ更新
            updateThreeTierDisplay(allParticipants, data.currentSender);
        });
        
        // メッセージ受信
        socket.on('text_received', (message) => {
            addMessageToList(message);
            messageCount++;
            updateLogStats();
        });
        
        // リアルタイム入力受信
        socket.on('user_typing', (data) => {
            updateTypingUser(data);
            updateThreeTierTyping(data);
        });
        
        // 入力クリア受信
        socket.on('user_clear_typing', (data) => {
            typingUsers.delete(data.userId);
            clearThreeTierTyping(data.userId);
        });
        
        // 文字数をカウント（全角相当）
        function countCharacters(text) {
            let count = 0;
            for (let i = 0; i < text.length; i++) {
                const char = text[i];
                // 全角文字（ひらがな、カタカナ、漢字、全角記号など）は1文字
                // 半角文字（英数字、半角記号など）は0.5文字としてカウント
                if (char.match(/[^\x00-\x7F]/)) {
                    count += 1; // 全角文字
                } else {
                    count += 0.5; // 半角文字
                }
            }
            return count; // 小数点以下も保持
        }
        
        // カーソル位置の行の文字数を取得
        function getCurrentLineCharCount() {
            const textarea = textInput;
            const text = textarea.value;
            const cursorPos = textarea.selectionStart;
            
            // カーソル位置より前の最後の改行を見つける
            const beforeCursor = text.substring(0, cursorPos);
            const lastNewline = beforeCursor.lastIndexOf('\n');
            
            // カーソル位置より後の最初の改行を見つける
            const afterCursor = text.substring(cursorPos);
            const nextNewline = afterCursor.indexOf('\n');
            
            // 現在の行のテキストを取得
            const lineStart = lastNewline + 1;
            const lineEnd = nextNewline === -1 ? text.length : cursorPos + nextNewline;
            const currentLine = text.substring(lineStart, lineEnd);
            
            return countCharacters(currentLine);
        }
        
        // 文字数表示を更新
        function updateCharCounter() {
            const charCount = getCurrentLineCharCount();
            // 整数の場合は「6文字」、小数の場合は「6.5文字」と表示
            const displayCount = charCount % 1 === 0 ? charCount.toString() : charCount.toString();
            charCounter.textContent = `${displayCount}文字`;
        }
        
        // 接続情報を更新する関数
        function updateConnectionInfo(serverInfo) {
            const connectionInfo = document.querySelector('.connection-info');
            if (connectionInfo) {
                connectionInfo.innerHTML = `
                    <strong>オペレーター画面:</strong> ${serverInfo.operatorUrl}<br>
                    <strong>表示用画面:</strong> ${serverInfo.displayUrl}
                `;
            }
        }
        
        // QRコード生成関数（修正版）
        function generateDisplayQR(displayUrl) {
            const qrCodeElement = document.getElementById('qrcode');
            if (qrCodeElement) {
                // シンプルなURL生成
                const qrImageUrl = `https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=${encodeURIComponent(displayUrl)}`;
                
                qrCodeElement.innerHTML = `
                    <img src="${qrImageUrl}" 
                         alt="QRコード" 
                         style="border: 1px solid #ddd; border-radius: 4px;"
                         onload="console.log('QR画像読み込み成功')"
                         onerror="console.log('QR画像読み込み失敗'); this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTUwIiBoZWlnaHQ9IjE1MCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMTUwIiBoZWlnaHQ9IjE1MCIgZmlsbD0iI2Y5ZjlmOSIvPjx0ZXh0IHg9Ijc1IiB5PSI3NSIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZmlsbD0iIzk5OSI+UVLjgrPjg7zjg4njgZfjga7jgozjgb7jgZvjgpM8L3RleHQ+PC9zdmc+';">
                `;
                
                console.log('QRコード生成完了:', displayUrl);
                console.log('QRコードURL:', qrImageUrl);
            }
        }
        
        // 送信権情報を更新
        function updateSenderInfo(sender) {
            currentSender = sender;
            console.log('送信権情報更新:', sender);
        }
        
        // 参加者一覧を更新
        function updateParticipantsList(participants, sender) {
            // participantsがnullの場合は、送信権表示のみ更新
            if (participants !== null) {
                participantCount.textContent = participants.length;
                
                if (participants.length === 0) {
                    participantsList.innerHTML = '<p style="color: #666;">参加者がいません</p>';
                    return;
                }
                
                participantsList.innerHTML = participants.map(participant => {
                    const hasSenderPermission = sender && sender.id === participant.id;
                    const itemClass = hasSenderPermission ? 'participant-item has-sender-permission' : 'participant-item';
                    const senderBadge = hasSenderPermission ? '<span class="sender-badge">送信権</span>' : '';
                    
                    return `
                        <div class="${itemClass}">
                            <span class="participant-name">${participant.name}</span>
                            <span class="participant-status">接続中</span>
                            ${senderBadge}
                        </div>
                    `;
                }).join('');
            } else {
                // 送信権表示のみ更新（参加者一覧は変更しない）
                const participantItems = document.querySelectorAll('.participant-item');
                participantItems.forEach(item => {
                    const nameElement = item.querySelector('.participant-name');
                    const hasSenderPermission = sender && nameElement.textContent === sender.name;
                    
                    if (hasSenderPermission) {
                        item.className = 'participant-item has-sender-permission';
                        if (!item.querySelector('.sender-badge')) {
                            item.innerHTML += '<span class="sender-badge">送信権</span>';
                        }
                    } else {
                        item.className = 'participant-item';
                        const existingBadge = item.querySelector('.sender-badge');
                        if (existingBadge) {
                            existingBadge.remove();
                        }
                    }
                });
            }
        }
        
        // 入力状態を更新
        function updateInputState(sender) {
            console.log('入力状態更新:', sender);
            console.log('自分:', myParticipant);
            
            const hasSenderPermission = myParticipant && sender && sender.id === myParticipant.id;
            console.log('送信権チェック結果:', hasSenderPermission);
            
            if (hasSenderPermission) {
                console.log('送信権あり - UI更新');
                textInput.disabled = false;
                sendBtn.disabled = false;
                currentInputStatus.textContent = '送信可能';
                currentInputStatus.className = 'tier-status';
                textInput.className = 'has-permission';
                sendBtn.className = 'send-btn has-permission';
            } else {
                console.log('送信権なし - UI更新');
                textInput.disabled = false; // 送信権がなくても入力は可能
                sendBtn.disabled = true;
                currentInputStatus.textContent = '送信権待ち';
                currentInputStatus.className = 'tier-status waiting';
                textInput.className = '';
                sendBtn.className = 'send-btn';
            }
        }
        
        // メッセージをリストに追加
        function addMessageToList(message) {
            // 「まだメッセージがありません」を削除
            const noMessages = messagesList.querySelector('.no-messages');
            if (noMessages) {
                noMessages.remove();
            }
            
            const messageElement = document.createElement('div');
            messageElement.className = 'message-item';
            messageElement.innerHTML = `
                <div class="message-header">
                    <span class="message-sender">${message.sender}</span>
                    <span class="message-time">${new Date(message.timestamp).toLocaleTimeString()}</span>
                </div>
                <div class="message-text">${message.text}</div>
            `;
            
            messagesList.appendChild(messageElement);
            
            // 最新メッセージまでスクロール
            messagesList.scrollTop = messagesList.scrollHeight;
        }
        
        // 送信ボタンのイベント
        sendBtn.addEventListener('click', () => {
            const text = textInput.value.trim();
            
            if (!text) {
                // テキストが空の場合は、送信権のみ次に移す（メッセージ送信なし）
                socket.emit('next_sender');
            } else {
                // テキストがある場合は、通常の送信処理
                socket.emit('send_text', { text: text });
            }
            
            // 送信時に入力クリアを通知
            socket.emit('clear_typing');
            
            textInput.value = ''; // 送信後にクリア
            updateCharCounter(); // 文字数カウンターをリセット
        });
        
        // Enterキー（Ctrl+Enter）で送信
        textInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && e.ctrlKey) {
                e.preventDefault();
                if (!sendBtn.disabled) {
                    sendBtn.click();
                }
            }
        });
        
        // 文字数カウンターの更新
        textInput.addEventListener('input', updateCharCounter);
        textInput.addEventListener('keyup', updateCharCounter);
        textInput.addEventListener('click', updateCharCounter);
        
        // リアルタイム入力を更新
        function updateTypingUser(data) {
            if (data.text.trim() === '') {
                // 空の場合は削除
                typingUsers.delete(data.userId);
            } else {
                // テキストがある場合は更新
                typingUsers.set(data.userId, {
                    userName: data.userName,
                    text: data.text,
                    timestamp: data.timestamp
                });
            }
            
            // 従来のリアルタイム表示も更新（デバッグ用に残す）
        }
        
        // 自分の入力をリアルタイム送信（最速設定）
        textInput.addEventListener('input', () => {
            if (typingTimeout) {
                clearTimeout(typingTimeout);
            }
            
            // 20ms遅延（高速レスポンス）
            typingTimeout = setTimeout(() => {
                if (isJoined) {
                    socket.emit('typing', { text: textInput.value });
                }
            }, 20);
        });
        
        // 3段表示を更新
　　　　function updateThreeTierDisplay(participants, currentSender) {
　　　　    console.log('3段表示更新 - 参加者数:', participants.length);
   　　　　 console.log('自分の情報:', myParticipant);
    　　　　console.log('送信権者:', currentSender);
   　　　　 
    　　　　if (!myParticipant || participants.length === 0) {
        　　　　previousUserName.textContent = '前の人';
　　　　        previousUserInput.textContent = '待機中...';
　　　　        previousUserInput.className = 'tier-content empty';
　　　　        document.querySelector('.tier-previous').className = 'tier-panel tier-previous';
　　　　        
　　　　        currentUserName.textContent = 'あなた';
　　　　        
　　　　        nextUserName.textContent = '次の人';
　　　　        nextUserInput.textContent = '待機中...';
　　　　        nextUserInput.className = 'tier-content empty';
　　　　        document.querySelector('.tier-next').className = 'tier-panel tier-next';
　　　　        return;
　　　　    }
　　　　    
　　　　    // 現在のユーザーの位置を特定
　　　　    const myIndex = participants.findIndex(p => p.id === myParticipant.id);
　　　　    console.log('自分のインデックス:', myIndex);
　　　　    
　　　　    if (myIndex === -1) return;
　　　　    
　　　　    // 前の人を取得（循環）
　　　　    const previousIndex = (myIndex - 1 + participants.length) % participants.length;
　　　　    const previousUser = participants[previousIndex];
　　　　    
　　　　    // 次の人を取得（循環）
　　　　    const nextIndex = (myIndex + 1) % participants.length;
　　　　    const nextUser = participants[nextIndex];
　　　　    
　　　　    console.log('前の人:', previousUser.name, '次の人:', nextUser.name);
　　　　    
　　　　    // 1人の場合の特別処理
　　　　    if (participants.length === 1) {
　　　　        previousUserName.textContent = 'あなた（前の順番）';
　　　　        previousUserInput.textContent = '1人モードです';
　　　　        previousUserInput.className = 'tier-content empty';
　　　　        document.querySelector('.tier-previous').className = 'tier-panel tier-previous';
　　　　        
　　　　        nextUserName.textContent = 'あなた（次の順番）';
　　　　        nextUserInput.textContent = '1人モードです';
　　　　        nextUserInput.className = 'tier-content empty';
　　　　        document.querySelector('.tier-next').className = 'tier-panel tier-next';
　　　　    } else {
　　　　        // 前の人
　　　　        previousUserName.textContent = previousUser.name;
　　　　        const previousTyping = typingUsers.get(previousUser.id);
　　　　        if (previousTyping && previousTyping.text.trim()) {
　　　　            previousUserInput.textContent = previousTyping.text;
　　　　            previousUserInput.className = 'tier-content';
　　　　        } else {
　　　　            previousUserInput.textContent = '待機中...';
　　　　            previousUserInput.className = 'tier-content empty';
　　　　        }
　　　　        
　　　　        // 前の人が送信権を持っているかチェック
　　　　        const previousHasSender = currentSender && currentSender.id === previousUser.id;
　　　　        document.querySelector('.tier-previous').className = previousHasSender 
　　　　            ? 'tier-panel tier-previous has-sender-permission' 
　　　　            : 'tier-panel tier-previous';
　　　　        
　　　　        // 次の人
　　　　        nextUserName.textContent = nextUser.name;
　　　　        const nextTyping = typingUsers.get(nextUser.id);
　　　　        if (nextTyping && nextTyping.text.trim()) {
　　　　            nextUserInput.textContent = nextTyping.text;
　　　　            nextUserInput.className = 'tier-content';
　　　　        } else {
　　　　            nextUserInput.textContent = '待機中...';
　　　　            nextUserInput.className = 'tier-content empty';
　　　　        }
　　　　        
　　　　        // 次の人が送信権を持っているかチェック
　　　　        const nextHasSender = currentSender && currentSender.id === nextUser.id;
　　　　        document.querySelector('.tier-next').className = nextHasSender 
　　　　            ? 'tier-panel tier-next has-sender-permission' 
　　　　            : 'tier-panel tier-next';
　　　　    }
　　　　    
　　　　    // 自分の名前を更新
　　　　    currentUserName.textContent = myParticipant.name;
　　　　    
　　　　    // 自分が送信権を持っているかチェック（中段用）
　　　　    const iHaveSender = currentSender && currentSender.id === myParticipant.id;
　　　　    tierCurrent.className = iHaveSender 
　　　　        ? 'tier-panel tier-current has-sender-permission' 
　　　　        : 'tier-panel tier-current';
　　　　}
        
        // 3段表示のリアルタイム入力を更新
        function updateThreeTierTyping(data) {
            console.log('3段表示更新:', data);
            
            if (!myParticipant || allParticipants.length === 0) {
                console.log('参加者情報がない');
                return;
            }
            
            const myIndex = allParticipants.findIndex(p => p.id === myParticipant.id);
            if (myIndex === -1) {
                console.log('自分が参加者リストにいない');
                return;
            }
            
            const previousIndex = (myIndex - 1 + allParticipants.length) % allParticipants.length;
            const nextIndex = (myIndex + 1) % allParticipants.length;
            
            const previousUser = allParticipants[previousIndex];
            const nextUser = allParticipants[nextIndex];
            
            console.log('前の人:', previousUser.name, 'ID:', previousUser.id);
            console.log('次の人:', nextUser.name, 'ID:', nextUser.id);
            console.log('入力者ID:', data.userId);
            
            // 前の人の入力更新
            if (data.userId === previousUser.id) {
                console.log('前の人の入力更新:', data.text);
                if (data.text.trim()) {
                    previousUserInput.textContent = data.text;
                    previousUserInput.className = 'tier-content';
                } else {
                    previousUserInput.textContent = '待機中...';
                    previousUserInput.className = 'tier-content empty';
                }
            }
            
            // 次の人の入力更新
            if (data.userId === nextUser.id) {
                console.log('次の人の入力更新:', data.text);
                if (data.text.trim()) {
                    nextUserInput.textContent = data.text;
                    nextUserInput.className = 'tier-content';
                } else {
                    nextUserInput.textContent = '待機中...';
                    nextUserInput.className = 'tier-content empty';
                }
            }
        }
        
        // 3段表示の入力クリア
        function clearThreeTierTyping(userId) {
            if (!myParticipant || allParticipants.length === 0) return;
            
            const myIndex = allParticipants.findIndex(p => p.id === myParticipant.id);
            if (myIndex === -1) return;
            
            const previousIndex = (myIndex - 1 + allParticipants.length) % allParticipants.length;
            const nextIndex = (myIndex + 1) % allParticipants.length;
            
            const previousUser = allParticipants[previousIndex];
            const nextUser = allParticipants[nextIndex];
            
            // 前の人の入力クリア
            if (userId === previousUser.id) {
                previousUserInput.textContent = '待機中...';
                previousUserInput.className = 'tier-content empty';
            }
            
            // 次の人の入力クリア
            if (userId === nextUser.id) {
                nextUserInput.textContent = '待機中...';
                nextUserInput.className = 'tier-content empty';
            }
        }
        
        // F12キーで送信（グローバル）
        document.addEventListener('keydown', (e) => {
            if (e.key === 'F12') {
                e.preventDefault();
                if (!sendBtn.disabled) {
                    sendBtn.click();
                } else {
                    console.log('送信権がないため送信できません');
                }
            }
        });
        
        // ログ統計情報を更新
        async function updateLogStats() {
            try {
                // サーバーからログ統計を取得
                const response = await fetch('/api/log-stats');
                if (response.ok) {
                    const stats = await response.json();
                    messageCount = stats.totalMessages;
                    console.log('サーバーログ統計:', stats);
                } else {
                    console.log('ログ統計取得失敗、ローカルカウントを使用');
                }
            } catch (error) {
                console.log('ログ統計取得エラー、ローカルカウントを使用:', error);
            }
            
            logStats.textContent = `ログ: ${messageCount}件`;
            
            // ボタンの有効/無効を切り替え
            const hasMessages = messageCount > 0;
            exportTextBtn.disabled = !hasMessages;
            exportTimecodeBtn.disabled = !hasMessages;
            clearLogBtn.disabled = !hasMessages;
            
            console.log(`ログ件数更新: ${messageCount}件, ボタン有効: ${hasMessages}`);
        }
        
        // CSVファイルをダウンロード
        async function downloadCSV(type) {
            console.log(`ダウンロード開始: ${type}, メッセージ数: ${messageCount}`);
            
            if (messageCount === 0) {
                alert('エクスポートするデータがありません');
                return;
            }
            
            try {
                const url = `/api/export/${type}`;
                console.log(`リクエストURL: ${url}`);
                
                const response = await fetch(url);
                console.log('レスポンス受信:', response.status, response.statusText);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const blob = await response.blob();
                console.log('Blob作成:', blob.size, blob.type);
                
                // ファイル名を生成
                const timestamp = new Date().toISOString().slice(0, 19).replace(/[:-]/g, '');
                const filename = type === 'text-only' 
                    ? `transcription_text_${timestamp}.csv`
                    : `transcription_timecode_${timestamp}.csv`;
                
                // ダウンロード実行
                const downloadUrl = window.URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = downloadUrl;
                link.download = filename;
                link.style.display = 'none';
                
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                // URLを解放
                window.URL.revokeObjectURL(downloadUrl);
                
                console.log(`ダウンロード完了: ${filename}`);
                
            } catch (error) {
                console.error('ダウンロードエラー:', error);
                alert(`エクスポートに失敗しました: ${error.message}`);
            }
        }
        
        // ログクリア
        async function clearLog() {
            if (messageCount === 0) {
                alert('クリアするログがありません');
                return;
            }
            
            if (!confirm('すべてのログデータを削除しますか？この操作は元に戻せません。')) {
                return;
            }
            
            try {
                const response = await fetch('/api/clear-log', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                if (response.ok) {
                    // 画面上のメッセージリストもクリア
                    messagesList.innerHTML = '<p class="no-messages">まだメッセージがありません</p>';
                    messageCount = 0;
                    updateLogStats();
                    alert('ログをクリアしました');
                    console.log('ログクリア完了');
                } else {
                    throw new Error('ログクリアに失敗しました');
                }
            } catch (error) {
                console.error('ログクリアエラー:', error);
                alert('ログクリアに失敗しました');
            }
        }
        joinBtn.addEventListener('click', () => {
            const name = nameInput.value.trim();
            
            if (!name) {
                alert('参加者名を入力してください');
                return;
            }
            
            if (name.length > 20) {
                alert('参加者名は20文字以内で入力してください');
                return;
            }
            
            joinBtn.disabled = true;
            joinBtn.textContent = '参加中...';
            
            socket.emit('join', { name: name });
        });
        
        // Enterキーでも参加できるようにする
        nameInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                joinBtn.click();
            }
        });
        // ログエクスポートボタンのイベントリスナー設定
        exportTextBtn.addEventListener('click', async () => {
            console.log('テキストのみエクスポートボタンがクリックされました');
            await downloadCSV('text-only');
        });

        exportTimecodeBtn.addEventListener('click', async () => {
            console.log('タイムコード付きエクスポートボタンがクリックされました');
            await downloadCSV('with-timecode');
        });

        clearLogBtn.addEventListener('click', async () => {
            console.log('ログクリアボタンがクリックされました');
            await clearLog();
        });

        // 初期化時にログ統計を更新
        updateLogStats();
    </script>
</body>
</html>
