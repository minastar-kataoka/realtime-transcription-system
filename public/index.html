<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ–‡å­—èµ·ã“ã—ã‚·ã‚¹ãƒ†ãƒ </title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        
        .container {
            background-color: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 30px;
        }
        
        .status {
            background-color: #e8f5e8;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
            border-left: 4px solid #4CAF50;
        }
        
        .status.connecting {
            background-color: #fff3cd;
            border-left-color: #ffc107;
        }
        
        .status.error {
            background-color: #f8d7da;
            border-left-color: #dc3545;
        }
        
        .info-box {
            background-color: #d1ecf1;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
            border-left: 4px solid #17a2b8;
        }
        
        .test-section {
            margin-top: 30px;
            padding: 20px;
            background-color: #f8f9fa;
            border-radius: 5px;
        }
        
        .test-section h3 {
            color: #495057;
            margin-top: 0;
        }
        
        .test-list {
            margin-top: 15px;
        }
        
        .test-list li {
            margin-bottom: 8px;
            padding-left: 10px;
        }
        
        .login-section {
            background-color: #f8f9fa;
            padding: 20px;
            border-radius: 5px;
            margin-bottom: 20px;
        }
        
        .input-group {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        
        .input-group input {
            flex: 1;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 3px;
            font-size: 16px;
        }
        
        .input-group button {
            padding: 10px 20px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            font-size: 16px;
        }
        
        .input-group button:hover {
            background-color: #0056b3;
        }
        
        .input-group button:disabled {
            background-color: #6c757d;
            cursor: not-allowed;
        }
        
        .main-section {
            margin-top: 20px;
        }
        
        .sender-panel {
            background-color: #e3f2fd;
            padding: 20px;
            border-radius: 5px;
            margin-bottom: 20px;
            border-left: 4px solid #2196f3;
        }
        
        .sender-status {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-top: 15px;
        }
        
        .current-sender-info {
            font-size: 18px;
            font-weight: bold;
        }
        
        .next-sender-btn {
            padding: 10px 20px;
            background-color: #2196f3;
            color: white;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
        }
        
        .next-sender-btn:hover:not(:disabled) {
            background-color: #1976d2;
        }
        
        .next-sender-btn:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }
        
        .sender-message {
            margin-top: 15px;
            padding: 10px;
            border-radius: 3px;
            font-weight: bold;
        }
        
        .sender-message.has-permission {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .input-panel {
            background-color: #f8f9fa;
            padding: 20px;
            border-radius: 5px;
            margin-bottom: 20px;
            border-left: 4px solid #6c757d;
        }
        
        .input-panel.active {
            border-left-color: #28a745;
            background-color: #f8fff8;
        }
        
        .input-area {
            margin-top: 15px;
        }
        
        .input-area textarea {
            width: 100%;
            height: 100px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 3px;
            font-size: 16px;
            font-family: Arial, sans-serif;
            resize: vertical;
            box-sizing: border-box;
        }
        
        .input-area textarea:disabled {
            background-color: #f5f5f5;
            color: #6c757d;
        }
        
        .input-area textarea:focus {
            outline: none;
            border-color: #007bff;
        }
        
        .input-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 10px;
            gap: 15px;
        }
        
        .send-btn {
            padding: 10px 30px;
            background-color: #28a745;
            color: white;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            flex-shrink: 0;
        }
        
        .send-btn:hover:not(:disabled) {
            background-color: #218838;
        }
        
        .send-btn.has-permission {
            background-color: #28a745;
            box-shadow: 0 0 15px rgba(40, 167, 69, 0.4);
            font-size: 18px;
            padding: 12px 40px;
            font-weight: bold;
            animation: buttonPulse 2s ease-in-out infinite alternate;
        }
        
        @keyframes buttonPulse {
            from {
                box-shadow: 0 0 15px rgba(40, 167, 69, 0.4);
            }
            to {
                box-shadow: 0 0 25px rgba(40, 167, 69, 0.6);
            }
        }
        
        .send-btn.has-permission:hover {
            background-color: #218838;
            box-shadow: 0 0 30px rgba(40, 167, 69, 0.6);
        }
        
        .send-btn:disabled {
            background-color: #6c757d;
            cursor: not-allowed;
            box-shadow: none;
            animation: none;
        }
        
        .input-status {
            color: #6c757d;
            font-size: 14px;
            flex: 1;
        }
        
        .input-status.active {
            color: #28a745;
            font-weight: bold;
        }
        
        .three-tier-layout {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .tier-panel {
            border-radius: 8px;
            padding: 15px;
            border-left: 4px solid #6c757d;
            transition: all 0.3s ease;
        }
        
        /* é€šå¸¸æ™‚ï¼ˆå·¦å´ã®ã¿æ ç·šï¼‰ */
        .tier-previous {
            background-color: #f0f8ff;
            border-left: 4px solid #17a2b8;  /* æ°´è‰²ãƒ»å·¦ã®ã¿ */
        }
        
        .tier-current {
            background-color: #f8fff8;
            border-left: 4px solid #28a745;  /* ç·‘è‰²ãƒ»å·¦ã®ã¿ */
        }
        
        .tier-next {
            background-color: #fff8dc;
            border-left: 4px solid #ffc107;  /* ãƒ™ãƒ¼ã‚¸ãƒ¥ãƒ»å·¦ã®ã¿ */
        }
        
        /* é€ä¿¡æ¨©è¡¨ç¤ºæ™‚ï¼ˆ4æ–¹å‘å…¨ã¦æ ç·šï¼‰ */
        .tier-previous.has-sender-permission {
            border: 4px solid #17a2b8 !important;       /* æ°´è‰²ãƒ»4æ–¹å‘å…¨ã¦ */
            border-left-width: 4px !important;          /* å·¦å´ã‚‚4px */
        }
        
        .tier-current.has-sender-permission {
            border: 4px solid #28a745 !important;       /* ç·‘è‰²ãƒ»4æ–¹å‘å…¨ã¦ */
            border-left-width: 4px !important;          /* å·¦å´ã‚‚4px */
        }
        
        .tier-next.has-sender-permission {
            border: 4px solid #ffc107 !important;       /* ãƒ™ãƒ¼ã‚¸ãƒ¥ãƒ»4æ–¹å‘å…¨ã¦ */
            border-left-width: 4px !important;          /* å·¦å´ã‚‚4px */
        }
        
        .tier-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 10px;
            font-size: 14px;
            font-weight: bold;
        }
        
        .tier-user-name {
            color: #007bff;
            font-size: 16px;
        }
        
        .char-counter {
            font-size: 12px;
            color: #6c757d;
            font-family: monospace;
            margin-left: 8px;
        }
        
        .tier-status {
            margin-left: auto;
            color: #28a745;
            font-size: 12px;
            font-weight: normal;
            margin-right: 10px;
        }
        
        .tier-status.waiting {
            color: #6c757d;
        }
        
        .tier-content {
            background-color: white;
            padding: 12px;
            border-radius: 4px;
            border: 1px solid #ddd;
            min-height: 50px;
            font-size: 16px;
            line-height: 1.4;
            color: #333;
        }
        
        .tier-content.empty {
            color: #999;
            font-style: italic;
        }
        
        .tier-input-area {
            position: relative;
        }
        
        .tier-input-area textarea {
            width: 100%;
            height: 80px;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 4px;
            font-size: 16px;
            font-family: Arial, sans-serif;
            resize: vertical;
            box-sizing: border-box;
            transition: border-color 0.3s ease;
        }
        
        .tier-input-area textarea:focus {
            outline: none;
            border-color: #28a745;
        }
        
        .tier-input-area textarea.has-permission {
            border-color: #28a745;
            border-width: 3px;
            box-shadow: 0 0 0 3px rgba(40, 167, 69, 0.1);
            background-color: #f8fff8;
        }
        
        .tier-input-area textarea.has-permission::placeholder {
            color: #28a745;
            opacity: 0.7;
        }
        
        .tier-input-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 8px;
            gap: 15px;
        }
        
        /* ãƒ­ã‚°è¡¨ç¤ºãƒ‘ãƒãƒ«ï¼ˆæ—§ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒ‘ãƒãƒ«éƒ¨åˆ†ï¼‰ */
        .log-panel {
            background-color: #ffffff;
            padding: 20px;
            border-radius: 5px;
            margin-bottom: 20px;
            border: 1px solid #ddd;
        }
        
        .log-controls {
            display: flex;
            align-items: center;
            gap: 15px;
            flex-wrap: wrap;
        }
        
        .log-show-btn {
            padding: 12px 24px;
            background-color: #17a2b8;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            transition: background-color 0.3s;
        }
        
        .log-show-btn:hover {
            background-color: #138496;
        }
        
        .export-btn {
            padding: 8px 16px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            transition: background-color 0.3s;
        }
        
        .export-btn:hover {
            background-color: #0056b3;
        }
        
        .export-btn:disabled {
            background-color: #6c757d;
            cursor: not-allowed;
        }
        
        .clear-log-btn {
            padding: 8px 16px;
            background-color: #dc3545;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            transition: background-color 0.3s;
        }
        
        .clear-log-btn:hover {
            background-color: #c82333;
        }
        
        .clear-log-btn:disabled {
            background-color: #6c757d;
            cursor: not-allowed;
        }
        
        .log-stats {
            font-size: 12px;
            color: #6c757d;
            margin-left: auto;
        }
        
        .participants-panel {
            background-color: #f8f9fa;
            padding: 20px;
            border-radius: 5px;
            margin-bottom: 20px;
        }
        
        .participants-list {
            margin-top: 15px;
        }
        
        .participant-item {
            display: flex;
            align-items: center;
            padding: 10px;
            margin-bottom: 8px;
            background-color: white;
            border-radius: 3px;
            border-left: 4px solid #28a745;
            transition: all 0.3s ease;
        }
        
        .participant-item.has-sender-permission {
            border-left-color: #2196f3;
            background-color: #e3f2fd;
            box-shadow: 0 2px 4px rgba(33, 150, 243, 0.2);
        }
        
        .participant-name {
            font-weight: bold;
            margin-right: 10px;
        }
        
        .participant-status {
            color: #666;
            font-size: 0.9em;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ–‡å­—èµ·ã“ã—ã‚·ã‚¹ãƒ†ãƒ </h1>
        
        <div id="status" class="status connecting">
            <strong>æ¥ç¶šçŠ¶æ³:</strong> <span id="statusText">ã‚µãƒ¼ãƒãƒ¼ã«æ¥ç¶šä¸­...</span>
        </div>
                
        <!-- å‚åŠ å‰ã®ç”»é¢ -->
        <div id="loginSection" class="login-section">
            <h3>å‚åŠ è€…åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„</h3>
            <div class="input-group">
                <input type="text" id="nameInput" placeholder="ä¾‹: ã‚ªãƒšãƒ¬ãƒ¼ã‚¿ãƒ¼1" maxlength="20">
                <button id="joinBtn">å‚åŠ </button>
            </div>
        </div>
        
        <!-- å‚åŠ å¾Œã®ç”»é¢ -->
        <div id="mainSection" class="main-section" style="display: none;">
            <!-- 3æ®µè¡¨ç¤ºã‚¨ãƒªã‚¢ -->
            <div class="three-tier-layout">
                <!-- ä¸Šæ®µï¼šå‰ã®äººã®å…¥åŠ›çŠ¶æ³ -->
                <div class="tier-panel tier-previous">
                    <div class="tier-header">
                        <span id="previousUserName" class="tier-user-name">å‰ã®äºº</span>
                    </div>
                    <div id="previousUserInput" class="tier-content">
                        å¾…æ©Ÿä¸­...
                    </div>
                </div>
                
                <!-- ä¸­æ®µï¼šè‡ªåˆ†ã®å…¥åŠ›ã‚¨ãƒªã‚¢ -->
                <div class="tier-panel tier-current">
                    <div class="tier-header">
                        <span id="currentUserName" class="tier-user-name">ã‚ãªãŸ</span>
                        <span id="charCounter" class="char-counter">0æ–‡å­—</span>
                        <span id="currentInputStatus" class="tier-status">å…¥åŠ›å¯èƒ½ãƒ»é€ä¿¡æ¨©å¾…ã¡</span>
                    </div>
                    <div class="tier-input-area">
                        <textarea id="textInput" placeholder="ã“ã“ã«æ–‡å­—èµ·ã“ã—å†…å®¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„..."></textarea>
                        <div class="tier-input-controls">
                            <button id="sendBtn" class="send-btn" disabled>é€ä¿¡</button>
                            <span class="keyboard-hint">Ctrl+Enter ã¾ãŸã¯ F12 ã§ã‚‚é€ä¿¡</span>
                        </div>
                    </div>
                </div>
                
                <!-- ä¸‹æ®µï¼šæ¬¡ã®äººã®å…¥åŠ›çŠ¶æ³ -->
                <div class="tier-panel tier-next">
                    <div class="tier-header">
                        <span id="nextUserName" class="tier-user-name">æ¬¡ã®äºº</span>
                    </div>
                    <div id="nextUserInput" class="tier-content">
                        å¾…æ©Ÿä¸­...
                    </div>
                </div>
            </div>
            
            <!-- ãƒ­ã‚°è¡¨ç¤ºãƒ‘ãƒãƒ«ï¼ˆæ—§ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒ‘ãƒãƒ«ï¼‰ -->
            <div class="log-panel">
                <h3>é€ä¿¡æ¸ˆã¿ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ç®¡ç†</h3>
                <div class="log-controls">
                    <button id="logShowBtn" class="log-show-btn">ğŸ“‹ ãƒ­ã‚°è¡¨ç¤º</button>
                    <button id="exportTextBtn" class="export-btn">ãƒ†ã‚­ã‚¹ãƒˆã®ã¿ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</button>
                    <button id="exportTimecodeBtn" class="export-btn">ã‚¿ã‚¤ãƒ ã‚³ãƒ¼ãƒ‰ä»˜ãã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</button>
                    <button id="clearLogBtn" class="clear-log-btn">ãƒ­ã‚°ã‚¯ãƒªã‚¢</button>
                    <span id="logStats" class="log-stats">ãƒ­ã‚°: 0ä»¶</span>
                </div>
            </div>
            
            <div class="participants-panel">
                <h3>å‚åŠ è€…ä¸€è¦§ (<span id="participantCount">0</span>å)</h3>
                <div id="participantsList" class="participants-list">
                    <!-- å‚åŠ è€…ä¸€è¦§ãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã‚‹ -->
                </div>
            </div>
        </div>
        
        <div class="info-box">
            <h3>ã‚¢ã‚¯ã‚»ã‚¹æ–¹æ³•</h3>
            <p>ä»–ã®ãƒ‡ãƒã‚¤ã‚¹ã‹ã‚‰ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹å ´åˆã¯ã€ä»¥ä¸‹ã®URLã‚’ä½¿ç”¨ã—ã¦ãã ã•ã„ã€‚</p>
            <div class="connection-info">
                å‚åŠ å¾Œã«å®Ÿéš›ã®URLãŒè¡¨ç¤ºã•ã‚Œã¾ã™
            </div>
            
            <!-- QRã‚³ãƒ¼ãƒ‰è¡¨ç¤ºã‚¨ãƒªã‚¢ã‚’è¿½åŠ  -->
            <div class="qr-section" style="margin-top: 20px; border-top: 1px solid #ddd; padding-top: 15px;">
                <h4 style="color: #495057; margin-bottom: 10px; font-size: 14px;">è¡¨ç¤ºç”¨ç”»é¢ QRã‚³ãƒ¼ãƒ‰</h4>
                <div id="qrcode" style="text-align: center; margin: 10px 0;"></div>
                <p style="font-size: 12px; color: #666; text-align: center;">
                    ã‚¹ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒ³ã‚„ã‚¿ãƒ–ãƒ¬ãƒƒãƒˆã§èª­ã¿å–ã£ã¦è¡¨ç¤ºç”¨ç”»é¢ã«ã‚¢ã‚¯ã‚»ã‚¹
                </p>
            </div>
        </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();
        const statusDiv = document.getElementById('status');
        const statusText = document.getElementById('statusText');
        
        const loginSection = document.getElementById('loginSection');
        const mainSection = document.getElementById('mainSection');
        const nameInput = document.getElementById('nameInput');
        const joinBtn = document.getElementById('joinBtn');
        const participantsList = document.getElementById('participantsList');
        const participantCount = document.getElementById('participantCount');
        
        const textInput = document.getElementById('textInput');
        const sendBtn = document.getElementById('sendBtn');
        
        // ãƒ­ã‚°é–¢é€£ã®è¦ç´ 
        const logShowBtn = document.getElementById('logShowBtn');
        const exportTextBtn = document.getElementById('exportTextBtn');
        const exportTimecodeBtn = document.getElementById('exportTimecodeBtn');
        const clearLogBtn = document.getElementById('clearLogBtn');
        const logStats = document.getElementById('logStats');
        
        // 3æ®µè¡¨ç¤ºç”¨ã®è¦ç´ 
        const previousUserName = document.getElementById('previousUserName');
        const previousUserInput = document.getElementById('previousUserInput');
        const currentUserName = document.getElementById('currentUserName');
        const currentInputStatus = document.getElementById('currentInputStatus');
        const nextUserName = document.getElementById('nextUserName');
        const nextUserInput = document.getElementById('nextUserInput');
        const tierCurrent = document.querySelector('.tier-current');
        const charCounter = document.getElementById('charCounter');
        
        let isJoined = false;
        let myParticipant = null;
        let currentSender = null;
        let typingUsers = new Map(); // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å…¥åŠ›çŠ¶æ³ã‚’ç®¡ç†
        let typingTimeout = null;
        let allParticipants = []; // å…¨å‚åŠ è€…ã‚’ä¿æŒ
        let messageCount = 0; // ãƒ­ã‚°ä»¶æ•°ã‚’ãƒˆãƒ©ãƒƒã‚­ãƒ³ã‚°
        let logWindow = null; // ãƒ­ã‚°ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã®å‚ç…§
        
        // Socket.ioæ¥ç¶šã‚¤ãƒ™ãƒ³ãƒˆ
        socket.on('connect', () => {
            statusDiv.className = 'status';
            statusText.textContent = 'ã‚µãƒ¼ãƒãƒ¼ã«æ¥ç¶šã•ã‚Œã¾ã—ãŸ';
            
            console.log('Socket.ioæ¥ç¶šæˆåŠŸ:', socket.id);
        });
        
        socket.on('disconnect', () => {
            statusDiv.className = 'status error';
            statusText.textContent = 'ã‚µãƒ¼ãƒãƒ¼ã¨ã®æ¥ç¶šãŒåˆ‡æ–­ã•ã‚Œã¾ã—ãŸ';
            
            console.log('Socket.ioæ¥ç¶šåˆ‡æ–­');
        });
        
        socket.on('connect_error', (error) => {
            statusDiv.className = 'status error';
            statusText.textContent = 'ã‚µãƒ¼ãƒãƒ¼ã«æ¥ç¶šã§ãã¾ã›ã‚“ã§ã—ãŸ';
            
            console.error('Socket.ioæ¥ç¶šã‚¨ãƒ©ãƒ¼:', error);
        });
        
        // å‚åŠ é–¢é€£ã®ã‚¤ãƒ™ãƒ³ãƒˆ
        socket.on('joined', (data) => {
            if (data.success) {
                isJoined = true;
                myParticipant = data.participant;
                loginSection.style.display = 'none';
                mainSection.style.display = 'block';
                
                // è‡ªåˆ†ã®åå‰ã‚’è¡¨ç¤º
                currentUserName.textContent = data.participant.name;
                
                // å®Ÿéš›ã®URLã‚’è¡¨ç¤ºã¨QRã‚³ãƒ¼ãƒ‰ç”Ÿæˆ
                if (data.serverInfo) {
                    updateConnectionInfo(data.serverInfo);
                    generateDisplayQR(data.serverInfo.displayUrl);
                }
                
                console.log('å‚åŠ å®Œäº†:', data.participant);
            }
        });
        
        socket.on('participants_updated', (data) => {
            allParticipants = data.participants;
            updateParticipantsList(data.participants, data.currentSender);
            updateSenderInfo(data.currentSender);
            updateInputState(data.currentSender);
            updateThreeTierDisplay(data.participants, data.currentSender);
            
            if (data.participants.length >= 1 && data.currentSender) {
            }
        });
        
        socket.on('sender_updated', (data) => {
            updateSenderInfo(data.currentSender);
            updateInputState(data.currentSender);
            updateParticipantsList(null, data.currentSender); // å‚åŠ è€…ä¸€è¦§ã¯æ›´æ–°ã›ãšé€ä¿¡æ¨©è¡¨ç¤ºã®ã¿æ›´æ–°
            updateThreeTierDisplay(allParticipants, data.currentSender);
        });
        
        // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å—ä¿¡
        socket.on('text_received', (message) => {
            messageCount++;
            updateLogStats();
            
            // ãƒ­ã‚°ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ãŒé–‹ã„ã¦ã„ã‚‹å ´åˆã€ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¿½åŠ 
            if (logWindow && !logWindow.closed) {
                logWindow.addMessageToLog(message);
            }
        });
        
        // ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ å…¥åŠ›å—ä¿¡
        socket.on('user_typing', (data) => {
            updateTypingUser(data);
            updateThreeTierTyping(data);
        });
        
        // å…¥åŠ›ã‚¯ãƒªã‚¢å—ä¿¡
        socket.on('user_clear_typing', (data) => {
            typingUsers.delete(data.userId);
            clearThreeTierTyping(data.userId);
        });
        
        // ãƒ­ã‚°è¡¨ç¤ºã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã‚’é–‹ã
        function openLogWindow() {
            const logUrl = window.location.origin + '/logs';
            
            // æ—¢å­˜ã®ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ãŒã‚ã‚‹å ´åˆã¯é–‰ã˜ã‚‹
            if (logWindow && !logWindow.closed) {
                logWindow.close();
            }
            
            // æ–°ã—ã„ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã‚’é–‹ã
            logWindow = window.open(
                logUrl,
                'transcription-logs',
                'width=1000,height=700,scrollbars=yes,resizable=yes,menubar=no,toolbar=no,location=no,status=no'
            );
            
            if (!logWindow) {
                alert('ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ãŒãƒ–ãƒ­ãƒƒã‚¯ã•ã‚Œã¾ã—ãŸã€‚ãƒ–ãƒ©ã‚¦ã‚¶ã®è¨­å®šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
                return;
            }
            
            // ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ãŒé–‰ã˜ã‚‰ã‚ŒãŸå ´åˆã®å‡¦ç†
            const checkClosed = setInterval(() => {
                if (logWindow.closed) {
                    clearInterval(checkClosed);
                    logWindow = null;
                }
            }, 1000);
            
            console.log('ãƒ­ã‚°ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã‚’é–‹ãã¾ã—ãŸ:', logUrl);
        }
        
        // æ–‡å­—æ•°ã‚’ã‚«ã‚¦ãƒ³ãƒˆï¼ˆå…¨è§’ç›¸å½“ï¼‰
        function countCharacters(text) {
            let count = 0;
            for (let i = 0; i < text.length; i++) {
                const char = text[i];
                // å…¨è§’æ–‡å­—ï¼ˆã²ã‚‰ãŒãªã€ã‚«ã‚¿ã‚«ãƒŠã€æ¼¢å­—ã€å…¨è§’è¨˜å·ãªã©ï¼‰ã¯1æ–‡å­—
                // åŠè§’æ–‡å­—ï¼ˆè‹±æ•°å­—ã€åŠè§’è¨˜å·ãªã©ï¼‰ã¯0.5æ–‡å­—ã¨ã—ã¦ã‚«ã‚¦ãƒ³ãƒˆ
                if (char.match(/[^\x00-\x7F]/)) {
                    count += 1; // å…¨è§’æ–‡å­—
                } else {
                    count += 0.5; // åŠè§’æ–‡å­—
                }
            }
            return count; // å°æ•°ç‚¹ä»¥ä¸‹ã‚‚ä¿æŒ
        }
        
        // ã‚«ãƒ¼ã‚½ãƒ«ä½ç½®ã®è¡Œã®æ–‡å­—æ•°ã‚’å–å¾—
        function getCurrentLineCharCount() {
            const textarea = textInput;
            const text = textarea.value;
            const cursorPos = textarea.selectionStart;
            
            // ã‚«ãƒ¼ã‚½ãƒ«ä½ç½®ã‚ˆã‚Šå‰ã®æœ€å¾Œã®æ”¹è¡Œã‚’è¦‹ã¤ã‘ã‚‹
            const beforeCursor = text.substring(0, cursorPos);
            const lastNewline = beforeCursor.lastIndexOf('\n');
            
            // ã‚«ãƒ¼ã‚½ãƒ«ä½ç½®ã‚ˆã‚Šå¾Œã®æœ€åˆã®æ”¹è¡Œã‚’è¦‹ã¤ã‘ã‚‹
            const afterCursor = text.substring(cursorPos);
            const nextNewline = afterCursor.indexOf('\n');
            
            // ç¾åœ¨ã®è¡Œã®ãƒ†ã‚­ã‚¹ãƒˆã‚’å–å¾—
            const lineStart = lastNewline + 1;
            const lineEnd = nextNewline === -1 ? text.length : cursorPos + nextNewline;
            const currentLine = text.substring(lineStart, lineEnd);
            
            return countCharacters(currentLine);
        }
        
        // æ–‡å­—æ•°è¡¨ç¤ºã‚’æ›´æ–°
        function updateCharCounter() {
            const charCount = getCurrentLineCharCount();
            // æ•´æ•°ã®å ´åˆã¯ã€Œ6æ–‡å­—ã€ã€å°æ•°ã®å ´åˆã¯ã€Œ6.5æ–‡å­—ã€ã¨è¡¨ç¤º
            const displayCount = charCount % 1 === 0 ? charCount.toString() : charCount.toString();
            charCounter.textContent = `${displayCount}æ–‡å­—`;
        }
        
        // æ¥ç¶šæƒ…å ±ã‚’æ›´æ–°ã™ã‚‹é–¢æ•°
        function updateConnectionInfo(serverInfo) {
            const connectionInfo = document.querySelector('.connection-info');
            if (connectionInfo) {
                connectionInfo.innerHTML = `
                    <strong>ã‚ªãƒšãƒ¬ãƒ¼ã‚¿ãƒ¼ç”»é¢:</strong> ${serverInfo.operatorUrl}<br>
                    <strong>è¡¨ç¤ºç”¨ç”»é¢:</strong> ${serverInfo.displayUrl}
                `;
            }
        }
        
        // QRã‚³ãƒ¼ãƒ‰ç”Ÿæˆé–¢æ•°ï¼ˆä¿®æ­£ç‰ˆï¼‰
        function generateDisplayQR(displayUrl) {
            const qrCodeElement = document.getElementById('qrcode');
            if (qrCodeElement) {
                // ã‚·ãƒ³ãƒ—ãƒ«ãªURLç”Ÿæˆ
                const qrImageUrl = `https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=${encodeURIComponent(displayUrl)}`;
                
                qrCodeElement.innerHTML = `
                    <img src="${qrImageUrl}" 
                         alt="QRã‚³ãƒ¼ãƒ‰" 
                         style="border: 1px solid #ddd; border-radius: 4px;"
                         onload="console.log('QRç”»åƒèª­ã¿è¾¼ã¿æˆåŠŸ')"
                         onerror="console.log('QRç”»åƒèª­ã¿è¾¼ã¿å¤±æ•—'); this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTUwIiBoZWlnaHQ9IjE1MCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMTUwIiBoZWlnaHQ9IjE1MCIgZmlsbD0iI2Y5ZjlmOSIvPjx0ZXh0IHg9Ijc1IiB5PSI3NSIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZmlsbD0iIzk5OSI+UVLjgrPjg7zjg4njgZfjga7jgozjgb7jgZvjgpM8L3RleHQ+PC9zdmc+';">
                `;
                
                console.log('QRã‚³ãƒ¼ãƒ‰ç”Ÿæˆå®Œäº†:', displayUrl);
                console.log('QRã‚³ãƒ¼ãƒ‰URL:', qrImageUrl);
            }
        }
        
        // é€ä¿¡æ¨©æƒ…å ±ã‚’æ›´æ–°
        function updateSenderInfo(sender) {
            currentSender = sender;
            console.log('é€ä¿¡æ¨©æƒ…å ±æ›´æ–°:', sender);
        }
        
        // å‚åŠ è€…ä¸€è¦§ã‚’æ›´æ–°
        function updateParticipantsList(participants, sender) {
            // participantsãŒnullã®å ´åˆã¯ã€é€ä¿¡æ¨©è¡¨ç¤ºã®ã¿æ›´æ–°
            if (participants !== null) {
                participantCount.textContent = participants.length;
                
                if (participants.length === 0) {
                    participantsList.innerHTML = '<p style="color: #666;">å‚åŠ è€…ãŒã„ã¾ã›ã‚“</p>';
                    return;
                }
                
                participantsList.innerHTML = participants.map(participant => {
                    const hasSenderPermission = sender && sender.id === participant.id;
                    const itemClass = hasSenderPermission ? 'participant-item has-sender-permission' : 'participant-item';
                    const senderBadge = hasSenderPermission ? '<span class="sender-badge">é€ä¿¡æ¨©</span>' : '';
                    
                    return `
                        <div class="${itemClass}">
                            <span class="participant-name">${participant.name}</span>
                            <span class="participant-status">æ¥ç¶šä¸­</span>
                            ${senderBadge}
                        </div>
                    `;
                }).join('');
            } else {
                // é€ä¿¡æ¨©è¡¨ç¤ºã®ã¿æ›´æ–°ï¼ˆå‚åŠ è€…ä¸€è¦§ã¯å¤‰æ›´ã—ãªã„ï¼‰
                const participantItems = document.querySelectorAll('.participant-item');
                participantItems.forEach(item => {
                    const nameElement = item.querySelector('.participant-name');
                    const hasSenderPermission = sender && nameElement.textContent === sender.name;
                    
                    if (hasSenderPermission) {
                        item.className = 'participant-item has-sender-permission';
                        if (!item.querySelector('.sender-badge')) {
                            item.innerHTML += '<span class="sender-badge">é€ä¿¡æ¨©</span>';
                        }
                    } else {
                        item.className = 'participant-item';
                        const existingBadge = item.querySelector('.sender-badge');
                        if (existingBadge) {
                            existingBadge.remove();
                        }
                    }
                });
            }
        }
        
        // å…¥åŠ›çŠ¶æ…‹ã‚’æ›´æ–°
        function updateInputState(sender) {
            console.log('å…¥åŠ›çŠ¶æ…‹æ›´æ–°:', sender);
            console.log('è‡ªåˆ†:', myParticipant);
            
            const hasSenderPermission = myParticipant && sender && sender.id === myParticipant.id;
            console.log('é€ä¿¡æ¨©ãƒã‚§ãƒƒã‚¯çµæœ:', hasSenderPermission);
            
            if (hasSenderPermission) {
                console.log('é€ä¿¡æ¨©ã‚ã‚Š - UIæ›´æ–°');
                textInput.disabled = false;
                sendBtn.disabled = false;
                currentInputStatus.textContent = 'é€ä¿¡å¯èƒ½';
                currentInputStatus.className = 'tier-status';
                textInput.className = 'has-permission';
                sendBtn.className = 'send-btn has-permission';
            } else {
                console.log('é€ä¿¡æ¨©ãªã— - UIæ›´æ–°');
                textInput.disabled = false; // é€ä¿¡æ¨©ãŒãªãã¦ã‚‚å…¥åŠ›ã¯å¯èƒ½
                sendBtn.disabled = true;
                currentInputStatus.textContent = 'é€ä¿¡æ¨©å¾…ã¡';
                currentInputStatus.className = 'tier-status waiting';
                textInput.className = '';
                sendBtn.className = 'send-btn';
            }
        }
        
        // é€ä¿¡ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆ
        sendBtn.addEventListener('click', () => {
            const text = textInput.value.trim();
            
            if (!text) {
                // ãƒ†ã‚­ã‚¹ãƒˆãŒç©ºã®å ´åˆã¯ã€é€ä¿¡æ¨©ã®ã¿æ¬¡ã«ç§»ã™ï¼ˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡ãªã—ï¼‰
                socket.emit('next_sender');
            } else {
                // ãƒ†ã‚­ã‚¹ãƒˆãŒã‚ã‚‹å ´åˆã¯ã€é€šå¸¸ã®é€ä¿¡å‡¦ç†
                socket.emit('send_text', { text: text });
            }
            
            // é€ä¿¡æ™‚ã«å…¥åŠ›ã‚¯ãƒªã‚¢ã‚’é€šçŸ¥
            socket.emit('clear_typing');
            
            textInput.value = ''; // é€ä¿¡å¾Œã«ã‚¯ãƒªã‚¢
            updateCharCounter(); // æ–‡å­—æ•°ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼ã‚’ãƒªã‚»ãƒƒãƒˆ
        });
        
        // Enterã‚­ãƒ¼ï¼ˆCtrl+Enterï¼‰ã§é€ä¿¡
        textInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && e.ctrlKey) {
                e.preventDefault();
                if (!sendBtn.disabled) {
                    sendBtn.click();
                }
            }
        });
        
        // æ–‡å­—æ•°ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼ã®æ›´æ–°
        textInput.addEventListener('input', updateCharCounter);
        textInput.addEventListener('keyup', updateCharCounter);
        textInput.addEventListener('click', updateCharCounter);
        
        // ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ å…¥åŠ›ã‚’æ›´æ–°
        function updateTypingUser(data) {
            if (data.text.trim() === '') {
                // ç©ºã®å ´åˆã¯å‰Šé™¤
                typingUsers.delete(data.userId);
            } else {
                // ãƒ†ã‚­ã‚¹ãƒˆãŒã‚ã‚‹å ´åˆã¯æ›´æ–°
                typingUsers.set(data.userId, {
                    userName: data.userName,
                    text: data.text,
                    timestamp: data.timestamp
                });
            }
        }
        
        // è‡ªåˆ†ã®å…¥åŠ›ã‚’ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ é€ä¿¡ï¼ˆæœ€é€Ÿè¨­å®šï¼‰
        textInput.addEventListener('input', () => {
            if (typingTimeout) {
                clearTimeout(typingTimeout);
            }
            
            // 20msé…å»¶ï¼ˆé«˜é€Ÿãƒ¬ã‚¹ãƒãƒ³ã‚¹ï¼‰
            typingTimeout = setTimeout(() => {
                if (isJoined) {
                    socket.emit('typing', { text: textInput.value });
                }
            }, 20);
        });
        
        // 3æ®µè¡¨ç¤ºã‚’æ›´æ–°
        function updateThreeTierDisplay(participants, currentSender) {
            console.log('3æ®µè¡¨ç¤ºæ›´æ–° - å‚åŠ è€…æ•°:', participants.length);
            console.log('è‡ªåˆ†ã®æƒ…å ±:', myParticipant);
            console.log('é€ä¿¡æ¨©è€…:', currentSender);
            
            if (!myParticipant || participants.length === 0) {
                previousUserName.textContent = 'å‰ã®äºº';
                previousUserInput.textContent = 'å¾…æ©Ÿä¸­...';
                previousUserInput.className = 'tier-content empty';
                document.querySelector('.tier-previous').className = 'tier-panel tier-previous';
                
                currentUserName.textContent = 'ã‚ãªãŸ';
                
                nextUserName.textContent = 'æ¬¡ã®äºº';
                nextUserInput.textContent = 'å¾…æ©Ÿä¸­...';
                nextUserInput.className = 'tier-content empty';
                document.querySelector('.tier-next').className = 'tier-panel tier-next';
                return;
            }
            
            // ç¾åœ¨ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ä½ç½®ã‚’ç‰¹å®š
            const myIndex = participants.findIndex(p => p.id === myParticipant.id);
            console.log('è‡ªåˆ†ã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹:', myIndex);
            
            if (myIndex === -1) return;
            
            // å‰ã®äººã‚’å–å¾—ï¼ˆå¾ªç’°ï¼‰
            const previousIndex = (myIndex - 1 + participants.length) % participants.length;
            const previousUser = participants[previousIndex];
            
            // æ¬¡ã®äººã‚’å–å¾—ï¼ˆå¾ªç’°ï¼‰
            const nextIndex = (myIndex + 1) % participants.length;
            const nextUser = participants[nextIndex];
            
            console.log('å‰ã®äºº:', previousUser.name, 'æ¬¡ã®äºº:', nextUser.name);
            
            // 1äººã®å ´åˆã®ç‰¹åˆ¥å‡¦ç†
            if (participants.length === 1) {
                previousUserName.textContent = 'ã‚ãªãŸï¼ˆå‰ã®é †ç•ªï¼‰';
                previousUserInput.textContent = '1äººãƒ¢ãƒ¼ãƒ‰ã§ã™';
                previousUserInput.className = 'tier-content empty';
                document.querySelector('.tier-previous').className = 'tier-panel tier-previous';
                
                nextUserName.textContent = 'ã‚ãªãŸï¼ˆæ¬¡ã®é †ç•ªï¼‰';
                nextUserInput.textContent = '1äººãƒ¢ãƒ¼ãƒ‰ã§ã™';
                nextUserInput.className = 'tier-content empty';
                document.querySelector('.tier-next').className = 'tier-panel tier-next';
            } else {
                // å‰ã®äºº
                previousUserName.textContent = previousUser.name;
                const previousTyping = typingUsers.get(previousUser.id);
                if (previousTyping && previousTyping.text.trim()) {
                    previousUserInput.textContent = previousTyping.text;
                    previousUserInput.className = 'tier-content';
                } else {
                    previousUserInput.textContent = 'å¾…æ©Ÿä¸­...';
                    previousUserInput.className = 'tier-content empty';
                }
                
                // å‰ã®äººãŒé€ä¿¡æ¨©ã‚’æŒã£ã¦ã„ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
                const previousHasSender = currentSender && currentSender.id === previousUser.id;
                document.querySelector('.tier-previous').className = previousHasSender 
                    ? 'tier-panel tier-previous has-sender-permission' 
                    : 'tier-panel tier-previous';
                
                // æ¬¡ã®äºº
                nextUserName.textContent = nextUser.name;
                const nextTyping = typingUsers.get(nextUser.id);
                if (nextTyping && nextTyping.text.trim()) {
                    nextUserInput.textContent = nextTyping.text;
                    nextUserInput.className = 'tier-content';
                } else {
                    nextUserInput.textContent = 'å¾…æ©Ÿä¸­...';
                    nextUserInput.className = 'tier-content empty';
                }
                
                // æ¬¡ã®äººãŒé€ä¿¡æ¨©ã‚’æŒã£ã¦ã„ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
                const nextHasSender = currentSender && currentSender.id === nextUser.id;
                document.querySelector('.tier-next').className = nextHasSender 
                    ? 'tier-panel tier-next has-sender-permission' 
                    : 'tier-panel tier-next';
            }
            
            // è‡ªåˆ†ã®åå‰ã‚’æ›´æ–°
            currentUserName.textContent = myParticipant.name;
            
            // è‡ªåˆ†ãŒé€ä¿¡æ¨©ã‚’æŒã£ã¦ã„ã‚‹ã‹ãƒã‚§ãƒƒã‚¯ï¼ˆä¸­æ®µç”¨ï¼‰
            const iHaveSender = currentSender && currentSender.id === myParticipant.id;
            tierCurrent.className = iHaveSender 
                ? 'tier-panel tier-current has-sender-permission' 
                : 'tier-panel tier-current';
        }
        
        // 3æ®µè¡¨ç¤ºã®ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ å…¥åŠ›ã‚’æ›´æ–°
        function updateThreeTierTyping(data) {
            console.log('3æ®µè¡¨ç¤ºæ›´æ–°:', data);
            
            if (!myParticipant || allParticipants.length === 0) {
                console.log('å‚åŠ è€…æƒ…å ±ãŒãªã„');
                return;
            }
            
            const myIndex = allParticipants.findIndex(p => p.id === myParticipant.id);
            if (myIndex === -1) {
                console.log('è‡ªåˆ†ãŒå‚åŠ è€…ãƒªã‚¹ãƒˆã«ã„ãªã„');
                return;
            }
            
            const previousIndex = (myIndex - 1 + allParticipants.length) % allParticipants.length;
            const nextIndex = (myIndex + 1) % allParticipants.length;
            
            const previousUser = allParticipants[previousIndex];
            const nextUser = allParticipants[nextIndex];
            
            console.log('å‰ã®äºº:', previousUser.name, 'ID:', previousUser.id);
            console.log('æ¬¡ã®äºº:', nextUser.name, 'ID:', nextUser.id);
            console.log('å…¥åŠ›è€…ID:', data.userId);
            
            // å‰ã®äººã®å…¥åŠ›æ›´æ–°
            if (data.userId === previousUser.id) {
                console.log('å‰ã®äººã®å…¥åŠ›æ›´æ–°:', data.text);
                if (data.text.trim()) {
                    previousUserInput.textContent = data.text;
                    previousUserInput.className = 'tier-content';
                } else {
                    previousUserInput.textContent = 'å¾…æ©Ÿä¸­...';
                    previousUserInput.className = 'tier-content empty';
                }
            }
            
            // æ¬¡ã®äººã®å…¥åŠ›æ›´æ–°
            if (data.userId === nextUser.id) {
                console.log('æ¬¡ã®äººã®å…¥åŠ›æ›´æ–°:', data.text);
                if (data.text.trim()) {
                    nextUserInput.textContent = data.text;
                    nextUserInput.className = 'tier-content';
                } else {
                    nextUserInput.textContent = 'å¾…æ©Ÿä¸­...';
                    nextUserInput.className = 'tier-content empty';
                }
            }
        }
        
        // 3æ®µè¡¨ç¤ºã®å…¥åŠ›ã‚¯ãƒªã‚¢
        function clearThreeTierTyping(userId) {
            if (!myParticipant || allParticipants.length === 0) return;
            
            const myIndex = allParticipants.findIndex(p => p.id === myParticipant.id);
            if (myIndex === -1) return;
            
            const previousIndex = (myIndex - 1 + allParticipants.length) % allParticipants.length;
            const nextIndex = (myIndex + 1) % allParticipants.length;
            
            const previousUser = allParticipants[previousIndex];
            const nextUser = allParticipants[nextIndex];
            
            // å‰ã®äººã®å…¥åŠ›ã‚¯ãƒªã‚¢
            if (userId === previousUser.id) {
                previousUserInput.textContent = 'å¾…æ©Ÿä¸­...';
                previousUserInput.className = 'tier-content empty';
            }
            
            // æ¬¡ã®äººã®å…¥åŠ›ã‚¯ãƒªã‚¢
            if (userId === nextUser.id) {
                nextUserInput.textContent = 'å¾…æ©Ÿä¸­...';
                nextUserInput.className = 'tier-content empty';
            }
        }
        
        // F12ã‚­ãƒ¼ã§é€ä¿¡ï¼ˆã‚°ãƒ­ãƒ¼ãƒãƒ«ï¼‰
        document.addEventListener('keydown', (e) => {
            if (e.key === 'F12') {
                e.preventDefault();
                if (!sendBtn.disabled) {
                    sendBtn.click();
                } else {
                    console.log('é€ä¿¡æ¨©ãŒãªã„ãŸã‚é€ä¿¡ã§ãã¾ã›ã‚“');
                }
            }
        });
        
        // ãƒ­ã‚°çµ±è¨ˆæƒ…å ±ã‚’æ›´æ–°
        async function updateLogStats() {
            try {
                // ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰ãƒ­ã‚°çµ±è¨ˆã‚’å–å¾—
                const response = await fetch('/api/log-stats');
                if (response.ok) {
                    const stats = await response.json();
                    messageCount = stats.totalMessages;
                    console.log('ã‚µãƒ¼ãƒãƒ¼ãƒ­ã‚°çµ±è¨ˆ:', stats);
                } else {
                    console.log('ãƒ­ã‚°çµ±è¨ˆå–å¾—å¤±æ•—ã€ãƒ­ãƒ¼ã‚«ãƒ«ã‚«ã‚¦ãƒ³ãƒˆã‚’ä½¿ç”¨');
                }
            } catch (error) {
                console.log('ãƒ­ã‚°çµ±è¨ˆå–å¾—ã‚¨ãƒ©ãƒ¼ã€ãƒ­ãƒ¼ã‚«ãƒ«ã‚«ã‚¦ãƒ³ãƒˆã‚’ä½¿ç”¨:', error);
            }
            
            logStats.textContent = `ãƒ­ã‚°: ${messageCount}ä»¶`;
            
            // ãƒœã‚¿ãƒ³ã®æœ‰åŠ¹/ç„¡åŠ¹ã‚’åˆ‡ã‚Šæ›¿ãˆ
            const hasMessages = messageCount > 0;
            exportTextBtn.disabled = !hasMessages;
            exportTimecodeBtn.disabled = !hasMessages;
            clearLogBtn.disabled = !hasMessages;
            
            console.log(`ãƒ­ã‚°ä»¶æ•°æ›´æ–°: ${messageCount}ä»¶, ãƒœã‚¿ãƒ³æœ‰åŠ¹: ${hasMessages}`);
        }
        
        // CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
        async function downloadCSV(type) {
            console.log(`ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰é–‹å§‹: ${type}, ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸æ•°: ${messageCount}`);
            
            if (messageCount === 0) {
                alert('ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã™ã‚‹ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“');
                return;
            }
            
            try {
                const url = `/api/export/${type}`;
                console.log(`ãƒªã‚¯ã‚¨ã‚¹ãƒˆURL: ${url}`);
                
                const response = await fetch(url);
                console.log('ãƒ¬ã‚¹ãƒãƒ³ã‚¹å—ä¿¡:', response.status, response.statusText);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const blob = await response.blob();
                console.log('Blobä½œæˆ:', blob.size, blob.type);
                
                // ãƒ•ã‚¡ã‚¤ãƒ«åã‚’ç”Ÿæˆ
                const timestamp = new Date().toISOString().slice(0, 19).replace(/[:-]/g, '');
                const filename = type === 'text-only' 
                    ? `transcription_text_${timestamp}.csv`
                    : `transcription_timecode_${timestamp}.csv`;
                
                // ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰å®Ÿè¡Œ
                const downloadUrl = window.URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = downloadUrl;
                link.download = filename;
                link.style.display = 'none';
                
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                // URLã‚’è§£æ”¾
                window.URL.revokeObjectURL(downloadUrl);
                
                console.log(`ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰å®Œäº†: ${filename}`);
                
            } catch (error) {
                console.error('ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã‚¨ãƒ©ãƒ¼:', error);
                alert(`ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã«å¤±æ•—ã—ã¾ã—ãŸ: ${error.message}`);
            }
        }
        
        // ãƒ­ã‚°ã‚¯ãƒªã‚¢
        async function clearLog() {
            if (messageCount === 0) {
                alert('ã‚¯ãƒªã‚¢ã™ã‚‹ãƒ­ã‚°ãŒã‚ã‚Šã¾ã›ã‚“');
                return;
            }
            
            if (!confirm('ã™ã¹ã¦ã®ãƒ­ã‚°ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿã“ã®æ“ä½œã¯å…ƒã«æˆ»ã›ã¾ã›ã‚“ã€‚')) {
                return;
            }
            
            try {
                const response = await fetch('/api/clear-log', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                if (response.ok) {
                    messageCount = 0;
                    updateLogStats();
                    
                    // ãƒ­ã‚°ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ãŒé–‹ã„ã¦ã„ã‚‹å ´åˆã€ãƒ­ã‚°ã‚‚ã‚¯ãƒªã‚¢
                    if (logWindow && !logWindow.closed) {
                        logWindow.clearAllLogs();
                    }
                    
                    alert('ãƒ­ã‚°ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸ');
                    console.log('ãƒ­ã‚°ã‚¯ãƒªã‚¢å®Œäº†');
                } else {
                    throw new Error('ãƒ­ã‚°ã‚¯ãƒªã‚¢ã«å¤±æ•—ã—ã¾ã—ãŸ');
                }
            } catch (error) {
                console.error('ãƒ­ã‚°ã‚¯ãƒªã‚¢ã‚¨ãƒ©ãƒ¼:', error);
                alert('ãƒ­ã‚°ã‚¯ãƒªã‚¢ã«å¤±æ•—ã—ã¾ã—ãŸ');
            }
        }
        
        // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼è¨­å®š
        joinBtn.addEventListener('click', () => {
            const name = nameInput.value.trim();
            
            if (!name) {
                alert('å‚åŠ è€…åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }
            
            if (name.length > 20) {
                alert('å‚åŠ è€…åã¯20æ–‡å­—ä»¥å†…ã§å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }
            
            joinBtn.disabled = true;
            joinBtn.textContent = 'å‚åŠ ä¸­...';
            
            socket.emit('join', { name: name });
        });
        
        // Enterã‚­ãƒ¼ã§ã‚‚å‚åŠ ã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹
        nameInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                joinBtn.click();
            }
        });
        
        // ãƒ­ã‚°è¡¨ç¤ºãƒœã‚¿ãƒ³
        logShowBtn.addEventListener('click', () => {
            console.log('ãƒ­ã‚°è¡¨ç¤ºãƒœã‚¿ãƒ³ãŒã‚¯ãƒªãƒƒã‚¯ã•ã‚Œã¾ã—ãŸ');
            openLogWindow();
        });
        
        // ãƒ­ã‚°ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼è¨­å®š
        exportTextBtn.addEventListener('click', async () => {
            console.log('ãƒ†ã‚­ã‚¹ãƒˆã®ã¿ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆãƒœã‚¿ãƒ³ãŒã‚¯ãƒªãƒƒã‚¯ã•ã‚Œã¾ã—ãŸ');
            await downloadCSV('text-only');
        });

        exportTimecodeBtn.addEventListener('click', async () => {
            console.log('ã‚¿ã‚¤ãƒ ã‚³ãƒ¼ãƒ‰ä»˜ãã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆãƒœã‚¿ãƒ³ãŒã‚¯ãƒªãƒƒã‚¯ã•ã‚Œã¾ã—ãŸ');
            await downloadCSV('with-timecode');
        });

        clearLogBtn.addEventListener('click', async () => {
            console.log('ãƒ­ã‚°ã‚¯ãƒªã‚¢ãƒœã‚¿ãƒ³ãŒã‚¯ãƒªãƒƒã‚¯ã•ã‚Œã¾ã—ãŸ');
            await clearLog();
        });

        // åˆæœŸåŒ–æ™‚ã«ãƒ­ã‚°çµ±è¨ˆã‚’æ›´æ–°
        updateLogStats();
    </script>
</body>
</html>
