<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ÈÄÅ‰ø°Ê∏à„Åø„É°„ÉÉ„Çª„Éº„Ç∏„É≠„Ç∞</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: Arial, sans-serif;
            background-color: #f8f9fa;
            padding: 20px;
            line-height: 1.6;
        }
        
        .header {
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        
        .header h1 {
            color: #333;
            margin-bottom: 15px;
            text-align: center;
        }
        
        .status-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding: 10px;
            background-color: #e9ecef;
            border-radius: 4px;
        }
        
        .connection-status {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background-color: #dc3545;
        }
        
        .status-indicator.connected {
            background-color: #28a745;
        }
        
        .log-stats {
            font-weight: bold;
            color: #495057;
        }
        
        .controls {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            align-items: center;
        }
        
        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            transition: background-color 0.3s;
        }
        
        .btn-primary {
            background-color: #007bff;
            color: white;
        }
        
        .btn-primary:hover {
            background-color: #0056b3;
        }
        
        .btn-secondary {
            background-color: #6c757d;
            color: white;
        }
        
        .btn-secondary:hover {
            background-color: #545b62;
        }
        
        .btn-danger {
            background-color: #dc3545;
            color: white;
        }
        
        .btn-danger:hover {
            background-color: #c82333;
        }
        
        .btn:disabled {
            background-color: #e9ecef;
            color: #6c757d;
            cursor: not-allowed;
        }
        
        .timestamp-toggle {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-left: auto;
        }
        
        .toggle-switch {
            position: relative;
            width: 50px;
            height: 24px;
            background-color: #ccc;
            border-radius: 12px;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        
        .toggle-switch.active {
            background-color: #007bff;
        }
        
        .toggle-slider {
            position: absolute;
            top: 2px;
            left: 2px;
            width: 20px;
            height: 20px;
            background-color: white;
            border-radius: 50%;
            transition: transform 0.3s;
        }
        
        .toggle-switch.active .toggle-slider {
            transform: translateX(26px);
        }
        
        .messages-container {
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            max-height: calc(100vh - 200px);
            overflow-y: auto;
        }
        
        .messages-list {
            padding: 20px;
        }
        
        .message-item {
            padding: 15px;
            margin-bottom: 12px;
            background-color: #f8f9fa;
            border-radius: 6px;
            border-left: 4px solid #007bff;
            transition: box-shadow 0.3s;
        }
        
        .message-item:hover {
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .message-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
            font-size: 13px;
            color: #6c757d;
        }
        
        .message-sender {
            font-weight: bold;
            color: #007bff;
        }
        
        .message-timestamp {
            font-family: monospace;
            transition: opacity 0.3s;
        }
        
        .message-timestamp.hidden {
            opacity: 0;
        }
        
        .message-text {
            font-size: 16px;
            line-height: 1.5;
            color: #333;
            white-space: pre-wrap;
            word-wrap: break-word;
        }
        
        .no-messages {
            text-align: center;
            color: #6c757d;
            font-style: italic;
            padding: 50px 20px;
            font-size: 18px;
        }
        
        .message-number {
            background-color: #007bff;
            color: white;
            font-size: 11px;
            padding: 2px 6px;
            border-radius: 10px;
            margin-right: 8px;
        }
        
        .auto-scroll-control {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            cursor: pointer;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            transition: all 0.3s;
            z-index: 1000;
            font-size: 18px;
            font-weight: bold;
        }
        
        .auto-scroll-control:hover:not(.disabled) {
            background-color: #0056b3;
            transform: scale(1.1);
        }
        
        .auto-scroll-control.disabled {
            background-color: #28a745;
            cursor: default;
            transform: none;
            opacity: 0.7;
        }
        
        /* „Çπ„ÇØ„É≠„Éº„É´„Éê„Éº„ÅÆ„Çπ„Çø„Ç§„É´ */
        .messages-container::-webkit-scrollbar {
            width: 8px;
        }
        
        .messages-container::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }
        
        .messages-container::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 4px;
        }
        
        .messages-container::-webkit-scrollbar-thumb:hover {
            background: #a8a8a8;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üìã ÈÄÅ‰ø°Ê∏à„Åø„É°„ÉÉ„Çª„Éº„Ç∏„É≠„Ç∞</h1>
        <div class="status-bar">
            <div class="connection-status">
                <div id="statusIndicator" class="status-indicator"></div>
                <span id="connectionText">Êé•Á∂ö‰∏≠...</span>
            </div>
            <div class="log-stats" id="logStats">„É≠„Ç∞: 0‰ª∂</div>
        </div>
        <div class="controls">
            <button id="exportTextBtn" class="btn btn-primary">üìÑ „ÉÜ„Ç≠„Çπ„Éà„ÅÆ„Åø„Ç®„ÇØ„Çπ„Éù„Éº„Éà</button>
            <button id="exportTimecodeBtn" class="btn btn-primary">‚è∞ „Çø„Ç§„É†„Ç≥„Éº„Éâ‰ªò„Åç„Ç®„ÇØ„Çπ„Éù„Éº„Éà</button>
            <button id="refreshBtn" class="btn btn-secondary">üîÑ Êõ¥Êñ∞</button>
            <button id="clearLogBtn" class="btn btn-danger">üóëÔ∏è „É≠„Ç∞„ÇØ„É™„Ç¢</button>
            <div class="timestamp-toggle">
                <span>„Çø„Ç§„É†„Çπ„Çø„É≥„ÉóË°®Á§∫</span>
                <div class="toggle-switch active" id="timestampToggle">
                    <div class="toggle-slider"></div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="messages-container" id="messagesContainer">
        <div class="messages-list" id="messagesList">
            <div class="no-messages" id="noMessages">
                üì≠ „Åæ„Å†„É°„ÉÉ„Çª„Éº„Ç∏„Åå„ÅÇ„Çä„Åæ„Åõ„Çì
            </div>
        </div>
    </div>
    
    <button class="auto-scroll-control disabled" id="autoScrollBtn" title="ÊúÄÊñ∞„É°„ÉÉ„Çª„Éº„Ç∏„Åæ„Åß„Çπ„ÇØ„É≠„Éº„É´">
        ‚Üì
    </button>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        console.log('=== „É≠„Ç∞Ë°®Á§∫„Ç¶„Ç£„É≥„Éâ„Ç¶ÈñãÂßã ===');
        
        // DOMË¶ÅÁ¥†„ÅÆÂèñÂæó
        const statusIndicator = document.getElementById('statusIndicator');
        const connectionText = document.getElementById('connectionText');
        const logStats = document.getElementById('logStats');
        const messagesList = document.getElementById('messagesList');
        const noMessages = document.getElementById('noMessages');
        const messagesContainer = document.getElementById('messagesContainer');
        const autoScrollBtn = document.getElementById('autoScrollBtn');
        const timestampToggle = document.getElementById('timestampToggle');
        
        // „Éú„Çø„É≥Ë¶ÅÁ¥†
        const exportTextBtn = document.getElementById('exportTextBtn');
        const exportTimecodeBtn = document.getElementById('exportTimecodeBtn');
        const refreshBtn = document.getElementById('refreshBtn');
        const clearLogBtn = document.getElementById('clearLogBtn');
        
        // Áä∂ÊÖãÁÆ°ÁêÜ
        let messages = [];
        let showTimestamp = true;
        let autoScroll = true; // „Éá„Éï„Ç©„É´„Éà„ÅßËá™Âãï„Çπ„ÇØ„É≠„Éº„É´ON
        let messageCount = 0;
        let userScrolled = false; // „É¶„Éº„Ç∂„Éº„ÅåÊâãÂãï„Åß„Çπ„ÇØ„É≠„Éº„É´„Åó„Åü„Åã„ÇíËøΩË∑°
        
        // Socket.ioÊé•Á∂ö
        const socket = io();
        
        socket.on('connect', () => {
            statusIndicator.className = 'status-indicator connected';
            connectionText.textContent = 'Êé•Á∂öÊ∏à„Åø';
            console.log('Socket.ioÊé•Á∂öÊàêÂäü:', socket.id);
            
            // Êé•Á∂öÂæå„Å´Êó¢Â≠ò„É≠„Ç∞„ÇíË™≠„ÅøËæº„Åø
            loadExistingLogs();
        });
        
        socket.on('disconnect', () => {
            statusIndicator.className = 'status-indicator';
            connectionText.textContent = 'ÂàáÊñ≠';
            console.log('Socket.ioÊé•Á∂öÂàáÊñ≠');
        });
        
        socket.on('connect_error', (error) => {
            statusIndicator.className = 'status-indicator';
            connectionText.textContent = 'Êé•Á∂ö„Ç®„É©„Éº';
            console.error('Socket.ioÊé•Á∂ö„Ç®„É©„Éº:', error);
        });
        
        // „É™„Ç¢„É´„Çø„Ç§„É†„É°„ÉÉ„Çª„Éº„Ç∏Âèó‰ø°
        socket.on('text_received', (message) => {
            console.log('Êñ∞„Åó„ÅÑ„É°„ÉÉ„Çª„Éº„Ç∏Âèó‰ø°:', message);
            addMessageToLog(message);
        });
        
        // Êó¢Â≠ò„É≠„Ç∞„ÅÆË™≠„ÅøËæº„Åø
        async function loadExistingLogs() {
            try {
                console.log('Êó¢Â≠ò„É≠„Ç∞„ÇíË™≠„ÅøËæº„Åø‰∏≠...');
                const response = await fetch('/api/messages');
                
                if (response.ok) {
                    const data = await response.json();
                    console.log('Êó¢Â≠ò„É≠„Ç∞ÂèñÂæóÊàêÂäü:', data.messages.length, '‰ª∂');
                    
                    // Êó¢Â≠ò„ÅÆ„É°„ÉÉ„Çª„Éº„Ç∏ÈÖçÂàó„Çí„ÇØ„É™„Ç¢„Åó„Å¶„Åã„ÇâË®≠ÂÆö
                    messages = [];
                    messages = data.messages || [];
                    messageCount = messages.length;
                    
                    updateLogStats();
                    renderAllMessages();
                    
                    console.log('Êó¢Â≠ò„É≠„Ç∞Ë™≠„ÅøËæº„ÅøÂÆå‰∫Ü:', messages.length, '‰ª∂');
                } else {
                    console.error('Êó¢Â≠ò„É≠„Ç∞ÂèñÂæóÂ§±Êïó:', response.status);
                }
            } catch (error) {
                console.error('Êó¢Â≠ò„É≠„Ç∞Ë™≠„ÅøËæº„Åø„Ç®„É©„Éº:', error);
            }
        }
        
        // „É°„ÉÉ„Çª„Éº„Ç∏„Çí„É≠„Ç∞„Å´ËøΩÂä†
        function addMessageToLog(message) {
            // ÈáçË§á„ÉÅ„Çß„ÉÉ„ÇØ: Âêå„ÅòID„Åæ„Åü„ÅØ„Çø„Ç§„É†„Çπ„Çø„É≥„Éó„ÅÆ„É°„ÉÉ„Çª„Éº„Ç∏„Åå„Åô„Åß„Å´Â≠òÂú®„Åô„Çã„Åã„ÉÅ„Çß„ÉÉ„ÇØ
            const isDuplicate = messages.some(existingMessage => 
                existingMessage.id === message.id || 
                (existingMessage.timestamp === message.timestamp && 
                 existingMessage.sender === message.sender && 
                 existingMessage.text === message.text)
            );
            
            if (isDuplicate) {
                console.log('ÈáçË§á„É°„ÉÉ„Çª„Éº„Ç∏„ÇíÊ§úÂá∫„ÄÅ„Çπ„Ç≠„ÉÉ„Éó:', message);
                return;
            }
            
            messages.push(message);
            messageCount++;
            
            updateLogStats();
            renderMessage(message, messages.length);
            
            // Êñ∞„Åó„ÅÑ„É°„ÉÉ„Çª„Éº„Ç∏„ÅåËøΩÂä†„Åï„Çå„Åü„ÇâÂøÖ„ÅöÊúÄ‰∏ãÈÉ®„Å´„Çπ„ÇØ„É≠„Éº„É´
            setTimeout(() => {
                scrollToBottom();
                userScrolled = false; // Ëá™Âãï„Çπ„ÇØ„É≠„Éº„É´„Å™„ÅÆ„Åß„Éï„É©„Ç∞„Çí„É™„Çª„ÉÉ„Éà
            }, 100);
            
            console.log('Êñ∞„Åó„ÅÑ„É°„ÉÉ„Çª„Éº„Ç∏„ÇíËøΩÂä†:', message);
        }
        
        // „Åô„Åπ„Å¶„ÅÆ„É°„ÉÉ„Çª„Éº„Ç∏„ÇíÂÜçÊèèÁîª
        function renderAllMessages() {
            if (messages.length === 0) {
                noMessages.style.display = 'block';
                return;
            }
            
            noMessages.style.display = 'none';
            messagesList.innerHTML = '';
            
            messages.forEach((message, index) => {
                renderMessage(message, index + 1);
            });
            
            // ÂàùÊúüË°®Á§∫ÊôÇ„ÅØÂøÖ„ÅöÊúÄ‰∏ãÈÉ®„Å´„Çπ„ÇØ„É≠„Éº„É´
            setTimeout(() => {
                scrollToBottom();
                userScrolled = false;
            }, 200);
        }
        
        // Âçò‰∏Ä„É°„ÉÉ„Çª„Éº„Ç∏„ÇíÊèèÁîª
        function renderMessage(message, messageNumber) {
            noMessages.style.display = 'none';
            
            const messageElement = document.createElement('div');
            messageElement.className = 'message-item';
            
            const timestamp = new Date(message.timestamp);
            const timeString = timestamp.toLocaleTimeString('ja-JP');
            const dateString = timestamp.toLocaleDateString('ja-JP');
            
            messageElement.innerHTML = `
                <div class="message-header">
                    <div>
                        <span class="message-number">#${messageNumber}</span>
                        <span class="message-sender">${message.sender}</span>
                    </div>
                    <div class="message-timestamp ${showTimestamp ? '' : 'hidden'}">
                        ${dateString} ${timeString}
                    </div>
                </div>
                <div class="message-text">${message.text}</div>
            `;
            
            messagesList.appendChild(messageElement);
        }
        
        // „É≠„Ç∞Áµ±Ë®à„ÇíÊõ¥Êñ∞
        function updateLogStats() {
            logStats.textContent = `„É≠„Ç∞: ${messageCount}‰ª∂`;
            
            // „Éú„Çø„É≥„ÅÆÊúâÂäπ/ÁÑ°Âäπ„ÇíÂàá„ÇäÊõø„Åà
            const hasMessages = messageCount > 0;
            exportTextBtn.disabled = !hasMessages;
            exportTimecodeBtn.disabled = !hasMessages;
            clearLogBtn.disabled = !hasMessages;
        }
        
        // ÊúÄ‰∏ãÈÉ®„Å´„Çπ„ÇØ„É≠„Éº„É´
        function scrollToBottom() {
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }
        
        // „Çø„Ç§„É†„Çπ„Çø„É≥„ÉóË°®Á§∫Âàá„ÇäÊõø„Åà
        function toggleTimestamp() {
            showTimestamp = !showTimestamp;
            timestampToggle.classList.toggle('active', showTimestamp);
            
            // Êó¢Â≠ò„ÅÆ„Çø„Ç§„É†„Çπ„Çø„É≥„ÉóË°®Á§∫„ÇíÂàá„ÇäÊõø„Åà
            const timestamps = document.querySelectorAll('.message-timestamp');
            timestamps.forEach(timestamp => {
                timestamp.classList.toggle('hidden', !showTimestamp);
            });
            
            console.log('„Çø„Ç§„É†„Çπ„Çø„É≥„ÉóË°®Á§∫:', showTimestamp ? 'ON' : 'OFF');
        }
        
        // CSV„Ç®„ÇØ„Çπ„Éù„Éº„Éà
        async function exportCSV(type) {
            if (messageCount === 0) {
                alert('„Ç®„ÇØ„Çπ„Éù„Éº„Éà„Åô„Çã„Éá„Éº„Çø„Åå„ÅÇ„Çä„Åæ„Åõ„Çì');
                return;
            }
            
            try {
                const url = `/api/export/${type}`;
                const response = await fetch(url);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const blob = await response.blob();
                
                // „Éï„Ç°„Ç§„É´Âêç„ÇíÁîüÊàê
                const timestamp = new Date().toISOString().slice(0, 19).replace(/[:-]/g, '');
                const filename = type === 'text-only' 
                    ? `transcription_text_${timestamp}.csv`
                    : `transcription_timecode_${timestamp}.csv`;
                
                // „ÉÄ„Ç¶„É≥„É≠„Éº„ÉâÂÆüË°å
                const downloadUrl = window.URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = downloadUrl;
                link.download = filename;
                link.style.display = 'none';
                
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                window.URL.revokeObjectURL(downloadUrl);
                
                console.log(`„Ç®„ÇØ„Çπ„Éù„Éº„ÉàÂÆå‰∫Ü: ${filename}`);
                
            } catch (error) {
                console.error('„Ç®„ÇØ„Çπ„Éù„Éº„Éà„Ç®„É©„Éº:', error);
                alert(`„Ç®„ÇØ„Çπ„Éù„Éº„Éà„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ${error.message}`);
            }
        }
        
        // „É≠„Ç∞„ÇØ„É™„Ç¢
        async function clearAllLogs() {
            if (messageCount === 0) {
                alert('„ÇØ„É™„Ç¢„Åô„Çã„É≠„Ç∞„Åå„ÅÇ„Çä„Åæ„Åõ„Çì');
                return;
            }
            
            if (!confirm('„Åô„Åπ„Å¶„ÅÆ„É≠„Ç∞„Éá„Éº„Çø„ÇíÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü„Åì„ÅÆÊìç‰Ωú„ÅØÂÖÉ„Å´Êàª„Åõ„Åæ„Åõ„Çì„ÄÇ')) {
                return;
            }
            
            try {
                const response = await fetch('/api/clear-log', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                if (response.ok) {
                    // „É≠„Éº„Ç´„É´„Éá„Éº„Çø„ÇÇ„ÇØ„É™„Ç¢
                    messages = [];
                    messageCount = 0;
                    messagesList.innerHTML = '';
                    noMessages.style.display = 'block';
                    updateLogStats();
                    
                    alert('„É≠„Ç∞„Çí„ÇØ„É™„Ç¢„Åó„Åæ„Åó„Åü');
                    console.log('„É≠„Ç∞„ÇØ„É™„Ç¢ÂÆå‰∫Ü');
                } else {
                    throw new Error('„É≠„Ç∞„ÇØ„É™„Ç¢„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
                }
            } catch (error) {
                console.error('„É≠„Ç∞„ÇØ„É™„Ç¢„Ç®„É©„Éº:', error);
                alert('„É≠„Ç∞„ÇØ„É™„Ç¢„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
            }
        }
        
        // „Çπ„ÇØ„É≠„Éº„É´Áõ£Ë¶ñÔºàËá™Âãï„Çπ„ÇØ„É≠„Éº„É´Âà∂Âæ°Ôºâ
        messagesContainer.addEventListener('scroll', () => {
            const { scrollTop, scrollHeight, clientHeight } = messagesContainer;
            const isAtBottom = scrollTop + clientHeight >= scrollHeight - 10;
            
            autoScroll = isAtBottom;
            autoScrollBtn.classList.toggle('disabled', isAtBottom);
        });
        
        // „Ç§„Éô„É≥„Éà„É™„Çπ„Éä„ÉºË®≠ÂÆö
        timestampToggle.addEventListener('click', toggleTimestamp);
        
        exportTextBtn.addEventListener('click', () => exportCSV('text-only'));
        exportTimecodeBtn.addEventListener('click', () => exportCSV('with-timecode'));
        
        refreshBtn.addEventListener('click', () => {
            console.log('„É≠„Ç∞Êõ¥Êñ∞„Éú„Çø„É≥„Åå„ÇØ„É™„ÉÉ„ÇØ„Åï„Çå„Åæ„Åó„Åü');
            loadExistingLogs();
        });
        
        clearLogBtn.addEventListener('click', clearAllLogs);
        
        autoScrollBtn.addEventListener('click', () => {
            scrollToBottom();
            userScrolled = false;
            console.log('ÊâãÂãï„ÅßÊúÄ‰∏ãÈÉ®„Å´„Çπ„ÇØ„É≠„Éº„É´');
        });
        
        // „Ç¶„Ç£„É≥„Éâ„Ç¶„ÅåÈñâ„Åò„Çâ„Çå„ÇãÂâç„ÅÆÂá¶ÁêÜ
        window.addEventListener('beforeunload', () => {
            socket.disconnect();
        });
        
        // Ë¶™„Ç¶„Ç£„É≥„Éâ„Ç¶„Åã„ÇâÂëº„Å≥Âá∫„Åï„Çå„ÇãÈñ¢Êï∞„Çí„Ç∞„É≠„Éº„Éê„É´„Å´Ë®≠ÂÆö
        window.addMessageToLog = addMessageToLog;
        window.clearAllLogs = clearAllLogs;
        
        console.log('„É≠„Ç∞„Ç¶„Ç£„É≥„Éâ„Ç¶ÂàùÊúüÂåñÂÆå‰∫Ü');
    </script>
</body>
</html>