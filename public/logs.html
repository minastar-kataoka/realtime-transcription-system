<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é€ä¿¡æ¸ˆã¿ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒ­ã‚°</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: Arial, sans-serif;
            background-color: #f8f9fa;
            padding: 20px;
            line-height: 1.6;
        }
        
        .header {
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        
        .header h1 {
            color: #333;
            margin-bottom: 15px;
            text-align: center;
        }
        
        .status-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding: 10px;
            background-color: #e9ecef;
            border-radius: 4px;
        }
        
        .connection-status {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background-color: #dc3545;
        }
        
        .status-indicator.connected {
            background-color: #28a745;
        }
        
        .log-stats {
            font-weight: bold;
            color: #495057;
        }
        
        .controls {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            align-items: center;
        }
        
        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            transition: background-color 0.3s;
        }
        
        .btn-primary {
            background-color: #007bff;
            color: white;
        }
        
        .btn-primary:hover {
            background-color: #0056b3;
        }
        
        .btn-secondary {
            background-color: #6c757d;
            color: white;
        }
        
        .btn-secondary:hover {
            background-color: #545b62;
        }
        
        .btn-danger {
            background-color: #dc3545;
            color: white;
        }
        
        .btn-danger:hover {
            background-color: #c82333;
        }
        
        .btn:disabled {
            background-color: #e9ecef;
            color: #6c757d;
            cursor: not-allowed;
        }
        
        .timestamp-toggle {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-left: auto;
        }
        
        .toggle-switch {
            position: relative;
            width: 50px;
            height: 24px;
            background-color: #ccc;
            border-radius: 12px;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        
        .toggle-switch.active {
            background-color: #007bff;
        }
        
        .toggle-slider {
            position: absolute;
            top: 2px;
            left: 2px;
            width: 20px;
            height: 20px;
            background-color: white;
            border-radius: 50%;
            transition: transform 0.3s;
        }
        
        .toggle-switch.active .toggle-slider {
            transform: translateX(26px);
        }
        
        .messages-container {
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            max-height: calc(100vh - 200px);
            overflow-y: auto;
        }
        
        .messages-list {
            padding: 0;
        }
        
        .message-item {
            display: flex;
            gap: 10px;
            padding: 8px 12px;
            margin-bottom: 0;
            border-bottom: 1px solid #dee2e6;
        }
        
        /* é€ä¿¡è€…åˆ¥ã®èƒŒæ™¯è‰² - å…¥åŠ›ç”»é¢ã¨é‡è¤‡ã—ãªã„å¼·ã‚ã®è‰² */
        .message-item[data-sender="prev"] {
            background-color: #ffccbc;  /* ã‚ªãƒ¬ãƒ³ã‚¸ç³» - 1ç•ªç›®ã®å‚åŠ è€… */
        }
        
        .message-item[data-sender="current"] {
            background-color: #e1bee7;  /* ç´«ç³» - 2ç•ªç›®ã®å‚åŠ è€… */
        }
        
        .message-item[data-sender="next"] {
            background-color: #c5e1a5;  /* ãƒ©ã‚¤ãƒ ã‚°ãƒªãƒ¼ãƒ³ç³» - 3ç•ªç›®ã®å‚åŠ è€… */
        }
        
        .message-item:hover {
            opacity: 0.9;
        }
        
        .message-header {
            display: none;  /* ãƒ­ã‚°ç•ªå·ã¨é€ä¿¡è€…ã‚’éè¡¨ç¤º */
        }
        
        .message-sender {
            font-weight: bold;
            color: #007bff;
        }
        
        .message-timestamp {
            font-family: monospace;
            transition: opacity 0.3s;
        }
        
        .message-timestamp.hidden {
            opacity: 0;
        }
        
        .message-text {
            flex: 1;
            font-size: 16px;
            line-height: 1.5;
            color: #333;
            white-space: pre-wrap;
            word-wrap: break-word;
        }
        
        .message-actions {
            display: flex;
            gap: 4px;
            flex-shrink: 0;
        }
        
        .btn-copy {
            padding: 4px 8px;
            font-size: 12px;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            background-color: #28a745;
            color: white;
            white-space: nowrap;
            transition: background-color 0.2s;
        }
        
        .btn-copy:hover {
            background-color: #218838;
        }
        
        .btn-copy-from {
            padding: 4px 8px;
            font-size: 12px;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            background-color: #17a2b8;
            color: white;
            white-space: nowrap;
            transition: background-color 0.2s;
        }
        
        .btn-copy-from:hover {
            background-color: #138496;
        }
        
        .no-messages {
            text-align: center;
            color: #6c757d;
            font-style: italic;
            padding: 50px 20px;
            font-size: 18px;
        }
        
        .message-number {
            background-color: #007bff;
            color: white;
            font-size: 11px;
            padding: 2px 6px;
            border-radius: 10px;
            margin-right: 8px;
        }
        
        .auto-scroll-control {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            cursor: pointer;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            transition: all 0.3s;
            z-index: 1000;
            font-size: 18px;
            font-weight: bold;
        }
        
        .auto-scroll-control:hover:not(.disabled) {
            background-color: #0056b3;
            transform: scale(1.1);
        }
        
        .auto-scroll-control.disabled {
            background-color: #28a745;
            cursor: default;
            transform: none;
            opacity: 0.7;
        }
        
        /* ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãƒãƒ¼ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .messages-container::-webkit-scrollbar {
            width: 8px;
        }
        
        .messages-container::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }
        
        .messages-container::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 4px;
        }
        
        .messages-container::-webkit-scrollbar-thumb:hover {
            background: #a8a8a8;
        }
    </style>
</head>
<body>
    <div class="header">
        <!-- <h1>ğŸ“‹ é€ä¿¡æ¸ˆã¿ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒ­ã‚°</h1> -->
        <div class="status-bar">
            <div class="connection-status">
                <div id="statusIndicator" class="status-indicator"></div>
                <span id="connectionText">æ¥ç¶šä¸­...</span>
            </div>
            <div class="log-stats" id="logStats">ãƒ­ã‚°: 0ä»¶</div>
        </div>
        <div class="controls">
            <button id="exportTextBtn" class="btn btn-primary">ğŸ“„ ãƒ­ã‚°å‡ºåŠ›</button>
            <button id="exportTimecodeBtn" class="btn btn-primary">â° ãƒ­ã‚°å‡ºåŠ›(tcä»˜ã)</button>
            <button id="refreshBtn" class="btn btn-secondary">ğŸ”„ æ›´æ–°</button>
            <button id="clearLogBtn" class="btn btn-danger">ğŸ—‘ï¸ ãƒ­ã‚°ã‚¯ãƒªã‚¢</button>
        </div>
    </div>
    
    <div class="messages-container" id="messagesContainer">
        <div class="messages-list" id="messagesList">
            <div class="no-messages" id="noMessages">
                ğŸ“­ ã¾ã ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒã‚ã‚Šã¾ã›ã‚“
            </div>
        </div>
    </div>
    
    <button class="auto-scroll-control disabled" id="autoScrollBtn" title="æœ€æ–°ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¾ã§ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«">
        â†“
    </button>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        console.log('=== ãƒ­ã‚°è¡¨ç¤ºã‚¦ã‚£ãƒ³ãƒ‰ã‚¦é–‹å§‹ ===');
        
        // DOMè¦ç´ ã®å–å¾—
        const statusIndicator = document.getElementById('statusIndicator');
        const connectionText = document.getElementById('connectionText');
        const logStats = document.getElementById('logStats');
        const messagesList = document.getElementById('messagesList');
        const noMessages = document.getElementById('noMessages');
        const messagesContainer = document.getElementById('messagesContainer');
        const autoScrollBtn = document.getElementById('autoScrollBtn');
        
        // ãƒœã‚¿ãƒ³è¦ç´ 
        const exportTextBtn = document.getElementById('exportTextBtn');
        const exportTimecodeBtn = document.getElementById('exportTimecodeBtn');
        const refreshBtn = document.getElementById('refreshBtn');
        const clearLogBtn = document.getElementById('clearLogBtn');
        
        // çŠ¶æ…‹ç®¡ç†
        let messages = [];
        let autoScroll = true; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§è‡ªå‹•ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ON
        let messageCount = 0;
        let userScrolled = false; // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒæ‰‹å‹•ã§ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã—ãŸã‹ã‚’è¿½è·¡
        
        // URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‹ã‚‰roomIdã‚’å–å¾—
        const urlParams = new URLSearchParams(window.location.search);
        const roomId = urlParams.get('room');
        
        if (!roomId) {
            alert('ãƒ«ãƒ¼ãƒ IDãŒæŒ‡å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚ãƒ«ãƒ¼ãƒ ç®¡ç†ç”»é¢ã«ç§»å‹•ã—ã¾ã™ã€‚');
            window.location.href = '/room-manager';
        }
        
        // Socket.ioæ¥ç¶š
        const socket = io();
        
        // å‚åŠ è€…æƒ…å ±ã‚’æ ¼ç´
        let participants = [];
        
        socket.on('connect', () => {
            statusIndicator.className = 'status-indicator connected';
            connectionText.textContent = 'æ¥ç¶šæ¸ˆã¿';
            console.log('Socket.ioæ¥ç¶šæˆåŠŸ:', socket.id);
            
            // ãƒ­ã‚°ç”»é¢ã¨ã—ã¦ãƒ«ãƒ¼ãƒ ã«å‚åŠ 
            if (roomId) {
                socket.emit('join_logs', { roomId: roomId });
                console.log('join_logsã‚¤ãƒ™ãƒ³ãƒˆé€ä¿¡:', roomId);
            }
            
            // æ¥ç¶šå¾Œã«æ—¢å­˜ãƒ­ã‚°ã‚’èª­ã¿è¾¼ã¿
            loadExistingLogs();
        });
        
        socket.on('disconnect', () => {
            statusIndicator.className = 'status-indicator';
            connectionText.textContent = 'åˆ‡æ–­';
            console.log('Socket.ioæ¥ç¶šåˆ‡æ–­');
        });
        
        socket.on('connect_error', (error) => {
            statusIndicator.className = 'status-indicator';
            connectionText.textContent = 'æ¥ç¶šã‚¨ãƒ©ãƒ¼';
            console.error('Socket.ioæ¥ç¶šã‚¨ãƒ©ãƒ¼:', error);
        });
        
        // å‚åŠ è€…æƒ…å ±ã®æ›´æ–°
        socket.on('participants_updated', (data) => {
            participants = data.participants || [];
            console.log('å‚åŠ è€…æƒ…å ±æ›´æ–°:', participants);
            // æ—¢å­˜ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å†æç”»ï¼ˆèƒŒæ™¯è‰²ã‚’æ›´æ–°ï¼‰
            renderAllMessages();
        });
        
        // ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å—ä¿¡
        socket.on('text_received', (message) => {
            console.log('æ–°ã—ã„ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å—ä¿¡:', message);
            addMessageToLog(message);
        });
        
        // æ—¢å­˜ãƒ­ã‚°ã®èª­ã¿è¾¼ã¿
        async function loadExistingLogs() {
            try {
                console.log('æ—¢å­˜ãƒ­ã‚°ã‚’èª­ã¿è¾¼ã¿ä¸­...');
                const response = await fetch('/api/messages');
                
                if (response.ok) {
                    const data = await response.json();
                    console.log('æ—¢å­˜ãƒ­ã‚°å–å¾—æˆåŠŸ:', data.messages.length, 'ä»¶');
                    
                    // æ—¢å­˜ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é…åˆ—ã‚’ã‚¯ãƒªã‚¢ã—ã¦ã‹ã‚‰è¨­å®š
                    messages = [];
                    messages = data.messages || [];
                    messageCount = messages.length;
                    
                    updateLogStats();
                    renderAllMessages();
                    
                    console.log('æ—¢å­˜ãƒ­ã‚°èª­ã¿è¾¼ã¿å®Œäº†:', messages.length, 'ä»¶');
                } else {
                    console.error('æ—¢å­˜ãƒ­ã‚°å–å¾—å¤±æ•—:', response.status);
                }
            } catch (error) {
                console.error('æ—¢å­˜ãƒ­ã‚°èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
            }
        }
        
        // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ãƒ­ã‚°ã«è¿½åŠ 
        function addMessageToLog(message) {
            // é‡è¤‡ãƒã‚§ãƒƒã‚¯: åŒã˜IDã¾ãŸã¯ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒã™ã§ã«å­˜åœ¨ã™ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
            const isDuplicate = messages.some(existingMessage => 
                existingMessage.id === message.id || 
                (existingMessage.timestamp === message.timestamp && 
                 existingMessage.sender === message.sender && 
                 existingMessage.text === message.text)
            );
            
            if (isDuplicate) {
                console.log('é‡è¤‡ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’æ¤œå‡ºã€ã‚¹ã‚­ãƒƒãƒ—:', message);
                return;
            }
            
            messages.push(message);
            messageCount++;
            
            updateLogStats();
            renderMessage(message, messages.length);
            
            // è‡ªå‹•ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãŒONã®å ´åˆã®ã¿æœ€ä¸‹éƒ¨ã«ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
            if (autoScroll) {
                setTimeout(() => {
                    scrollToBottom();
                }, 100);
            }
            
            console.log('æ–°ã—ã„ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¿½åŠ :', message);
        }
        
        // ã™ã¹ã¦ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å†æç”»
        function renderAllMessages() {
            if (messages.length === 0) {
                noMessages.style.display = 'block';
                return;
            }
            
            noMessages.style.display = 'none';
            messagesList.innerHTML = '';
            
            messages.forEach((message, index) => {
                renderMessage(message, index + 1);
            });
            
            // åˆæœŸè¡¨ç¤ºæ™‚ã¯å¿…ãšæœ€ä¸‹éƒ¨ã«ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
            setTimeout(() => {
                scrollToBottom();
                userScrolled = false;
            }, 200);
        }
        
        // å˜ä¸€ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’æç”»
        function renderMessage(message, messageNumber) {
            noMessages.style.display = 'none';
            
            const messageElement = document.createElement('div');
            messageElement.className = 'message-item';
            
            // é€ä¿¡è€…IDã‹ã‚‰é †ç•ªã‚’åˆ¤å®š
            const senderType = getSenderType(message.senderId);
            messageElement.setAttribute('data-sender', senderType);
            
            console.log('é€ä¿¡è€…:', message.sender, 'ID:', message.senderId, 'â†’', senderType);
            
            const timestamp = new Date(message.timestamp);
            const timeString = timestamp.toLocaleTimeString('ja-JP');
            const dateString = timestamp.toLocaleDateString('ja-JP');
            
            messageElement.innerHTML = `
                <div class="message-header">
                    <div>
                        <span class="message-number">#${messageNumber}</span>
                        <span class="message-sender">${message.sender}</span>
                    </div>
                    <div class="message-timestamp">
                        ${dateString} ${timeString}
                    </div>
                </div>
                <div class="message-text">${message.text}</div>
                <div class="message-actions">
                    <button class="btn-copy" onclick="copyMessage(${messageNumber - 1}, event)">ã‚³ãƒ”ãƒ¼</button>
                    <button class="btn-copy-from" onclick="copyFromMessage(${messageNumber - 1}, event)">â†“ã‚³ãƒ”ãƒ¼</button>
                </div>
            `;
            
            messagesList.appendChild(messageElement);
        }
        
        // é€ä¿¡è€…IDã‹ã‚‰é †ç•ªã‚¿ã‚¤ãƒ—ã‚’åˆ¤å®š
        function getSenderType(senderId) {
            if (!senderId || participants.length === 0) {
                return 'current'; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ
            }
            
            // å‚åŠ è€…ãƒªã‚¹ãƒˆã‹ã‚‰é€ä¿¡è€…ã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’å–å¾—
            const senderIndex = participants.findIndex(p => p.id === senderId);
            
            if (senderIndex === -1) {
                console.log('é€ä¿¡è€…ãŒå‚åŠ è€…ãƒªã‚¹ãƒˆã«è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“:', senderId);
                return 'current';
            }
            
            // ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã«å¿œã˜ã¦è‰²ã‚’æ±ºå®šï¼ˆ0=prev, 1=current, 2=next, ...ï¼‰
            const colorIndex = senderIndex % 3;
            
            if (colorIndex === 0) {
                return 'prev';    // æ°´è‰²
            } else if (colorIndex === 1) {
                return 'current'; // ç·‘
            } else {
                return 'next';    // é»„è‰²
            }
        }
        
        // å€‹åˆ¥ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ã‚³ãƒ”ãƒ¼
        function copyMessage(index, event) {
            if (index < 0 || index >= messages.length) {
                console.error('ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“:', index);
                return;
            }
            
            const message = messages[index];
            const text = message.text;
            
            navigator.clipboard.writeText(text).then(() => {
                console.log('ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ:', text);
                // ä¸€æ™‚çš„ãªãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯è¡¨ç¤º
                const btn = event.target;
                const originalText = btn.textContent;
                const originalBg = btn.style.backgroundColor;
                btn.textContent = 'âœ“';
                btn.style.backgroundColor = '#20c997';
                setTimeout(() => {
                    btn.textContent = originalText;
                    btn.style.backgroundColor = originalBg;
                }, 1000);
            }).catch(err => {
                console.error('ã‚³ãƒ”ãƒ¼å¤±æ•—:', err);
                // ã‚¨ãƒ©ãƒ¼æ™‚ã®ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯
                const btn = event.target;
                const originalText = btn.textContent;
                const originalBg = btn.style.backgroundColor;
                btn.textContent = 'âœ—';
                btn.style.backgroundColor = '#dc3545';
                setTimeout(() => {
                    btn.textContent = originalText;
                    btn.style.backgroundColor = originalBg;
                }, 1000);
            });
        }
        
        // è©²å½“ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‹ã‚‰æœ€å¾Œã¾ã§ã‚’ã‚³ãƒ”ãƒ¼
        function copyFromMessage(index, event) {
            if (index < 0 || index >= messages.length) {
                console.error('ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“:', index);
                return;
            }
            
            const messagesToCopy = messages.slice(index);
            const text = messagesToCopy.map(m => m.text).join('\n');
            
            navigator.clipboard.writeText(text).then(() => {
                console.log(`${messagesToCopy.length}ä»¶ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ`);
                // ä¸€æ™‚çš„ãªãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯è¡¨ç¤º
                const btn = event.target;
                const originalText = btn.textContent;
                const originalBg = btn.style.backgroundColor;
                btn.textContent = 'âœ“';
                btn.style.backgroundColor = '#20c997';
                setTimeout(() => {
                    btn.textContent = originalText;
                    btn.style.backgroundColor = originalBg;
                }, 1000);
            }).catch(err => {
                console.error('ã‚³ãƒ”ãƒ¼å¤±æ•—:', err);
                // ã‚¨ãƒ©ãƒ¼æ™‚ã®ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯
                const btn = event.target;
                const originalText = btn.textContent;
                const originalBg = btn.style.backgroundColor;
                btn.textContent = 'âœ—';
                btn.style.backgroundColor = '#dc3545';
                setTimeout(() => {
                    btn.textContent = originalText;
                    btn.style.backgroundColor = originalBg;
                }, 1000);
            });
        }
        
        // ãƒ­ã‚°çµ±è¨ˆã‚’æ›´æ–°
        function updateLogStats() {
            logStats.textContent = `ãƒ­ã‚°: ${messageCount}ä»¶`;
            
            // ãƒœã‚¿ãƒ³ã®æœ‰åŠ¹/ç„¡åŠ¹ã‚’åˆ‡ã‚Šæ›¿ãˆ
            const hasMessages = messageCount > 0;
            exportTextBtn.disabled = !hasMessages;
            exportTimecodeBtn.disabled = !hasMessages;
            clearLogBtn.disabled = !hasMessages;
        }
        
        // æœ€ä¸‹éƒ¨ã«ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
        function scrollToBottom() {
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }
        
        // CSVã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
        async function exportCSV(type) {
            if (messageCount === 0) {
                alert('ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã™ã‚‹ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“');
                return;
            }
            
            if (!roomId) {
                alert('ãƒ«ãƒ¼ãƒ IDãŒå–å¾—ã§ãã¾ã›ã‚“');
                return;
            }
            
            try {
                const url = `/api/export/${type}?roomId=${roomId}`;
                const response = await fetch(url);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const blob = await response.blob();
                
                // ãƒ•ã‚¡ã‚¤ãƒ«åã‚’ç”Ÿæˆ
                const timestamp = new Date().toISOString().slice(0, 19).replace(/[:-]/g, '');
                const filename = type === 'text-only' 
                    ? `transcription_text_${timestamp}.txt`
                    : `transcription_timecode_${timestamp}.txt`;
                
                // ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰å®Ÿè¡Œ
                const downloadUrl = window.URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = downloadUrl;
                link.download = filename;
                link.style.display = 'none';
                
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                window.URL.revokeObjectURL(downloadUrl);
                
                console.log(`ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆå®Œäº†: ${filename}`);
                
            } catch (error) {
                console.error('ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã‚¨ãƒ©ãƒ¼:', error);
                alert(`ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã«å¤±æ•—ã—ã¾ã—ãŸ: ${error.message}`);
            }
        }
        
        // ãƒ­ã‚°ã‚¯ãƒªã‚¢
        async function clearAllLogs() {
            if (messageCount === 0) {
                alert('ã‚¯ãƒªã‚¢ã™ã‚‹ãƒ­ã‚°ãŒã‚ã‚Šã¾ã›ã‚“');
                return;
            }
            
            if (!confirm('ã™ã¹ã¦ã®ãƒ­ã‚°ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿã“ã®æ“ä½œã¯å…ƒã«æˆ»ã›ã¾ã›ã‚“ã€‚')) {
                return;
            }
            
            if (!roomId) {
                alert('ãƒ«ãƒ¼ãƒ IDãŒå–å¾—ã§ãã¾ã›ã‚“');
                return;
            }
            
            try {
                const response = await fetch('/api/clear-log', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        roomId: roomId
                    })
                });
                
                if (response.ok) {
                    // ãƒ­ãƒ¼ã‚«ãƒ«ãƒ‡ãƒ¼ã‚¿ã‚‚ã‚¯ãƒªã‚¢
                    messages = [];
                    messageCount = 0;
                    messagesList.innerHTML = '';
                    noMessages.style.display = 'block';
                    updateLogStats();
                    
                    alert('ãƒ­ã‚°ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸ');
                    console.log('ãƒ­ã‚°ã‚¯ãƒªã‚¢å®Œäº†');
                } else {
                    throw new Error('ãƒ­ã‚°ã‚¯ãƒªã‚¢ã«å¤±æ•—ã—ã¾ã—ãŸ');
                }
            } catch (error) {
                console.error('ãƒ­ã‚°ã‚¯ãƒªã‚¢ã‚¨ãƒ©ãƒ¼:', error);
                alert('ãƒ­ã‚°ã‚¯ãƒªã‚¢ã«å¤±æ•—ã—ã¾ã—ãŸ');
            }
        }
        
        // ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ç›£è¦–ï¼ˆè‡ªå‹•ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«åˆ¶å¾¡ï¼‰
        messagesContainer.addEventListener('scroll', () => {
            const { scrollTop, scrollHeight, clientHeight } = messagesContainer;
            const isAtBottom = scrollTop + clientHeight >= scrollHeight - 10;
            
            autoScroll = isAtBottom;
            autoScrollBtn.classList.toggle('disabled', isAtBottom);
        });
        
        // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼è¨­å®š
        exportTextBtn.addEventListener('click', () => exportCSV('text-only'));
        exportTimecodeBtn.addEventListener('click', () => exportCSV('with-timecode'));
        
        refreshBtn.addEventListener('click', () => {
            console.log('ãƒ­ã‚°æ›´æ–°ãƒœã‚¿ãƒ³ãŒã‚¯ãƒªãƒƒã‚¯ã•ã‚Œã¾ã—ãŸ');
            loadExistingLogs();
        });
        
        clearLogBtn.addEventListener('click', clearAllLogs);
        
        autoScrollBtn.addEventListener('click', () => {
            scrollToBottom();
            autoScroll = true; // è‡ªå‹•ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚’å†é–‹
            console.log('è‡ªå‹•ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ - è‡ªå‹•ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«å†é–‹');
        });
        
        // ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ãŒé–‰ã˜ã‚‰ã‚Œã‚‹å‰ã®å‡¦ç†
        window.addEventListener('beforeunload', () => {
            socket.disconnect();
        });
        
        // è¦ªã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã‹ã‚‰å‘¼ã³å‡ºã•ã‚Œã‚‹é–¢æ•°ã‚’ã‚°ãƒ­ãƒ¼ãƒãƒ«ã«è¨­å®š
        window.addMessageToLog = addMessageToLog;
        window.clearAllLogs = clearAllLogs;
        
        console.log('ãƒ­ã‚°ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦åˆæœŸåŒ–å®Œäº†');
    </script>
</body>
</html>