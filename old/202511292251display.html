<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ–‡å­—èµ·ã“ã— - è¡¨ç¤ºç”»é¢</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: "Hiragino Kaku Gothic ProN", "Hiragino Sans", "Yu Gothic Medium", "Meiryo", "MS Gothic", sans-serif;
            background-color: #000;
            color: #fff;
            overflow: hidden;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }
        
        .header {
            background-color: #1a1a1a;
            padding: 15px 30px;
            border-bottom: 2px solid #333;
            flex-shrink: 0;
        }
        
        .title {
            font-size: 24px;
            font-weight: bold;
            text-align: center;
            color: #fff;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
        }
        
        .version-info {
            font-size: 12px;
            font-weight: normal;
            color: #888;
            background-color: #2a2a2a;
            padding: 4px 10px;
            border-radius: 4px;
        }
        
        .status-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 10px;
            font-size: 14px;
            color: #ccc;
        }
        
        .connection-status {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background-color: #dc3545;
        }
        
        .status-indicator.connected {
            background-color: #28a745;
        }
        
        .current-time {
            font-family: monospace;
        }
        
        .font-controls {
            flex: 1;
            text-align: center;
        }
        
        .settings-btn {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.3s;
        }
        
        .settings-btn:hover {
            background-color: #0056b3;
        }
        
        .main-content {
            flex: 1;
            padding: 30px;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        
        .text-display-area {
            flex: 1;
            border-radius: 10px;
            border: 2px solid #333;
            overflow: hidden;
            position: relative;
            display: flex;
            flex-direction: column;
            justify-content: flex-end;
        }
        
        /* ä¸Šéƒ¨ãƒã‚¹ã‚¯ï¼ˆè¡¨ç¤ºè¡Œæ•°ã‚’åˆ¶é™ï¼‰ */
        .top-mask {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            background: inherit;
            z-index: 5;
            pointer-events: none;
            transition: height 0.3s ease;
        }
        
        .text-lines {
            font-size: 20px;
            line-height: 1.6;
            color: #fff;
            word-wrap: break-word;
            white-space: pre-wrap;
            transition: transform 0.8s linear;
            /* ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³æœ€é©åŒ– */
            will-change: transform;
            backface-visibility: hidden;
            -webkit-backface-visibility: hidden;
            transform: translateZ(0);
            -webkit-transform: translateZ(0);
        }
        
        .text-line {
            margin: 0;
            padding: 8px 12px;
            background-color: inherit;
        }
        
        .waiting-message {
            color: #666;
            font-style: italic;
            text-align: center;
            padding: 50px 0;
        }
        
        .footer {
            background-color: #1a1a1a;
            padding: 10px 30px;
            border-top: 2px solid #333;
            text-align: center;
            font-size: 12px;
            color: #666;
            flex-shrink: 0;
        }
        
        /* å…¨ç”»é¢è¡¨ç¤ºãƒ¢ãƒ¼ãƒ‰ */
        .fullscreen-mode .header,
        .fullscreen-mode .footer {
            display: none;
        }
        
        .fullscreen-mode .main-content {
            padding: 0;
        }
        
        .fullscreen-mode .text-display-area {
            border: none;
            border-radius: 0;
            height: 100vh !important;
        }
        
        /* å…¨ç”»é¢è¡¨ç¤ºã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼ */
        .fullscreen-indicator {
            position: fixed;
            top: 20px;
            right: 20px;
            background-color: rgba(0, 123, 255, 0.9);
            color: white;
            padding: 8px 15px;
            border-radius: 5px;
            font-size: 14px;
            z-index: 3000;
            display: none;
            animation: fadeInOut 2s ease-in-out;
        }
        
        .fullscreen-indicator.show {
            display: block;
        }
        
        @keyframes fadeInOut {
            0%, 100% { opacity: 0; }
            10%, 90% { opacity: 1; }
        }
        
        /* ãƒ‡ãƒãƒƒã‚°ç”¨ */
        .debug-info {
            position: fixed;
            top: 10px;
            right: 10px;
            background-color: rgba(255, 255, 255, 0.1);
            padding: 10px;
            border-radius: 4px;
            font-size: 12px;
            font-family: monospace;
            z-index: 1000;
        }
        
        /* è¨­å®šãƒ‘ãƒãƒ« */
        .settings-modal {
            position: fixed;
            top: 0;
            right: 0;
            width: 500px;
            height: 100%;
            background-color: rgba(26, 26, 26, 0.92);
            backdrop-filter: blur(10px);
            display: none;
            z-index: 3000;
            box-shadow: -5px 0 20px rgba(0, 0, 0, 0.5);
            overflow-y: auto;
            cursor: move; /* ãƒ‰ãƒ©ãƒƒã‚°å¯èƒ½ã‚’ç¤ºã™ */
        }
        
        .settings-panel {
            background-color: transparent;
            padding: 30px;
            width: 100%;
            height: 100%;
            cursor: default; /* ãƒ‘ãƒãƒ«å†…ã¯é€šå¸¸ã®ã‚«ãƒ¼ã‚½ãƒ« */
        }
        
        .settings-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 1px solid #333;
            cursor: grab; /* ãƒ‰ãƒ©ãƒƒã‚°ãƒãƒ³ãƒ‰ãƒ« */
        }
        
        .settings-header:active {
            cursor: grabbing;
        }
        
        .settings-title {
            font-size: 20px;
            font-weight: bold;
            color: #fff;
        }
        
        .close-btn {
            background: none;
            border: none;
            color: #fff;
            font-size: 24px;
            cursor: pointer;
            padding: 5px;
            border-radius: 3px;
            transition: background-color 0.3s;
        }
        
        .close-btn:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }
        
        .settings-tabs {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 1px solid #333;
        }
        
        .tab-btn {
            background: none;
            border: none;
            color: #ccc;
            padding: 10px 20px;
            cursor: pointer;
            font-size: 14px;
            border-bottom: 2px solid transparent;
            transition: all 0.3s;
        }
        
        .tab-btn.active {
            color: #fff;
            border-bottom-color: #007bff;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .setting-group {
            margin-bottom: 25px;
        }
        
        .setting-label {
            display: block;
            color: #fff;
            font-weight: bold;
            margin-bottom: 8px;
        }
        
        .setting-row {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 15px;
        }
        
        .setting-slider {
            flex: 1;
            -webkit-appearance: none;
            appearance: none;
            height: 6px;
            background: #333;
            border-radius: 3px;
            outline: none;
        }
        
        .setting-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            background: #007bff;
            border-radius: 50%;
            cursor: pointer;
        }
        
        .setting-slider::-moz-range-thumb {
            width: 20px;
            height: 20px;
            background: #007bff;
            border-radius: 50%;
            cursor: pointer;
            border: none;
        }
        
        .setting-input {
            width: 80px;
            padding: 8px;
            background-color: #333;
            border: 1px solid #555;
            border-radius: 4px;
            color: #fff;
            font-size: 14px;
        }
        
        .setting-input:focus {
            outline: none;
            border-color: #007bff;
        }
        
        .setting-unit {
            color: #ccc;
            font-size: 14px;
            width: 30px;
        }
        
        .setting-select {
            width: 200px;
            padding: 8px;
            background-color: #333;
            border: 1px solid #555;
            border-radius: 4px;
            color: #fff;
            font-size: 14px;
        }
        
        .setting-select:focus {
            outline: none;
            border-color: #007bff;
        }
        
        .color-input {
            width: 60px;
            height: 40px;
            padding: 0;
            border: 1px solid #555;
            border-radius: 4px;
            background: transparent;
            cursor: pointer;
        }
        
        .color-input::-webkit-color-swatch-wrapper {
            padding: 0;
        }
        
        .color-input::-webkit-color-swatch {
            border: none;
            border-radius: 3px;
        }
        
        .checkbox-wrapper {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .setting-checkbox {
            width: 20px;
            height: 20px;
            accent-color: #007bff;
        }
        
        .settings-actions {
            display: flex;
            gap: 15px;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid #333;
        }
        
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.3s;
        }
        
        .btn-primary {
            background-color: #007bff;
            color: white;
        }
        
        .btn-primary:hover {
            background-color: #0056b3;
        }
        
        .btn-secondary {
            background-color: #6c757d;
            color: white;
        }
        
        .btn-secondary:hover {
            background-color: #545b62;
        }
        
        .btn-danger {
            background-color: #dc3545;
            color: white;
        }
        
        .btn-danger:hover {
            background-color: #c82333;
        }
        
        .preview-info {
            background-color: #2a2a2a;
            padding: 15px;
            border-radius: 4px;
            margin-top: 15px;
            font-size: 14px;
            color: #ccc;
        }
        
        .file-input {
            display: none;
        }
        
        .file-label {
            display: inline-block;
            padding: 10px 20px;
            background-color: #28a745;
            color: white;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.3s;
        }
        
        .file-label:hover {
            background-color: #218838;
        }
    </style>
</head>
<body>
    <!-- å…¨ç”»é¢è¡¨ç¤ºã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼ -->
    <div id="fullscreenIndicator" class="fullscreen-indicator">
        å…¨ç”»é¢ãƒ¢ãƒ¼ãƒ‰ (F11ã§çµ‚äº†)
    </div>
    
    <div class="header">
        <div class="title">
            <span>ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ–‡å­—èµ·ã“ã—</span>
            <span class="version-info">æœ€çµ‚æ›´æ–°: 2024-11-28 03:45 JST</span>
        </div>
        <div class="status-bar">
            <div class="connection-status">
                <div id="statusIndicator" class="status-indicator"></div>
                <span id="connectionText">æ¥ç¶šä¸­...</span>
            </div>
            <div class="font-controls">
                <button id="settingsBtn" class="settings-btn">âš™ï¸ è¡¨ç¤ºè¨­å®š</button>
            </div>
            <div class="current-time" id="currentTime"></div>
        </div>
    </div>
    
    <div class="main-content">
        <div class="text-display-area" id="textDisplayArea">
            <div class="top-mask" id="topMask"></div>
            <div class="text-lines" id="textLines"></div>
        </div>
    </div>
    
    <div class="footer">
        ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ã‚¿ãƒ¼è¡¨ç¤ºç”¨ç”»é¢ - ã‚ªãƒšãƒ¬ãƒ¼ã‚¿ãƒ¼ç”»é¢: <span id="operatorUrl"></span>
    </div>

    <!-- ãƒ‡ãƒãƒƒã‚°æƒ…å ± -->
    <div class="debug-info" id="debugInfo">
        è¡Œãƒ‡ãƒ¼ã‚¿: 0è¡Œ<br>
        è¡¨ç¤ºè¡Œæ•°: 10è¡Œå›ºå®š<br>
        ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«: ãªã—<br>
        ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³: åœæ­¢
    </div>

<!-- è¨­å®šãƒ‘ãƒãƒ« -->
    <div class="settings-modal" id="settingsModal">
        <div class="settings-panel">
            <div class="settings-header">
                <div>
                    <h2 class="settings-title">è¡¨ç¤ºè¨­å®š</h2>
                    <div style="font-size: 12px; color: #888; margin-top: 4px;">
                        ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆ: Ctrl+, (Windows) / Cmd+, (Mac)
                    </div>
                </div>
                <button class="close-btn" id="closeBtn">Ã—</button>
            </div>
            
            <div class="settings-tabs">
                <button class="tab-btn active" data-tab="display">è¡¨ç¤ºè¨­å®š</button>
                <button class="tab-btn" data-tab="scroll">ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«è¨­å®š</button>
                <button class="tab-btn" data-tab="config">è¨­å®šç®¡ç†</button>
            </div>
            
            <!-- è¡¨ç¤ºè¨­å®šã‚¿ãƒ– -->
            <div class="tab-content active" id="displayTab">
                <div class="setting-group">
                    <label class="setting-label">ãƒ•ã‚©ãƒ³ãƒˆã‚µã‚¤ã‚º</label>
                    <div class="setting-row">
                        <input type="range" class="setting-slider" id="fontSizeSlider" min="12" max="48" value="20">
                        <input type="number" class="setting-input" id="fontSizeInput" min="12" max="48" value="20">
                        <span class="setting-unit">px</span>
                    </div>
                </div>
                
                <div class="setting-group">
                    <label class="setting-label">è¡Œé–“éš”</label>
                    <div class="setting-row">
                        <input type="range" class="setting-slider" id="lineHeightSlider" min="1.0" max="2.5" step="0.1" value="1.6">
                        <input type="number" class="setting-input" id="lineHeightInput" min="1.0" max="2.5" step="0.1" value="1.6">
                        <span class="setting-unit">å€</span>
                    </div>
                </div>
                
                <div class="setting-group">
                    <label class="setting-label">ãƒ•ã‚©ãƒ³ãƒˆãƒ•ã‚§ã‚¤ã‚¹</label>
                    <div class="setting-row">
                        <select class="setting-select" id="fontFamilySelect">
                            <option value="system">ã‚·ã‚¹ãƒ†ãƒ ãƒ•ã‚©ãƒ³ãƒˆ</option>
                            <option value="hiragino">ãƒ’ãƒ©ã‚®ãƒè§’ã‚´</option>
                            <option value="yugothic">Yu Gothic</option>
                            <option value="meiryo">ãƒ¡ã‚¤ãƒªã‚ª</option>
                            <option value="msgothic">MS Gothic</option>
                            <option value="noto">Noto Sans JP</option>
                            <option value="roboto">Roboto</option>
                            <option value="arial">Arial</option>
                            <option value="helvetica">Helvetica</option>
                            <option value="times">Times New Roman</option>
                            <option value="georgia">Georgia</option>
                            <option value="courier">Courier New</option>
                        </select>
                    </div>
                </div>
                
                <div class="setting-group">
                    <label class="setting-label">ãƒ•ã‚©ãƒ³ãƒˆã‚¹ã‚¿ã‚¤ãƒ«</label>
                    <div class="setting-row">
                        <div class="checkbox-wrapper">
                            <input type="checkbox" class="setting-checkbox" id="fontBoldCheck">
                            <label for="fontBoldCheck">ãƒœãƒ¼ãƒ«ãƒ‰ï¼ˆå¤ªå­—ï¼‰</label>
                        </div>
                    </div>
                </div>
                
                <div class="setting-group">
                    <label class="setting-label">å¼·åˆ¶çš„ã«åŠè§’â†’å…¨è§’</label>
                    <div class="setting-row">
                        <div class="checkbox-wrapper">
                            <input type="checkbox" class="setting-checkbox" id="fullWidthCheck">
                            <label for="fullWidthCheck">åŠè§’æ–‡å­—ã‚’å…¨è§’ã«å¤‰æ›</label>
                        </div>
                    </div>
                </div>
                
                <div class="setting-group">
                    <label class="setting-label">ãƒ•ã‚©ãƒ³ãƒˆè‰²</label>
                    <div class="setting-row">
                        <input type="color" class="color-input" id="fontColorPicker" value="#ffffff">
                        <input type="text" class="setting-input" id="fontColorInput" value="#ffffff" style="width: 100px;">
                    </div>
                </div>
                
                <div class="setting-group">
                    <label class="setting-label">èƒŒæ™¯è‰²</label>
                    <div class="setting-row">
                        <input type="color" class="color-input" id="bgColorPicker" value="#000000">
                        <input type="text" class="setting-input" id="bgColorInput" value="#000000" style="width: 100px;">
                    </div>
                </div>
                
                <div class="setting-group">
                    <label class="setting-label">å…¨ç”»é¢è¡¨ç¤º</label>
                    <div class="setting-row">
                        <button id="toggleFullscreenBtn" class="btn btn-primary" style="flex: 1;">
                            å…¨ç”»é¢ãƒ¢ãƒ¼ãƒ‰åˆ‡ã‚Šæ›¿ãˆ (F11)
                        </button>
                    </div>
                    <div style="margin-top: 8px; font-size: 12px; color: #888;">
                        â€» ãƒ˜ãƒƒãƒ€ãƒ¼ã¨ãƒ•ãƒƒã‚¿ãƒ¼ã‚’éè¡¨ç¤ºã«ã—ã¦ã€æ–‡å­—è¡¨ç¤ºã‚¨ãƒªã‚¢ã®ã¿ã‚’å…¨ç”»é¢è¡¨ç¤ºã—ã¾ã™
                    </div>
                </div>
            </div>
            
            <!-- ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«è¨­å®šã‚¿ãƒ– -->
            <div class="tab-content" id="scrollTab">
                <div class="setting-group">
                    <label class="setting-label">ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«é€Ÿåº¦ï¼ˆ1è¡Œã‚ãŸã‚Šï¼‰</label>
                    <div class="setting-row">
                        <input type="range" class="setting-slider" id="scrollSpeedSlider" min="0.3" max="5.0" step="0.1" value="0.8">
                        <input type="number" class="setting-input" id="scrollSpeedInput" min="0.1" max="10.0" step="0.1" value="0.8">
                        <span class="setting-unit">ç§’</span>
                    </div>
                    <div style="margin-top: 8px; font-size: 12px; color: #888;">
                        â€» å€¤ã‚’å¤§ããã™ã‚‹ã¨ã‚†ã£ãã‚Šã€å°ã•ãã™ã‚‹ã¨é€Ÿããªã‚Šã¾ã™ã€‚è¤‡æ•°è¡ŒãŒè¿½åŠ ã•ã‚ŒãŸå ´åˆã‚‚åŒã˜é€Ÿåº¦ã§é€£ç¶šã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã—ã¾ã™ã€‚
                    </div>
                </div>
                
                <div class="setting-group">
                    <label class="setting-label">è¡¨ç¤ºã‚¨ãƒªã‚¢é«˜ã•</label>
                    <div class="setting-row">
                        <input type="range" class="setting-slider" id="visibleHeightSlider" min="100" max="1000" step="10" value="300">
                        <input type="number" class="setting-input" id="visibleHeightInput" min="50" max="2000" step="10" value="300">
                        <span class="setting-unit">px</span>
                    </div>
                    <div style="margin-top: 8px; font-size: 12px; color: #888;">
                        â€» å­—å¹•ãŒè¡¨ç¤ºã•ã‚Œã‚‹é ˜åŸŸã®é«˜ã•ã‚’ãƒ”ã‚¯ã‚»ãƒ«ã§æŒ‡å®šã—ã¾ã™ã€‚ä¸Šéƒ¨ã¯ãƒã‚¹ã‚¯ã§éš ã•ã‚Œã¾ã™ã€‚
                    </div>
                </div>
                
                <div class="setting-group">
                    <label class="setting-label">1è¡Œæ–‡å­—æ•°</label>
                    <div class="setting-row">
                        <input type="range" class="setting-slider" id="charsPerLineSlider" min="10" max="80" value="30">
                        <input type="number" class="setting-input" id="charsPerLineInput" min="1" max="99" value="30">
                        <span class="setting-unit">æ–‡å­—</span>
                    </div>
                </div>
                
                <div class="setting-group">
                    <label class="setting-label">æ”¹è¡Œå‡¦ç†</label>
                    <div class="setting-row">
                        <div class="checkbox-wrapper">
                            <input type="checkbox" class="setting-checkbox" id="removeLineBreaksCheck">
                            <label for="removeLineBreaksCheck">å—ä¿¡ãƒ†ã‚­ã‚¹ãƒˆã®æ”¹è¡Œã‚’ã™ã¹ã¦å‰Šé™¤ã™ã‚‹</label>
                        </div>
                    </div>
                    <div style="margin-top: 12px;">
                        <label style="display: block; margin-bottom: 8px; font-size: 14px; color: #ccc;">å¼·åˆ¶æ”¹è¡Œæ–‡å­—</label>
                        <input type="text" class="setting-input" id="forceLineBreakCharInput" value="â—" style="width: 100px;">
                        <span style="margin-left: 10px; font-size: 12px; color: #888;">â€» ã“ã®æ–‡å­—ã¯æ”¹è¡Œã¨ã—ã¦æ‰±ã‚ã‚Œã¾ã™</span>
                    </div>
                </div>
                
                <div class="setting-group">
                    <label class="setting-label">è¡¨ç¤ºã‚¨ãƒªã‚¢ã®ä½™ç™½</label>
                    <div class="setting-row">
                        <input type="range" class="setting-slider" id="paddingSlider" min="0" max="100" step="5" value="30">
                        <input type="number" class="setting-input" id="paddingInput" min="0" max="200" step="5" value="30">
                        <span class="setting-unit">px</span>
                    </div>
                    <div style="margin-top: 8px; font-size: 12px; color: #888;">
                        â€» å­—å¹•è¡¨ç¤ºã‚¨ãƒªã‚¢ã®ä¸Šä¸‹å·¦å³ã®ä½™ç™½ã‚’è¨­å®šã—ã¾ã™
                    </div>
                </div>
                
                <div class="preview-info" id="previewInfo">
                    ç¾åœ¨ã®è¨­å®šã§ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼è¡¨ç¤ºã•ã‚Œã¦ã„ã¾ã™
                </div>
            </div>
            
            <!-- è¨­å®šç®¡ç†ã‚¿ãƒ– -->
            <div class="tab-content" id="configTab">
                <div class="setting-group">
                    <label class="setting-label">ãƒ‡ãƒãƒƒã‚°æƒ…å ±</label>
                    <div class="setting-row">
                        <div class="checkbox-wrapper">
                            <input type="checkbox" class="setting-checkbox" id="showDebugInfoCheck">
                            <label for="showDebugInfoCheck">ç”»é¢å³ä¸Šã«ãƒ‡ãƒãƒƒã‚°æƒ…å ±ã‚’è¡¨ç¤º</label>
                        </div>
                    </div>
                    <div style="margin-top: 8px; font-size: 12px; color: #888;">
                        â€» è¡Œãƒ‡ãƒ¼ã‚¿æ•°ã€è¡¨ç¤ºè¡Œæ•°ã€ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«çŠ¶æ…‹ãªã©ã®æƒ…å ±ã‚’è¡¨ç¤ºã—ã¾ã™
                    </div>
                </div>
                
                <div class="setting-group">
                    <label class="setting-label">è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«</label>
                    <div class="setting-row">
                        <label for="configFile" class="file-label">ğŸ“ è¨­å®šã‚’èª­ã¿è¾¼ã¿</label>
                        <input type="file" class="file-input" id="configFile" accept=".json">
                    </div>
                </div>
                
                <div class="settings-actions">
                    <button class="btn btn-primary" id="saveConfigBtn">ğŸ’¾ è¨­å®šã‚’ä¿å­˜</button>
                    <button class="btn btn-secondary" id="downloadConfigBtn">ğŸ“¥ è¨­å®šã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</button>
                    <button class="btn btn-danger" id="resetConfigBtn">ğŸ”„ è¨­å®šã‚’ãƒªã‚»ãƒƒãƒˆ</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        console.log('=== è¨­å®šãƒ‘ãƒãƒ«æ©Ÿèƒ½ä»˜ãdisplay.html é–‹å§‹ ===');
        
        // DOMè¦ç´ ã®å–å¾—
        const statusIndicator = document.getElementById('statusIndicator');
        const connectionText = document.getElementById('connectionText');
        const textDisplayArea = document.getElementById('textDisplayArea');
        const textLines = document.getElementById('textLines');
        const topMask = document.getElementById('topMask');
        const currentTime = document.getElementById('currentTime');
        const operatorUrl = document.getElementById('operatorUrl');
        const debugInfo = document.getElementById('debugInfo');
        
        // è¨­å®šãƒ‘ãƒãƒ«è¦ç´ 
        const settingsBtn = document.getElementById('settingsBtn');
        const settingsModal = document.getElementById('settingsModal');
        const closeBtn = document.getElementById('closeBtn');
        
        // ãƒ†ã‚­ã‚¹ãƒˆç®¡ç†
        let textLineArray = [];
        let hasMessages = false;
        let isAnimating = false;
        
        // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã«è¾æ›¸ã‚’ä¿å­˜
        let spacedNamesDictionary = [];
        
        // è¨­å®šã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
        const settings = {
            fontSize: 20,
            lineHeight: 1.6,
            fontFamily: 'system',
            fontBold: false,
            fontColor: '#ffffff',
            backgroundColor: '#000000',
            maxCharsPerLine: 30,
            visibleHeightPixels: 300,  // è¡¨ç¤ºã‚¨ãƒªã‚¢ã®é«˜ã•ï¼ˆãƒ”ã‚¯ã‚»ãƒ«ï¼‰
            animationDuration: 0.8,
            fullWidthMode: false,
            showDebugInfo: false,
            removeLineBreaks: false,
            forceLineBreakChar: 'â—',
            paddingPixels: 30  // ä½™ç™½ï¼ˆãƒ”ã‚¯ã‚»ãƒ«ï¼‰
        };
        
        // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè¨­å®š
        const defaultSettings = { ...settings };
        
        // è¨­å®šã®èª­ã¿è¾¼ã¿
        function loadSettings() {
            try {
                const saved = localStorage.getItem('displaySettings');
                if (saved) {
                    const parsed = JSON.parse(saved);
                    Object.assign(settings, parsed);
                    console.log('è¨­å®šã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ:', settings);
                }
            } catch (error) {
                console.error('è¨­å®šã®èª­ã¿è¾¼ã¿ã«å¤±æ•—:', error);
            }
        }
        
        // è¨­å®šã®ä¿å­˜
        function saveSettings() {
            try {
                localStorage.setItem('displaySettings', JSON.stringify(settings));
                console.log('è¨­å®šã‚’ä¿å­˜ã—ã¾ã—ãŸ:', settings);
            } catch (error) {
                console.error('è¨­å®šã®ä¿å­˜ã«å¤±æ•—:', error);
            }
        }
        
        // è¨­å®šã‚’UIã«åæ˜ 
        function updateSettingsUI() {
            // ãƒ•ã‚©ãƒ³ãƒˆè¨­å®š
            document.getElementById('fontSizeSlider').value = settings.fontSize;
            document.getElementById('fontSizeInput').value = settings.fontSize;
            document.getElementById('lineHeightSlider').value = settings.lineHeight;
            document.getElementById('lineHeightInput').value = settings.lineHeight;
            document.getElementById('fontFamilySelect').value = settings.fontFamily;
            document.getElementById('fontBoldCheck').checked = settings.fontBold;
            document.getElementById('fontColorPicker').value = settings.fontColor;
            document.getElementById('fontColorInput').value = settings.fontColor;
            document.getElementById('bgColorPicker').value = settings.backgroundColor;
            document.getElementById('bgColorInput').value = settings.backgroundColor;
            
            // ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«è¨­å®š
            document.getElementById('scrollSpeedSlider').value = settings.animationDuration;
            document.getElementById('scrollSpeedInput').value = settings.animationDuration;
            document.getElementById('visibleHeightSlider').value = settings.visibleHeightPixels;
            document.getElementById('visibleHeightInput').value = settings.visibleHeightPixels;
            document.getElementById('charsPerLineSlider').value = settings.maxCharsPerLine;
            document.getElementById('charsPerLineInput').value = settings.maxCharsPerLine;
            
            // å…¨è§’å¤‰æ›è¨­å®š
            document.getElementById('fullWidthCheck').checked = settings.fullWidthMode;
            
            // ãƒ‡ãƒãƒƒã‚°æƒ…å ±è¡¨ç¤ºè¨­å®š
            document.getElementById('showDebugInfoCheck').checked = settings.showDebugInfo;
            
            // æ”¹è¡Œå‡¦ç†è¨­å®š
            document.getElementById('removeLineBreaksCheck').checked = settings.removeLineBreaks;
            document.getElementById('forceLineBreakCharInput').value = settings.forceLineBreakChar;
            
            // ä½™ç™½è¨­å®š
            document.getElementById('paddingSlider').value = settings.paddingPixels;
            document.getElementById('paddingInput').value = settings.paddingPixels;
        }
        
        // ãƒ•ã‚©ãƒ³ãƒˆãƒ•ã‚¡ãƒŸãƒªãƒ¼ã®ãƒãƒƒãƒ”ãƒ³ã‚°
        const fontFamilyMap = {
            system: '"Hiragino Kaku Gothic ProN", "Hiragino Sans", "Yu Gothic Medium", "Meiryo", "MS Gothic", sans-serif',
            hiragino: '"Hiragino Kaku Gothic ProN", "Hiragino Sans", sans-serif',
            yugothic: '"Yu Gothic Medium", "Yu Gothic", "YuGothic", sans-serif',
            meiryo: '"Meiryo", "ãƒ¡ã‚¤ãƒªã‚ª", sans-serif',
            msgothic: '"MS Gothic", "ï¼­ï¼³ ã‚´ã‚·ãƒƒã‚¯", monospace',
            noto: '"Noto Sans JP", sans-serif',
            roboto: '"Roboto", sans-serif',
            arial: '"Arial", sans-serif',
            helvetica: '"Helvetica Neue", "Helvetica", sans-serif',
            times: '"Times New Roman", "Times", serif',
            georgia: '"Georgia", serif',
            courier: '"Courier New", "Courier", monospace'
        };
        
        // è¡¨ç¤ºã‚¹ã‚¿ã‚¤ãƒ«ã‚’æ›´æ–°
        function updateDisplayStyle() {
            // ãƒ•ã‚©ãƒ³ãƒˆè¨­å®š
            textLines.style.fontSize = settings.fontSize + 'px';
            textLines.style.lineHeight = settings.lineHeight;
            textLines.style.fontFamily = fontFamilyMap[settings.fontFamily] || fontFamilyMap.system;
            textLines.style.fontWeight = settings.fontBold ? 'bold' : 'normal';
            textLines.style.color = settings.fontColor;
            
            // èƒŒæ™¯è‰²
            document.body.style.backgroundColor = settings.backgroundColor;
            textDisplayArea.style.backgroundColor = settings.backgroundColor;
            topMask.style.backgroundColor = settings.backgroundColor;
            
            // ä½™ç™½è¨­å®š
            textDisplayArea.style.padding = `${settings.paddingPixels}px`;
            
            // ä¸Šéƒ¨ãƒã‚¹ã‚¯ã®é«˜ã•ã‚’æ›´æ–°ï¼ˆè¡¨ç¤ºè¡Œæ•°åˆ¶å¾¡ï¼‰
            updateTopMask();
            
            // ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã®æ™‚é–“ã‚‚æ›´æ–°
            textLines.style.transition = `transform ${settings.animationDuration}s linear`;
            
            // ãƒ‡ãƒãƒƒã‚°æƒ…å ±ã®è¡¨ç¤º/éè¡¨ç¤º
            debugInfo.style.display = settings.showDebugInfo ? 'block' : 'none';
            
            console.log('è¡¨ç¤ºã‚¹ã‚¿ã‚¤ãƒ«ã‚’æ›´æ–°:', {
                fontSize: settings.fontSize,
                lineHeight: settings.lineHeight,
                fontFamily: settings.fontFamily,
                fontBold: settings.fontBold,
                fontColor: settings.fontColor,
                backgroundColor: settings.backgroundColor,
                visibleHeightPixels: settings.visibleHeightPixels,
                animationDuration: settings.animationDuration,
                showDebugInfo: settings.showDebugInfo
            });
        }
        
        // ä¸Šéƒ¨ãƒã‚¹ã‚¯ã®é«˜ã•ã‚’æ›´æ–°
        function updateTopMask() {
            // text-display-areaã®å®Ÿéš›ã®é«˜ã•ã‚’å–å¾—
            const containerHeight = textDisplayArea.clientHeight;
            
            // è¡¨ç¤ºã—ãŸã„é«˜ã•ï¼ˆè¨­å®šå€¤ï¼‰
            const visibleHeight = settings.visibleHeightPixels;
            
            // ãƒã‚¹ã‚¯ã®é«˜ã• = ã‚³ãƒ³ãƒ†ãƒŠå…¨ä½“ã®é«˜ã• - è¡¨ç¤ºã—ãŸã„é«˜ã•
            const maskHeight = Math.max(0, containerHeight - visibleHeight);
            
            topMask.style.height = `${maskHeight}px`;
            
            console.log(`ãƒã‚¹ã‚¯æ›´æ–°: ã‚³ãƒ³ãƒ†ãƒŠ${containerHeight}px - è¡¨ç¤º${visibleHeight}px = ãƒã‚¹ã‚¯${maskHeight}px`);
        }
        
        // è¨­å®šãƒ‘ãƒãƒ«ã®åˆæœŸåŒ–
        function initSettingsPanel() {
            // ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆ
            const tabBtns = document.querySelectorAll('.tab-btn');
            const tabContents = document.querySelectorAll('.tab-content');
            
            tabBtns.forEach(btn => {
                btn.addEventListener('click', () => {
                    const targetTab = btn.getAttribute('data-tab');
                    
                    tabBtns.forEach(b => b.classList.remove('active'));
                    tabContents.forEach(c => c.classList.remove('active'));
                    
                    btn.classList.add('active');
                    document.getElementById(targetTab + 'Tab').classList.add('active');
                });
            });
            
            // è¨­å®šå€¤ã®åŒæœŸé–¢æ•°
            function syncSliderInput(sliderId, inputId, settingKey) {
                const slider = document.getElementById(sliderId);
                const input = document.getElementById(inputId);
                
                slider.addEventListener('input', () => {
                    const value = parseFloat(slider.value);
                    input.value = value;
                    settings[settingKey] = value;
                    updateDisplayStyle();
                    saveSettings();
                });
                
                input.addEventListener('change', () => {
                    const value = parseFloat(input.value);
                    if (!isNaN(value)) {
                        slider.value = value;
                        settings[settingKey] = value;
                        updateDisplayStyle();
                        saveSettings();
                    }
                });
            }
            
            // å„è¨­å®šã®åŒæœŸ
            syncSliderInput('fontSizeSlider', 'fontSizeInput', 'fontSize');
            syncSliderInput('lineHeightSlider', 'lineHeightInput', 'lineHeight');
            syncSliderInput('scrollSpeedSlider', 'scrollSpeedInput', 'animationDuration');
            syncSliderInput('visibleHeightSlider', 'visibleHeightInput', 'visibleHeightPixels');
            syncSliderInput('charsPerLineSlider', 'charsPerLineInput', 'maxCharsPerLine');
            syncSliderInput('paddingSlider', 'paddingInput', 'paddingPixels');
            
            // ãƒ•ã‚©ãƒ³ãƒˆãƒ•ã‚§ã‚¤ã‚¹é¸æŠ
            document.getElementById('fontFamilySelect').addEventListener('change', (e) => {
                settings.fontFamily = e.target.value;
                updateDisplayStyle();
                saveSettings();
            });
            
            // ãƒœãƒ¼ãƒ«ãƒ‰è¨­å®š
            document.getElementById('fontBoldCheck').addEventListener('change', (e) => {
                settings.fontBold = e.target.checked;
                updateDisplayStyle();
                saveSettings();
            });
            
            // ãƒ•ã‚©ãƒ³ãƒˆè‰²è¨­å®š
            function syncColorInputs(pickerId, inputId, settingKey) {
                const picker = document.getElementById(pickerId);
                const input = document.getElementById(inputId);
                
                picker.addEventListener('input', () => {
                    const color = picker.value;
                    input.value = color;
                    settings[settingKey] = color;
                    updateDisplayStyle();
                    saveSettings();
                });
                
                input.addEventListener('change', () => {
                    const color = input.value;
                    if (/^#[0-9A-F]{6}$/i.test(color)) {
                        picker.value = color;
                        settings[settingKey] = color;
                        updateDisplayStyle();
                        saveSettings();
                    }
                });
            }
            
            syncColorInputs('fontColorPicker', 'fontColorInput', 'fontColor');
            syncColorInputs('bgColorPicker', 'bgColorInput', 'backgroundColor');
            
            // å…¨è§’å¤‰æ›ãƒ¢ãƒ¼ãƒ‰è¨­å®š
            document.getElementById('fullWidthCheck').addEventListener('change', (e) => {
                settings.fullWidthMode = e.target.checked;
                saveSettings();
                
                // æ—¢å­˜ãƒ†ã‚­ã‚¹ãƒˆã«ã‚‚é©ç”¨ã™ã‚‹å ´åˆã¯å†æç”»
                if (textLineArray.length > 0) {
                    updateDisplay();
                }
            });
            
            // ãƒ‡ãƒãƒƒã‚°æƒ…å ±è¡¨ç¤ºã®åˆ‡ã‚Šæ›¿ãˆ
            document.getElementById('showDebugInfoCheck').addEventListener('change', (e) => {
                settings.showDebugInfo = e.target.checked;
                debugInfo.style.display = settings.showDebugInfo ? 'block' : 'none';
                saveSettings();
            });
            
            // æ”¹è¡Œå‡¦ç†è¨­å®šã®åˆ‡ã‚Šæ›¿ãˆ
            document.getElementById('removeLineBreaksCheck').addEventListener('change', (e) => {
                settings.removeLineBreaks = e.target.checked;
                saveSettings();
                console.log('æ”¹è¡Œå‰Šé™¤è¨­å®š:', settings.removeLineBreaks);
            });
            
            document.getElementById('forceLineBreakCharInput').addEventListener('input', (e) => {
                settings.forceLineBreakChar = e.target.value;
                saveSettings();
                console.log('å¼·åˆ¶æ”¹è¡Œæ–‡å­—:', settings.forceLineBreakChar);
            });
            
            // è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿
            document.getElementById('configFile').addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        try {
                            const config = JSON.parse(e.target.result);
                            Object.assign(settings, config);
                            updateSettingsUI();
                            updateDisplayStyle();
                            saveSettings();
                            alert('è¨­å®šã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ');
                        } catch (error) {
                            alert('è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ');
                        }
                    };
                    reader.readAsText(file);
                }
            });
            
            // è¨­å®šã®ä¿å­˜
            document.getElementById('saveConfigBtn').addEventListener('click', () => {
                saveSettings();
                alert('è¨­å®šã‚’ä¿å­˜ã—ã¾ã—ãŸ');
            });
            
            // è¨­å®šã®ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
            document.getElementById('downloadConfigBtn').addEventListener('click', () => {
                const config = JSON.stringify(settings, null, 2);
                const blob = new Blob([config], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'display_settings.json';
                a.click();
                URL.revokeObjectURL(url);
            });
            
            // è¨­å®šã®ãƒªã‚»ãƒƒãƒˆ
            document.getElementById('resetConfigBtn').addEventListener('click', () => {
                if (confirm('è¨­å®šã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã‹ï¼Ÿ')) {
                    Object.assign(settings, defaultSettings);
                    updateSettingsUI();
                    updateDisplayStyle();
                    saveSettings();
                    alert('è¨­å®šã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã—ãŸ');
                }
            });
        }
        
        // ãƒ‘ãƒãƒ«ã®è¡¨ç¤º/éè¡¨ç¤º
        settingsBtn.addEventListener('click', () => {
            settingsModal.style.display = 'block';
        });
        
        closeBtn.addEventListener('click', () => {
            settingsModal.style.display = 'none';
        });
        
        // ãƒ‰ãƒ©ãƒƒã‚°æ©Ÿèƒ½
        let isDragging = false;
        let currentX;
        let currentY;
        let initialX;
        let initialY;
        let xOffset = 0;
        let yOffset = 0;
        
        const settingsHeader = settingsModal.querySelector('.settings-header');
        
        // ä½ç½®ã®èª­ã¿è¾¼ã¿
        function loadModalPosition() {
            try {
                const saved = localStorage.getItem('settingsModalPosition');
                if (saved) {
                    const position = JSON.parse(saved);
                    xOffset = position.x;
                    yOffset = position.y;
                    setModalPosition(xOffset, yOffset);
                } else {
                    // åˆæœŸä½ç½®ï¼šç”»é¢å³ç«¯
                    const initialX = window.innerWidth - 500; // ãƒ¢ãƒ¼ãƒ€ãƒ«å¹…500px
                    xOffset = initialX;
                    yOffset = 0;
                    setModalPosition(xOffset, yOffset);
                }
            } catch (error) {
                console.error('è¨­å®šãƒ¢ãƒ¼ãƒ€ãƒ«ä½ç½®ã®èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
            }
        }
        
        // ä½ç½®ã®ä¿å­˜
        function saveModalPosition() {
            try {
                localStorage.setItem('settingsModalPosition', JSON.stringify({
                    x: xOffset,
                    y: yOffset
                }));
            } catch (error) {
                console.error('è¨­å®šãƒ¢ãƒ¼ãƒ€ãƒ«ä½ç½®ã®ä¿å­˜ã‚¨ãƒ©ãƒ¼:', error);
            }
        }
        
        // ãƒ¢ãƒ¼ãƒ€ãƒ«ã®ä½ç½®ã‚’è¨­å®š
        function setModalPosition(x, y) {
            settingsModal.style.right = 'auto';
            settingsModal.style.top = 'auto';
            settingsModal.style.left = x + 'px';
            settingsModal.style.top = y + 'px';
        }
        
        settingsHeader.addEventListener('mousedown', dragStart);
        document.addEventListener('mousemove', drag);
        document.addEventListener('mouseup', dragEnd);
        
        function dragStart(e) {
            initialX = e.clientX - xOffset;
            initialY = e.clientY - yOffset;
            
            if (e.target === settingsHeader || settingsHeader.contains(e.target)) {
                // é–‰ã˜ã‚‹ãƒœã‚¿ãƒ³ã¯ãƒ‰ãƒ©ãƒƒã‚°å¯¾è±¡å¤–
                if (!e.target.closest('.close-btn')) {
                    isDragging = true;
                }
            }
        }
        
        function drag(e) {
            if (isDragging) {
                e.preventDefault();
                
                currentX = e.clientX - initialX;
                currentY = e.clientY - initialY;
                
                xOffset = currentX;
                yOffset = currentY;
                
                setModalPosition(currentX, currentY);
            }
        }
        
        function dragEnd(e) {
            if (isDragging) {
                initialX = currentX;
                initialY = currentY;
                isDragging = false;
                saveModalPosition();
            }
        }
        
        // åˆæœŸä½ç½®ã‚’èª­ã¿è¾¼ã¿
        loadModalPosition();
        
        // ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆã‚­ãƒ¼ã§è¨­å®šãƒ‘ãƒãƒ«ã‚’é–‹é–‰ï¼ˆCtrl+, ã¾ãŸã¯ Cmd+,ï¼‰
        document.addEventListener('keydown', (e) => {
            // Ctrl+, ã¾ãŸã¯ Cmd+, ï¼ˆmacOSï¼‰
            if ((e.ctrlKey || e.metaKey) && e.key === ',') {
                e.preventDefault();
                // è¨­å®šãƒ‘ãƒãƒ«ã®è¡¨ç¤ºã‚’åˆ‡ã‚Šæ›¿ãˆ
                if (settingsModal.style.display === 'block') {
                    settingsModal.style.display = 'none';
                    console.log('è¨­å®šãƒ‘ãƒãƒ«ã‚’é–‰ã˜ã¾ã—ãŸï¼ˆã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆã‚­ãƒ¼ï¼‰');
                } else {
                    settingsModal.style.display = 'block';
                    console.log('è¨­å®šãƒ‘ãƒãƒ«ã‚’é–‹ãã¾ã—ãŸï¼ˆã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆã‚­ãƒ¼: Ctrl+, ã¾ãŸã¯ Cmd+,ï¼‰');
                }
            }
        });
        
        // å…¨ç”»é¢è¡¨ç¤ºãƒœã‚¿ãƒ³
        const toggleFullscreenBtn = document.getElementById('toggleFullscreenBtn');
        toggleFullscreenBtn.addEventListener('click', () => {
            toggleFullscreenMode();
            settingsModal.style.display = 'none';
        });
        
        // ç¾åœ¨æ™‚åˆ»ã®è¡¨ç¤ºæ›´æ–°
        function updateCurrentTime() {
            const now = new Date();
            currentTime.textContent = now.toLocaleTimeString('ja-JP');
        }
        
        updateCurrentTime();
        setInterval(updateCurrentTime, 1000);
        
        // ã‚ªãƒšãƒ¬ãƒ¼ã‚¿ãƒ¼ç”»é¢ã®URLã‚’è¡¨ç¤º
        operatorUrl.textContent = window.location.origin + '/';
        
        // ãƒ‡ãƒãƒƒã‚°æƒ…å ±æ›´æ–°
        function updateDebugInfo() {
            const totalLines = textLineArray.length;
            const visibleLines = Math.min(totalLines, settings.maxVisibleLines);
            const needsScroll = totalLines > settings.maxVisibleLines;
            const animStatus = isAnimating ? 'å®Ÿè¡Œä¸­' : 'åœæ­¢';
            
            debugInfo.innerHTML = `è¡Œãƒ‡ãƒ¼ã‚¿: ${totalLines}è¡Œ<br>è¡¨ç¤ºè¡Œæ•°: ${visibleLines}/${settings.maxVisibleLines}è¡Œ<br>ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«: ${needsScroll ? 'ã‚ã‚Š' : 'ãªã—'}<br>ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³: ${animStatus}`;
        }
        
        // å…¨è§’æ–‡å­—åˆ¤å®š
        function isFullWidth(char) {
            const code = char.charCodeAt(0);
            return (code >= 0x3000 && code <= 0x9FAF) || 
                   (code >= 0xFF01 && code <= 0xFF5E) || 
                   (code >= 0xFF61 && code <= 0xFF9F);
        }
        
        // TSVè¾æ›¸ãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿
        async function loadSpacedNamesDictionary() {
            try {
                const response = await fetch('/spaced-names-dictionary.tsv');
                const tsvText = await response.text();
                
                // TSVã‚’ãƒ‘ãƒ¼ã‚¹
                const lines = tsvText.trim().split('\n');
                const headers = lines[0].split('\t'); // ãƒ˜ãƒƒãƒ€ãƒ¼è¡Œã‚’ã‚¹ã‚­ãƒƒãƒ—
                
                spacedNamesDictionary = [];
                
                for (let i = 1; i < lines.length; i++) {
                    const columns = lines[i].split('\t');
                    if (columns.length >= 2) {
                        const category = columns[0].trim();
                        const name = columns[1].trim();
                        spacedNamesDictionary.push(name);
                    }
                }
                
                console.log(`ã‚¹ãƒšãƒ¼ã‚¹ä»˜ãå›ºæœ‰åè©è¾æ›¸ã‚’èª­ã¿è¾¼ã¿: ${spacedNamesDictionary.length}ä»¶`);
                
            } catch (error) {
                console.error('è¾æ›¸ãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿å¤±æ•—:', error);
                // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: åŸºæœ¬çš„ãªåè©ã®ã¿
                spacedNamesDictionary = [
                    'ãƒ‹ãƒ¥ãƒ¼ ãƒ¨ãƒ¼ã‚¯',
                    'ãƒ‰ãƒŠãƒ«ãƒ‰ ãƒˆãƒ©ãƒ³ãƒ—',
                    'ãƒã‚¤ã‚¯ãƒ­ã‚½ãƒ•ãƒˆ ã‚ªãƒ•ã‚£ã‚¹'
                ];
            }
        }
        
        // ä¿®æ­£ã•ã‚ŒãŸã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—é–¢æ•°
        function cleanupSpeechText(text) {
            // è¾æ›¸ãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ãªã„å ´åˆã¯åŸºæœ¬å‡¦ç†ã®ã¿
            if (spacedNamesDictionary.length === 0) {
                return basicCleanup(text);
            }
            
            // æ­£å½“ãªã‚¹ãƒšãƒ¼ã‚¹ä»˜ãåè©ã‚’ä¸€æ™‚çš„ã«ä¿è­·
            const protected = [];
            let protectedText = text;
            
            spacedNamesDictionary.forEach((name, index) => {
                const placeholder = `__PROTECTED_${index}__`;
                if (protectedText.includes(name)) {
                    protected[index] = name;
                    protectedText = protectedText.replace(new RegExp(escapeRegex(name), 'g'), placeholder);
                }
            });
            
            // é€šå¸¸ã®ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ã‚’å®Ÿè¡Œ
            let cleaned = basicCleanup(protectedText);
            
            // ä¿è­·ã—ãŸåè©ã‚’å¾©å…ƒ
            protected.forEach((name, index) => {
                if (name) {
                    cleaned = cleaned.replace(`__PROTECTED_${index}__`, name);
                }
            });
            
            console.log('ãƒ†ã‚­ã‚¹ãƒˆã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—:', {
                original: text.substring(0, 50) + '...',
                cleaned: cleaned.substring(0, 50) + '...'
            });
            
            return cleaned;
        }
        
        // åŸºæœ¬çš„ãªã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—å‡¦ç†
        function basicCleanup(text) {
            let cleaned = text;
            cleaned = cleaned.replace(/([ã-ã‚“ã‚¡-ãƒ¿ä¸€-é¾¯]) +([a-zA-Z0-9])/g, '$1$2');
            cleaned = cleaned.replace(/([a-zA-Z0-9]) +([ã-ã‚“ã‚¡-ãƒ¿ä¸€-é¾¯])/g, '$1$2');
            cleaned = cleaned.replace(/([ã-ã‚“ã‚¡-ãƒ¿ä¸€-é¾¯]) +([ã-ã‚“ã‚¡-ãƒ¿ä¸€-é¾¯])/g, '$1$2');
            return cleaned;
        }
        
        // æ­£è¦è¡¨ç¾ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—
        function escapeRegex(string) {
            return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
        }
        
        // åŠè§’æ–‡å­—ã‚’å…¨è§’ã«å¤‰æ›ï¼ˆåŠè§’ã‚«ãƒŠå¯¾å¿œç‰ˆï¼‰
        function convertToFullWidth(text) {
            // åŠè§’ã‚«ãƒŠã‹ã‚‰å…¨è§’ã‚«ãƒŠã¸ã®å¤‰æ›ãƒãƒƒãƒ—
            const halfToFullKanaMap = {
                'ï½±': 'ã‚¢', 'ï½²': 'ã‚¤', 'ï½³': 'ã‚¦', 'ï½´': 'ã‚¨', 'ï½µ': 'ã‚ª',
                'ï½¶': 'ã‚«', 'ï½·': 'ã‚­', 'ï½¸': 'ã‚¯', 'ï½¹': 'ã‚±', 'ï½º': 'ã‚³',
                'ï½»': 'ã‚µ', 'ï½¼': 'ã‚·', 'ï½½': 'ã‚¹', 'ï½¾': 'ã‚»', 'ï½¿': 'ã‚½',
                'ï¾€': 'ã‚¿', 'ï¾': 'ãƒ', 'ï¾‚': 'ãƒ„', 'ï¾ƒ': 'ãƒ†', 'ï¾„': 'ãƒˆ',
                'ï¾…': 'ãƒŠ', 'ï¾†': 'ãƒ‹', 'ï¾‡': 'ãƒŒ', 'ï¾ˆ': 'ãƒ', 'ï¾‰': 'ãƒ',
                'ï¾Š': 'ãƒ', 'ï¾‹': 'ãƒ’', 'ï¾Œ': 'ãƒ•', 'ï¾': 'ãƒ˜', 'ï¾': 'ãƒ›',
                'ï¾': 'ãƒ', 'ï¾': 'ãƒŸ', 'ï¾‘': 'ãƒ ', 'ï¾’': 'ãƒ¡', 'ï¾“': 'ãƒ¢',
                'ï¾”': 'ãƒ¤', 'ï¾•': 'ãƒ¦', 'ï¾–': 'ãƒ¨',
                'ï¾—': 'ãƒ©', 'ï¾˜': 'ãƒª', 'ï¾™': 'ãƒ«', 'ï¾š': 'ãƒ¬', 'ï¾›': 'ãƒ­',
                'ï¾œ': 'ãƒ¯', 'ï½¦': 'ãƒ²', 'ï¾': 'ãƒ³',
                'ï½§': 'ã‚¡', 'ï½¨': 'ã‚£', 'ï½©': 'ã‚¥', 'ï½ª': 'ã‚§', 'ï½«': 'ã‚©',
                'ï½¬': 'ãƒ£', 'ï½­': 'ãƒ¥', 'ï½®': 'ãƒ§', 'ï½¯': 'ãƒƒ',
                'ï½¡': 'ã€‚', 'ï½¢': 'ã€Œ', 'ï½£': 'ã€', 'ï½¤': 'ã€', 'ï½¥': 'ãƒ»',
                'ï¾': 'ã‚›', 'ï¾Ÿ': 'ã‚œ'
            };
            
            let converted = text;
            
            // 1. åŠè§’ã‚«ãƒŠã®æ¿éŸ³ãƒ»åŠæ¿éŸ³ã‚’å…ˆã«å‡¦ç†
            converted = converted.replace(/(ï½¶|ï½·|ï½¸|ï½¹|ï½º|ï½»|ï½¼|ï½½|ï½¾|ï½¿|ï¾€|ï¾|ï¾‚|ï¾ƒ|ï¾„|ï¾Š|ï¾‹|ï¾Œ|ï¾|ï¾)ï¾/g, function(match, char) {
                const dakutenMap = {
                    'ï½¶': 'ã‚¬', 'ï½·': 'ã‚®', 'ï½¸': 'ã‚°', 'ï½¹': 'ã‚²', 'ï½º': 'ã‚´',
                    'ï½»': 'ã‚¶', 'ï½¼': 'ã‚¸', 'ï½½': 'ã‚º', 'ï½¾': 'ã‚¼', 'ï½¿': 'ã‚¾',
                    'ï¾€': 'ãƒ€', 'ï¾': 'ãƒ‚', 'ï¾‚': 'ãƒ…', 'ï¾ƒ': 'ãƒ‡', 'ï¾„': 'ãƒ‰',
                    'ï¾Š': 'ãƒ', 'ï¾‹': 'ãƒ“', 'ï¾Œ': 'ãƒ–', 'ï¾': 'ãƒ™', 'ï¾': 'ãƒœ'
                };
                return dakutenMap[char] || match;
            });
            
            converted = converted.replace(/(ï¾Š|ï¾‹|ï¾Œ|ï¾|ï¾)ï¾Ÿ/g, function(match, char) {
                const handakutenMap = {
                    'ï¾Š': 'ãƒ‘', 'ï¾‹': 'ãƒ”', 'ï¾Œ': 'ãƒ—', 'ï¾': 'ãƒš', 'ï¾': 'ãƒ'
                };
                return handakutenMap[char] || match;
            });
            
            // 2. æ®‹ã‚Šã®åŠè§’ã‚«ãƒŠã‚’å…¨è§’ã‚«ãƒŠã«å¤‰æ›
            converted = converted.replace(/[ï½¦-ï¾Ÿ]/g, function(char) {
                return halfToFullKanaMap[char] || char;
            });
            
            // 3. ASCIIæ–‡å­—ï¼ˆè‹±æ•°å­—è¨˜å·ï¼‰ã‚’å…¨è§’ã«å¤‰æ›
            converted = converted.replace(/[!-~]/g, function(char) {
                return String.fromCharCode(char.charCodeAt(0) + 0xFEE0);
            });
            
            return converted;
        }
        
        // ãƒ†ã‚­ã‚¹ãƒˆã‚’è¡Œã«åˆ†å‰²
        // æ”¹è‰¯ç‰ˆ: å˜èªå¢ƒç•Œã‚’è€ƒæ…®ã—ãŸæ”¹è¡Œå‡¦ç†
        function splitTextIntoLines(text) {
            const lines = text.split('\n');
            const resultLines = [];
            
            for (const line of lines) {
                if (line.length === 0) {
                    resultLines.push('');
                    continue;
                }
                
                // æ”¹è¡Œå‡¦ç†ã‚’å®Ÿè¡Œ
                const brokenLines = smartLineBreak(line, settings.maxCharsPerLine);
                resultLines.push(...brokenLines);
            }
            
            return resultLines;
        }
        
        // ã‚¹ãƒãƒ¼ãƒˆæ”¹è¡Œå‡¦ç†ã®ãƒ¡ã‚¤ãƒ³é–¢æ•°
        function smartLineBreak(text, maxCharsPerLine) {
            const maxWidth = maxCharsPerLine * 2; // å…¨è§’åŸºæº–
            const segments = tokenizeText(text);
            const resultLines = [];
            let currentLine = '';
            let currentWidth = 0;
            
            for (const segment of segments) {
                const segmentWidth = calculateTextWidth(segment.text);
                
                // è‹±æ•°å­—ã®å˜èªã®å ´åˆã¯å˜èªå˜ä½ã§æ”¹è¡Œã‚’åˆ¤æ–­
                if (segment.type === 'word' || segment.type === 'unit') {
                    if (currentWidth + segmentWidth <= maxWidth) {
                        // ç¾åœ¨ã®è¡Œã«åã¾ã‚‹å ´åˆã¯è¿½åŠ 
                        currentLine += segment.text;
                        currentWidth += segmentWidth;
                    } else {
                        // ç¾åœ¨ã®è¡Œã«åã¾ã‚‰ãªã„å ´åˆ
                        if (currentLine.trim()) {
                            resultLines.push(currentLine.trim());
                        }
                        
                        // ã‚»ã‚°ãƒ¡ãƒ³ãƒˆãŒ1è¡Œã®å¹…ã‚’è¶…ãˆã‚‹å ´åˆã¯æ–‡å­—å˜ä½ã§åˆ†å‰²
                        if (segmentWidth > maxWidth) {
                            const forceBrokenLines = forceBreakLongSegment(segment.text, maxWidth);
                            resultLines.push(...forceBrokenLines.slice(0, -1));
                            
                            const lastLine = forceBrokenLines[forceBrokenLines.length - 1];
                            currentLine = lastLine;
                            currentWidth = calculateTextWidth(lastLine);
                        } else {
                            // ã‚»ã‚°ãƒ¡ãƒ³ãƒˆå…¨ä½“ã‚’æ¬¡ã®è¡Œã«
                            currentLine = segment.text;
                            currentWidth = segmentWidth;
                        }
                    }
                } else {
                    // æ—¥æœ¬èªã‚„ã‚¹ãƒšãƒ¼ã‚¹ã®å ´åˆã¯æ–‡å­—å˜ä½ã§è‡ªç”±ã«æŠ˜ã‚Šè¿”ã™
                    for (const char of segment.text) {
                        const charWidth = isFullWidth(char) ? 2 : 1;
                        
                        if (currentWidth + charWidth <= maxWidth) {
                            currentLine += char;
                            currentWidth += charWidth;
                        } else {
                            // è¡ŒãŒæº€æ¯ã«ãªã£ãŸã‚‰æ”¹è¡Œ
                            if (currentLine.trim()) {
                                resultLines.push(currentLine.trim());
                            }
                            currentLine = char;
                            currentWidth = charWidth;
                        }
                    }
                }
            }
            
            if (currentLine.trim()) {
                resultLines.push(currentLine.trim());
            }
            
            return resultLines.length > 0 ? resultLines : [''];
        }
        
        // ãƒ†ã‚­ã‚¹ãƒˆã‚’ã‚»ã‚°ãƒ¡ãƒ³ãƒˆã«åˆ†å‰²
        function tokenizeText(text) {
            const segments = [];
            // åŠè§’ãƒ»å…¨è§’ã®è‹±æ•°å­—ã‚’å˜èªã¨ã—ã¦èªè­˜
            const regex = /([0-9]+[å¹´æœˆæ—¥æ™‚åˆ†ç§’å°æ£Ÿå€‹äººåæšå›åº¦ç•ªç›®éšå±¤ç­‰ä»¶æœ¬åŒ¹é ­ç¾½æ¯ã¤ä¸å†Šå·»è©±æœŸä»£ä¸–ç´€]|[a-zA-Z0-9ï½-ï½šï¼¡-ï¼ºï¼-ï¼™]+(?:\.[a-zA-Z0-9ï½-ï½šï¼¡-ï¼ºï¼-ï¼™]+)*|[^ \u3000]+|[ ]+|[\u3000]+)/g;
            let match;
            
            while ((match = regex.exec(text)) !== null) {
                const segment = match[1];
                
                if (/^[0-9]+[å¹´æœˆæ—¥æ™‚åˆ†ç§’å°æ£Ÿå€‹äººåæšå›åº¦ç•ªç›®éšå±¤ç­‰ä»¶æœ¬åŒ¹é ­ç¾½æ¯ã¤ä¸å†Šå·»è©±æœŸä»£ä¸–ç´€]$/.test(segment)) {
                    segments.push({ type: 'unit', text: segment });
                } else if (/^[a-zA-Z0-9ï½-ï½šï¼¡-ï¼ºï¼-ï¼™]+(?:\.[a-zA-Z0-9ï½-ï½šï¼¡-ï¼ºï¼-ï¼™]+)*$/.test(segment)) {
                    // åŠè§’ãƒ»å…¨è§’ã®è‹±æ•°å­—ã‚’å˜èªã¨ã—ã¦æ‰±ã†
                    segments.push({ type: 'word', text: segment });
                } else if (/^ +$/.test(segment)) {
                    // åŠè§’ã‚¹ãƒšãƒ¼ã‚¹ã®ã¿
                    segments.push({ type: 'space', text: segment });
                } else if (/^\u3000+$/.test(segment)) {
                    // å…¨è§’ã‚¹ãƒšãƒ¼ã‚¹ã®ã¿
                    segments.push({ type: 'fullwidth_space', text: segment });
                } else {
                    segments.push({ type: 'other', text: segment });
                }
            }
            
            return segments;
        }
        
        // ãƒ†ã‚­ã‚¹ãƒˆã®è¡¨ç¤ºå¹…ã‚’è¨ˆç®—
        function calculateTextWidth(text) {
            let width = 0;
            for (const char of text) {
                width += isFullWidth(char) ? 2 : 1;
            }
            return width;
        }
        
        // é•·ã„ã‚»ã‚°ãƒ¡ãƒ³ãƒˆã‚’å¼·åˆ¶çš„ã«åˆ†å‰²
        function forceBreakLongSegment(text, maxWidth) {
            const lines = [];
            let currentLine = '';
            let currentWidth = 0;
            
            for (const char of text) {
                const charWidth = isFullWidth(char) ? 2 : 1;
                
                if (currentWidth + charWidth > maxWidth && currentLine.length > 0) {
                    lines.push(currentLine);
                    currentLine = char;
                    currentWidth = charWidth;
                } else {
                    currentLine += char;
                    currentWidth += charWidth;
                }
            }
            
            if (currentLine.length > 0) {
                lines.push(currentLine);
            }
            
            return lines.length > 0 ? lines : [''];
        }
        
        // ã‚ˆã‚Šé«˜åº¦ãªæ”¹è¡Œãƒ«ãƒ¼ãƒ«ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
        function advancedJapaneseLineBreak(text, maxCharsPerLine) {
            // æ—¥æœ¬èªã®æ”¹è¡Œç¦å‰‡æ–‡å­—
            const noBreakBefore = /[ã€ã€‚ï¼ï¼Ÿã€ã€ã€‘ã€‰ã€‹ã€•ï¼½ï½ï¼‰]/;
            const noBreakAfter = /[ã€Œã€ã€ã€ˆã€Šã€”ï¼»ï½›ï¼ˆ]/;
            const preferBreakAfter = /[ã€‚ï¼ï¼Ÿ]/;
            
            // åŸºæœ¬çš„ãªæ”¹è¡Œå‡¦ç†ã‚’å®Ÿè¡Œ
            const basicLines = smartLineBreak(text, maxCharsPerLine);
            const improvedLines = [];
            
            for (let line of basicLines) {
                // ç¦å‰‡æ–‡å­—ã®ãƒã‚§ãƒƒã‚¯ã¨èª¿æ•´
                line = adjustLineBreakRules(line, noBreakBefore, noBreakAfter);
                improvedLines.push(line);
            }
            
            return improvedLines;
        }
        
        // ç¦å‰‡æ–‡å­—å‡¦ç†ï¼ˆç°¡ç•¥ç‰ˆï¼‰
        function adjustLineBreakRules(line, noBreakBefore, noBreakAfter) {
            // è¡Œæœ«ãŒç¦å‰‡æ–‡å­—ã§å§‹ã¾ã‚‹å ´åˆã®èª¿æ•´ï¼ˆç°¡ç•¥å®Ÿè£…ï¼‰
            if (line.length > 1 && noBreakBefore.test(line.charAt(0))) {
                // å‰ã®è¡Œã«ç§»å‹•ã™ã¹ãã ãŒã€ã“ã“ã§ã¯ç°¡ç•¥åŒ–
                return line;
            }
            
            return line;
        }
        
        // è¡¨ç¤ºã‚’æ›´æ–°
        function updateDisplay() {
            // å…¨ã¦ã®è¡Œã‚’è¡¨ç¤ºï¼ˆãƒã‚¹ã‚¯ã§åˆ¶å¾¡ï¼‰
            const html = textLineArray.map(line => 
                `<div class="text-line">${line || '&nbsp;'}</div>`
            ).join('');
            
            textLines.innerHTML = html;
            
            console.log(`è¡¨ç¤ºæ›´æ–°: å…¨${textLineArray.length}è¡Œã‚’è¡¨ç¤º`);
        }
        
        // é€£ç¶šã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆã‚¹ã‚¿ãƒ¼ã‚¦ã‚©ãƒ¼ã‚ºé¢¨ï¼‰
        let scrollQueue = [];
        let isProcessingQueue = false;
        let displayedLineCount = 0; // ç¾åœ¨è¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹è¡Œæ•°
        
        function performContinuousScrollAnimation(lineCount) {
            console.log(`${lineCount}è¡Œã®é€£ç¶šã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚’é–‹å§‹`);
            
            // ç¾åœ¨ã®è¡¨ç¤ºè¡Œæ•°ã‚’è¨˜éŒ²
            displayedLineCount = textLineArray.length - lineCount;
            
            // è¿½åŠ ã•ã‚ŒãŸè¡Œæ•°ã‚’ã‚­ãƒ¥ãƒ¼ã«è¿½åŠ 
            for (let i = 0; i < lineCount; i++) {
                scrollQueue.push(i);
            }
            
            // ã‚­ãƒ¥ãƒ¼ã®å‡¦ç†ã‚’é–‹å§‹
            if (!isProcessingQueue) {
                processScrollQueue();
            }
        }
        
        function processScrollQueue() {
            if (scrollQueue.length === 0) {
                isProcessingQueue = false;
                displayedLineCount = textLineArray.length; // æœ€çµ‚çš„ã«å…¨è¡Œè¡¨ç¤º
                console.log('é€£ç¶šã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«å®Œäº†');
                return;
            }
            
            isProcessingQueue = true;
            scrollQueue.shift(); // 1ã¤å‡¦ç†
            displayedLineCount++; // è¡¨ç¤ºè¡Œæ•°ã‚’1ã¤å¢—ã‚„ã™
            
            // 1è¡Œåˆ†ã®ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å®Ÿè¡Œ
            performSingleLineScroll(() => {
                // æ¬¡ã®ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚’å®Ÿè¡Œ
                processScrollQueue();
            });
        }
        
        function performSingleLineScroll(callback) {
            console.log(`1è¡Œã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³é–‹å§‹ï¼ˆè¡¨ç¤º: ${displayedLineCount}è¡Œ/${textLineArray.length}è¡Œï¼‰`);
            
            // ç¾åœ¨è¡¨ç¤ºã™ã¹ãè¡Œæ•°ã¾ã§ã‚’è¡¨ç¤º
            const linesToShow = textLineArray.slice(0, displayedLineCount);
            const html = linesToShow.map(line => 
                `<div class="text-line">${line || '&nbsp;'}</div>`
            ).join('');
            
            // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ç„¡ã—ã§å†…å®¹ã‚’æ›´æ–°
            textLines.style.transition = 'none';
            textLines.innerHTML = html;
            
            // å®Ÿéš›ã®è¡Œã®é«˜ã•ã‚’å–å¾—
            const firstLine = textLines.querySelector('.text-line');
            const lineHeight = firstLine ? firstLine.offsetHeight : (settings.fontSize * settings.lineHeight);
            
            console.log(`è¡Œã®é«˜ã•: ${lineHeight}px`);
            
            // åˆæœŸä½ç½®: 1è¡Œåˆ†ä¸‹ã«é…ç½®ï¼ˆæ–°ã—ã„è¡ŒãŒãƒã‚¹ã‚¯ã®ä¸‹ã«éš ã‚Œã‚‹ï¼‰
            textLines.style.transform = `translateY(${lineHeight}px)`;
            
            // æ¬¡ã®ãƒ•ãƒ¬ãƒ¼ãƒ ã§ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³é–‹å§‹
            requestAnimationFrame(() => {
                requestAnimationFrame(() => {
                    const duration = settings.animationDuration;
                    textLines.style.transition = `transform ${duration}s linear`;
                    textLines.style.transform = 'translateY(0)';
                    
                    console.log(`1è¡Œã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«å®Ÿè¡Œ: ${lineHeight}pxä¸Šã«ã›ã‚Šä¸ŠãŒã‚‹ã€é€Ÿåº¦: ${duration}ç§’`);
                });
            });
            
            // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³å®Œäº†å¾Œã«ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯
            setTimeout(() => {
                // transformã‚’ãƒªã‚»ãƒƒãƒˆï¼ˆæ¬¡ã®ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã®ãŸã‚ï¼‰
                textLines.style.transition = 'none';
                textLines.style.transform = 'translateY(0)';
                console.log('1è¡Œã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«å®Œäº†ï¼ˆtransformãƒªã‚»ãƒƒãƒˆï¼‰');
                if (callback) callback();
            }, settings.animationDuration * 1000);
        }
        
        // ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè¡Œï¼ˆæ”¹è‰¯ç‰ˆï¼‰
        function performScrollAnimation() {
            if (isAnimating || textLineArray.length <= settings.maxVisibleLines) {
                updateDisplay();
                return;
            }
            
            console.log('ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³é–‹å§‹');
            isAnimating = true;
            updateDebugInfo();
            
            // 1. æ–°ã—ã„è¡Œã‚’å«ã‚ã¦è¡¨ç¤ºï¼ˆã¾ã è¦‹ãˆãªã„ä½ç½®ã«é…ç½®ï¼‰
            const visibleLines = textLineArray.slice(-settings.maxVisibleLines);
            
            // æ–°ã—ã„è¡Œã‚’è¿½åŠ ã—ã¦å…¨ä½“ã‚’è¡¨ç¤º
            const htmlWithNew = visibleLines.map(line => 
                `<div class="text-line">${line || '&nbsp;'}</div>`
            ).join('');
            
            // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ç„¡ã—ã§å†…å®¹ã‚’æ›´æ–°
            textLines.style.transition = 'none';
            textLines.innerHTML = htmlWithNew;
            
            // 2. CSSã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã®ã‚­ãƒ¼ãƒ•ãƒ¬ãƒ¼ãƒ ã‚’å‹•çš„ã«è¨­å®š
            // ã¾ãšã€ä¸€ç•ªä¸Šã®è¡Œã®é«˜ã•ã‚’å–å¾—
            const firstLine = textLines.querySelector('.text-line');
            const lineHeight = firstLine ? firstLine.offsetHeight : (settings.fontSize * settings.lineHeight);
            
            console.log(`è¨ˆç®—ã•ã‚ŒãŸè¡Œã®é«˜ã•: ${lineHeight}px`);
            
            // 3. åˆæœŸä½ç½®ã‚’1è¡Œåˆ†ä¸‹ã«è¨­å®šï¼ˆæ–°ã—ã„è¡ŒãŒç”»é¢å¤–ã«ï¼‰
            textLines.style.transform = `translateY(${lineHeight}px)`;
            
            // 4. æ¬¡ã®ãƒ•ãƒ¬ãƒ¼ãƒ ã§ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³é–‹å§‹
            requestAnimationFrame(() => {
                requestAnimationFrame(() => {
                    textLines.style.transition = `transform ${settings.animationDuration}s linear`;
                    textLines.style.transform = 'translateY(0)';
                    
                    console.log(`ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«å®Ÿè¡Œ: ${lineHeight}pxä¸Šã«ç§»å‹•`);
                });
            });
            
            // 5. ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³å®Œäº†å¾Œã«ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
            setTimeout(() => {
                textLines.style.transition = 'none';
                textLines.style.transform = 'translateY(0)';
                isAnimating = false;
                updateDebugInfo();
                console.log('ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³å®Œäº†');
            }, settings.animationDuration * 1000);
        }
        
        // ãƒ†ã‚­ã‚¹ãƒˆè¿½åŠ 
        function addText(text) {
            console.log('=== ãƒ†ã‚­ã‚¹ãƒˆè¿½åŠ é–‹å§‹ ===');
            console.log('å—ä¿¡ãƒ†ã‚­ã‚¹ãƒˆ:', JSON.stringify(text));
            console.log('è¨­å®š - removeLineBreaks:', settings.removeLineBreaks);
            console.log('è¨­å®š - forceLineBreakChar:', JSON.stringify(settings.forceLineBreakChar));
            
            let processedText = text;
            
            // æ”¹è¡Œå‡¦ç†è¨­å®šã«åŸºã¥ã„ã¦å‡¦ç†
            if (settings.removeLineBreaks) {
                // ã™ã¹ã¦ã®æ”¹è¡Œã‚’å‰Šé™¤
                processedText = processedText.replace(/\r?\n/g, '');
                console.log('æ”¹è¡Œå‰Šé™¤å¾Œ:', JSON.stringify(processedText));
            }
            
            // å¼·åˆ¶æ”¹è¡Œæ–‡å­—ã‚’æ”¹è¡Œã«å¤‰æ›
            if (settings.forceLineBreakChar && settings.forceLineBreakChar.length > 0) {
                const regex = new RegExp(settings.forceLineBreakChar.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'), 'g');
                processedText = processedText.replace(regex, '\n');
                console.log('å¼·åˆ¶æ”¹è¡Œæ–‡å­—å¤‰æ›å¾Œ:', JSON.stringify(processedText));
            }
            
            // æ—¢å­˜ãƒ†ã‚­ã‚¹ãƒˆã¨çµåˆ
            let fullText = '';
            if (textLineArray.length > 0) {
                fullText = textLineArray.join('\n') + ' ' + processedText;
            } else {
                fullText = processedText;
            }
            
            console.log('çµåˆå¾ŒfullText:', JSON.stringify(fullText.substring(0, 100)));
            
            // éŸ³å£°èªè­˜ç”±æ¥ã®ä¸é©åˆ‡ãªã‚¹ãƒšãƒ¼ã‚¹ã‚’é™¤å»
            fullText = cleanupSpeechText(fullText);
            
            // å…¨è§’å¤‰æ›ãƒ¢ãƒ¼ãƒ‰ãŒæœ‰åŠ¹ãªå ´åˆ
            if (settings.fullWidthMode) {
                fullText = convertToFullWidth(fullText);
            }
            
            console.log('æœ€çµ‚å‡¦ç†å¾ŒfullText:', JSON.stringify(fullText.substring(0, 100)));
            
            // è¡Œã«åˆ†å‰²
            const newLines = splitTextIntoLines(fullText);
            const previousLineCount = textLineArray.length;
            textLineArray = newLines;
            
            console.log(`è¡Œæ•°å¤‰åŒ–: ${previousLineCount} â†’ ${textLineArray.length}`);
            console.log('=== ãƒ†ã‚­ã‚¹ãƒˆè¿½åŠ çµ‚äº† ===');
            
            // åˆå›ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®å ´åˆ
            if (!hasMessages) {
                hasMessages = true;
                displayedLineCount = 0; // 0è¡Œã‹ã‚‰å§‹ã‚ã‚‹
                
                // åˆå›ã‚‚1è¡Œãšã¤ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
                const initialLineCount = textLineArray.length;
                if (initialLineCount > 0) {
                    performContinuousScrollAnimation(initialLineCount);
                } else {
                    updateDisplay();
                }
                updateDebugInfo();
                return;
            }
            
            // å®Ÿéš›ã«å¢—ãˆãŸè¡Œæ•°
            const actualAddedLines = textLineArray.length - previousLineCount;
            
            if (actualAddedLines > 0) {
                // è¡ŒãŒå¢—ãˆãŸã‚‰ã€ãã®åˆ†ã ã‘ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
                performContinuousScrollAnimation(actualAddedLines);
            } else {
                updateDisplay();
            }
            
            updateDebugInfo();
        }
        
        // åˆæœŸåŒ–
        function initialize() {
            console.log('åˆæœŸåŒ–é–‹å§‹');
            
            // è¨­å®šã‚’èª­ã¿è¾¼ã¿
            loadSettings();
            
            // è¾æ›¸ãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã¿
            loadSpacedNamesDictionary();
            
            // è¨­å®šãƒ‘ãƒãƒ«ã‚’åˆæœŸåŒ–
            initSettingsPanel();
            
            // UIã«è¨­å®šã‚’åæ˜ 
            updateSettingsUI();
            
            // è¡¨ç¤ºã‚¹ã‚¿ã‚¤ãƒ«ã‚’é©ç”¨
            updateDisplayStyle();
            
            console.log('åˆæœŸåŒ–å®Œäº†');
        }
        
        // Socket.ioãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’å‹•çš„ã«èª­ã¿è¾¼ã¿
        const script = document.createElement('script');
        script.src = '/socket.io/socket.io.js';
        script.onload = function() {
            console.log('Socket.IOèª­ã¿è¾¼ã¿å®Œäº†');
            startSocketConnection();
        };
        script.onerror = function() {
            console.error('Socket.IOèª­ã¿è¾¼ã¿å¤±æ•—');
            connectionText.textContent = 'ãƒ©ã‚¤ãƒ–ãƒ©ãƒªèª­ã¿è¾¼ã¿å¤±æ•—';
        };
        document.head.appendChild(script);
        
        function startSocketConnection() {
            // URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‹ã‚‰roomIdã‚’å–å¾—
            const urlParams = new URLSearchParams(window.location.search);
            const roomId = urlParams.get('room');
            
            if (!roomId) {
                alert('ãƒ«ãƒ¼ãƒ IDãŒæŒ‡å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚ãƒ«ãƒ¼ãƒ ç®¡ç†ç”»é¢ã«ç§»å‹•ã—ã¾ã™ã€‚');
                window.location.href = '/room-manager';
                return;
            }
            
            console.log('è¡¨ç¤ºç”»é¢ - ãƒ«ãƒ¼ãƒ ID:', roomId);
            
            const isLocalDevelopment = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';
            const socketUrl = isLocalDevelopment ? 'http://localhost:3000' : '';
            
            const socket = io(socketUrl);
            
            socket.on('connect', () => {
                statusIndicator.className = 'status-indicator connected';
                connectionText.textContent = 'æ¥ç¶šæ¸ˆã¿';
                console.log('æ¥ç¶šæˆåŠŸ:', socket.id);
                
                // è¡¨ç¤ºç”»é¢ã‚‚ãƒ«ãƒ¼ãƒ ã«å‚åŠ 
                socket.emit('join_display', { roomId: roomId });
                console.log('join_displayã‚¤ãƒ™ãƒ³ãƒˆé€ä¿¡:', roomId);
            });
            
            socket.on('disconnect', () => {
                statusIndicator.className = 'status-indicator';
                connectionText.textContent = 'åˆ‡æ–­';
            });
            
            socket.on('connect_error', (error) => {
                statusIndicator.className = 'status-indicator';
                connectionText.textContent = 'æ¥ç¶šã‚¨ãƒ©ãƒ¼';
                console.error('æ¥ç¶šã‚¨ãƒ©ãƒ¼:', error);
            });
            
            socket.on('text_received', (message) => {
                console.log('ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å—ä¿¡:', message);
                addText(message.text);
            });
        }
        
        // å…¨ç”»é¢è¡¨ç¤ºãƒ¢ãƒ¼ãƒ‰ã®ç®¡ç†
        let isFullscreenMode = false;
        const fullscreenIndicator = document.getElementById('fullscreenIndicator');
        
        async function toggleFullscreenMode() {
            try {
                if (!document.fullscreenElement) {
                    // å…¨ç”»é¢ãƒ¢ãƒ¼ãƒ‰ã«å…¥ã‚‹
                    await document.documentElement.requestFullscreen();
                    isFullscreenMode = true;
                    document.body.classList.add('fullscreen-mode');
                    showFullscreenIndicator('å…¨ç”»é¢ãƒ¢ãƒ¼ãƒ‰ ON (F11ã¾ãŸã¯ESCã§çµ‚äº†)');
                    console.log('å…¨ç”»é¢ãƒ¢ãƒ¼ãƒ‰: ON');
                } else {
                    // å…¨ç”»é¢ãƒ¢ãƒ¼ãƒ‰ã‚’çµ‚äº†
                    await document.exitFullscreen();
                    isFullscreenMode = false;
                    document.body.classList.remove('fullscreen-mode');
                    showFullscreenIndicator('å…¨ç”»é¢ãƒ¢ãƒ¼ãƒ‰ OFF');
                    console.log('å…¨ç”»é¢ãƒ¢ãƒ¼ãƒ‰: OFF');
                }
                
                // è¡¨ç¤ºã‚’æ›´æ–°
                updateDisplay();
            } catch (error) {
                console.error('å…¨ç”»é¢è¡¨ç¤ºã®åˆ‡ã‚Šæ›¿ãˆã«å¤±æ•—:', error);
                alert('å…¨ç”»é¢è¡¨ç¤ºã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒ–ãƒ©ã‚¦ã‚¶ãŒå…¨ç”»é¢è¡¨ç¤ºã‚’ã‚µãƒãƒ¼ãƒˆã—ã¦ã„ãªã„å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚');
            }
        }
        
        // å…¨ç”»é¢ãƒ¢ãƒ¼ãƒ‰ã®å¤‰æ›´ã‚’ç›£è¦–
        document.addEventListener('fullscreenchange', () => {
            if (!document.fullscreenElement && isFullscreenMode) {
                // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒESCã‚­ãƒ¼ãªã©ã§å…¨ç”»é¢ã‚’çµ‚äº†ã—ãŸå ´åˆ
                isFullscreenMode = false;
                document.body.classList.remove('fullscreen-mode');
                console.log('å…¨ç”»é¢ãƒ¢ãƒ¼ãƒ‰: OFF (ãƒ¦ãƒ¼ã‚¶ãƒ¼æ“ä½œ)');
            }
        });
        
        function showFullscreenIndicator(message) {
            fullscreenIndicator.textContent = message;
            fullscreenIndicator.classList.add('show');
            
            setTimeout(() => {
                fullscreenIndicator.classList.remove('show');
            }, 2000);
        }
        
        // ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆ
        document.addEventListener('keydown', (event) => {
            // F11ã‚­ãƒ¼ã§å…¨ç”»é¢è¡¨ç¤ºåˆ‡ã‚Šæ›¿ãˆ
            if (event.key === 'F11') {
                event.preventDefault();
                toggleFullscreenMode();
            }
        });
        
        // ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³é–‹å§‹
        initialize();
        updateDebugInfo();
        
        console.log('JavaScriptåˆæœŸåŒ–å®Œäº†');
    </script>
</body>
</html>