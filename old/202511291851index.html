<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ–‡å­—èµ·ã“ã—ã‚·ã‚¹ãƒ†ãƒ </title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        
        .container {
            background-color: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            overflow: visible;
            position: relative;
        }
        
        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 15px;
            font-size: 18px; /* å°ã•ãã—ã¾ã—ãŸ */
            font-weight: bold;
        }
        
        .status {
            background-color: #e8f5e8;
            padding: 8px 15px; /* é«˜ã•ã‚’ç‹­ãã—ã¾ã—ãŸ */
            border-radius: 5px;
            margin-bottom: 20px;
            border-left: 4px solid #4CAF50;
            font-size: 14px; /* ãƒ•ã‚©ãƒ³ãƒˆã‚‚å°ã•ã */
        }
        
        .status.connecting {
            background-color: #fff3cd;
            border-left-color: #ffc107;
        }
        
        .status.error {
            background-color: #f8d7da;
            border-left-color: #dc3545;
        }
        
        .info-box {
            background-color: #d1ecf1;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
            border-left: 4px solid #17a2b8;
        }
        
        .test-section {
            margin-top: 30px;
            padding: 20px;
            background-color: #f8f9fa;
            border-radius: 5px;
        }
        
        .test-section h3 {
            color: #495057;
            margin-top: 0;
        }
        
        .test-list {
            margin-top: 15px;
        }
        
        .test-list li {
            margin-bottom: 8px;
            padding-left: 10px;
        }
        
        .login-section {
            background-color: #f8f9fa;
            padding: 20px;
            border-radius: 5px;
            margin-bottom: 20px;
        }
        
        .input-group {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        
        .input-group input {
            flex: 1;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 3px;
            font-size: 16px;
        }
        
        .input-group button {
            padding: 10px 20px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            font-size: 16px;
        }
        
        .input-group button:hover {
            background-color: #0056b3;
        }
        
        .input-group button:disabled {
            background-color: #6c757d;
            cursor: not-allowed;
        }
        
        .main-section {
            margin-top: 20px;
        }
        
        .sender-panel {
            background-color: #e3f2fd;
            padding: 20px;
            border-radius: 5px;
            margin-bottom: 20px;
            border-left: 4px solid #2196f3;
        }
        
        .sender-status {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-top: 15px;
        }
        
        .current-sender-info {
            font-size: 18px;
            font-weight: bold;
        }
        
        .next-sender-btn {
            padding: 10px 20px;
            background-color: #2196f3;
            color: white;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
        }
        
        .next-sender-btn:hover:not(:disabled) {
            background-color: #1976d2;
        }
        
        .next-sender-btn:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }
        
        .sender-message {
            margin-top: 15px;
            padding: 10px;
            border-radius: 3px;
            font-weight: bold;
        }
        
        .sender-message.has-permission {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .input-panel {
            background-color: #f8f9fa;
            padding: 20px;
            border-radius: 5px;
            margin-bottom: 20px;
            border-left: 4px solid #6c757d;
        }
        
        .input-panel.active {
            border-left-color: #28a745;
            background-color: #f8fff8;
        }
        
        .input-area {
            margin-top: 15px;
        }
        
        .input-area textarea {
            width: 100%;
            height: 140px; /* ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ7è¡Œåˆ†ï¼ˆå‹•çš„ã«å¤‰æ›´ã•ã‚Œã‚‹ï¼‰ */
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 3px;
            font-size: 16px;
            font-family: Arial, sans-serif;
            resize: vertical;
            box-sizing: border-box;
        }
        
        .input-area textarea:disabled {
            background-color: #f5f5f5;
            color: #6c757d;
        }
        
        .input-area textarea:focus {
            outline: none;
            border-color: #007bff;
        }
        
        .input-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 10px;
            gap: 15px;
        }
        
        .keyboard-hint {
            color: #6c757d;
            font-size: 14px;
            flex: 1;
        }
        
        .input-status {
            color: #6c757d;
            font-size: 14px;
            flex-shrink: 0;
        }
        
        .input-status.active {
            color: #28a745;
            font-weight: bold;
        }
        
        .three-tier-layout {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .tier-panel {
            border-radius: 8px;
            padding: 15px;
            border-left: 4px solid #6c757d;
            transition: all 0.3s ease;
        }
        
        /* é€šå¸¸æ™‚ï¼ˆå·¦å´ã®ã¿æ ç·šï¼‰ */
        .tier-previous {
            background-color: #f0f8ff;
            border-left: 4px solid #17a2b8;  /* æ°´è‰²ãƒ»å·¦ã®ã¿ */
        }
        
        .tier-current {
            background-color: #f8fff8;
            border-left: 4px solid #28a745;  /* ç·‘è‰²ãƒ»å·¦ã®ã¿ */
        }
        
        .tier-next {
            background-color: #fff8dc;
            border-left: 4px solid #ffc107;  /* ãƒ™ãƒ¼ã‚¸ãƒ¥ãƒ»å·¦ã®ã¿ */
        }
        
        /* é€ä¿¡æ¨©è¡¨ç¤ºæ™‚ï¼ˆ4æ–¹å‘å…¨ã¦æ ç·šï¼‰ */
        .tier-previous.has-sender-permission {
            border: 4px solid #17a2b8 !important;       /* æ°´è‰²ãƒ»4æ–¹å‘å…¨ã¦ */
            border-left-width: 4px !important;          /* å·¦å´ã‚‚4px */
        }
        
        .tier-current.has-sender-permission {
            border: 4px solid #28a745 !important;       /* ç·‘è‰²ãƒ»4æ–¹å‘å…¨ã¦ */
            border-left-width: 4px !important;          /* å·¦å´ã‚‚4px */
        }
        
        .tier-next.has-sender-permission {
            border: 4px solid #ffc107 !important;       /* ãƒ™ãƒ¼ã‚¸ãƒ¥ãƒ»4æ–¹å‘å…¨ã¦ */
            border-left-width: 4px !important;          /* å·¦å´ã‚‚4px */
        }
        
        .tier-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 10px;
            font-size: 14px;
            font-weight: bold;
        }
        
        .tier-user-name {
            color: #007bff;
            font-size: 16px;
        }
        
        .char-counter {
            font-size: 12px;
            color: #6c757d;
            font-family: monospace;
            margin-left: 8px;
        }
        
        .input-lines-control {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 12px;
            color: #6c757d;
            margin-left: 15px;
        }
        
        .input-lines-control label {
            font-weight: normal;
        }
        
        .tier-status {
            margin-left: auto;
            color: #28a745;
            font-size: 12px;
            font-weight: normal;
        }
        
        .tier-status.waiting {
            color: #6c757d;
        }
        
        .tier-content {
            background-color: white;
            padding: 12px;
            border-radius: 4px;
            border: 1px solid #ddd;
            min-height: 50px;
            font-size: 16px;
            line-height: 1.4;
            color: #333;
        }
        
        .tier-content.empty {
            color: #999;
            font-style: italic;
        }
        
        .tier-input-area {
            position: relative;
            z-index: 10;
            isolation: isolate;
        }
        
        .tier-input-area textarea {
            width: 100%;
            height: 140px; /* ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ7è¡Œåˆ†ï¼ˆå‹•çš„ã«å¤‰æ›´ã•ã‚Œã‚‹ï¼‰ */
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 4px;
            font-size: 16px;
            font-family: Arial, sans-serif;
            resize: vertical;
            box-sizing: border-box;
            transition: border-color 0.3s ease;
            /* IMEå¯¾ç­– */
            position: relative;
            z-index: 1;
            transform: translateZ(0);
            -webkit-transform: translateZ(0);
        }
        
        .tier-input-area textarea:focus {
            outline: none;
            border-color: #28a745;
        }
        
        .tier-input-area textarea.has-permission {
            border-color: #28a745;
            border-width: 3px;
            box-shadow: 0 0 0 3px rgba(40, 167, 69, 0.1);
            background-color: #f8fff8;
        }
        
        .tier-input-area textarea.has-permission::placeholder {
            color: #28a745;
            opacity: 0.7;
        }
        
        .tier-input-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 8px;
            gap: 15px;
        }
        
        /* ãƒ­ã‚°è¡¨ç¤ºãƒ‘ãƒãƒ«ï¼ˆæ—§ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒ‘ãƒãƒ«éƒ¨åˆ†ï¼‰ */
        .log-panel {
            background-color: #ffffff;
            padding: 20px;
            border-radius: 5px;
            margin-bottom: 20px;
            border: 1px solid #ddd;
        }
        
        .log-controls {
            display: flex;
            align-items: center;
            gap: 15px;
            flex-wrap: wrap;
        }
        
        .log-show-btn {
            padding: 12px 24px;
            background-color: #17a2b8;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            transition: background-color 0.3s;
        }
        
        .log-show-btn:hover {
            background-color: #138496;
        }
        
        .export-btn {
            padding: 8px 16px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            transition: background-color 0.3s;
        }
        
        .export-btn:hover {
            background-color: #0056b3;
        }
        
        .export-btn:disabled {
            background-color: #6c757d;
            cursor: not-allowed;
        }
        
        .clear-log-btn {
            padding: 8px 16px;
            background-color: #dc3545;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            transition: background-color 0.3s;
        }
        
        .clear-log-btn:hover {
            background-color: #c82333;
        }
        
        .clear-log-btn:disabled {
            background-color: #6c757d;
            cursor: not-allowed;
        }
        
        .log-stats {
            font-size: 12px;
            color: #6c757d;
            margin-left: auto;
        }
        
        /* ãƒãƒ¼ã‚¸ãƒ§ãƒ³æƒ…å ± */
        .version-info {
            background-color: #007bff;
            color: white;
            padding: 5px 15px;
            text-align: center;
            font-size: 12px;
            font-family: monospace;
        }
        
        /* ãƒ˜ãƒƒãƒ€ãƒ¼å†…ã®æ–‡å­—æ•°ã‚¬ã‚¤ãƒ‰è¨­å®š */
        .char-guide-controls-header {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 12px;
            font-weight: normal;
        }
        
        .char-guide-controls-header .char-guide-checkbox {
            display: flex;
            align-items: center;
            gap: 3px;
            cursor: pointer;
            white-space: nowrap;
        }
        
        .char-guide-controls-header .char-guide-setting {
            display: flex;
            align-items: center;
            gap: 3px;
            white-space: nowrap;
        }
        
        .char-guide-controls-header .char-guide-setting input[type="number"] {
            padding: 1px 3px;
            border: 1px solid #ccc;
            border-radius: 3px;
            font-size: 11px;
            width: 50px;
        }
        
        /* ç¾åœ¨è¡Œæ–‡å­—æ•°è¡¨ç¤º */
        .current-line-counter {
            background-color: #f8f9fa;
            padding: 5px 10px;
            border-radius: 3px 3px 0 0;
            border: 1px solid #ddd;
            border-bottom: none;
            font-size: 12px;
            color: #495057;
        }
        
        .tier-input-area textarea {
            border-radius: 0 0 4px 4px;
        }
        
        /* æ–‡å­—æ•°ã‚¬ã‚¤ãƒ‰èƒŒæ™¯ */
        .char-guide-background {
            background: linear-gradient(
                to right,
                #f0f8f0 0%,
                #f0f8f0 var(--guide-percentage, 50%),
                #ffffff var(--guide-percentage, 50%),
                #ffffff 100%
            );
        }
        
        /* è¨­å®šãƒœã‚¿ãƒ³ */
        .settings-toggle-btn {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            margin-bottom: 15px;
            transition: background-color 0.3s;
        }
        
        .settings-toggle-btn:hover {
            background-color: #0056b3;
        }
        
        .settings-toggle-btn.active {
            background-color: #28a745;
        }
        
        /* è¨­å®šã‚¨ãƒªã‚¢ */
        .settings-area {
            transition: max-height 0.3s ease-out, opacity 0.3s ease-out;
            overflow: hidden;
        }
        
        .settings-area.hidden {
            max-height: 0;
            opacity: 0;
        }
        
        .settings-area.visible {
            max-height: 2000px;
            opacity: 1;
        }
        
        .char-guide-panel,
        .log-panel {
            background-color: #f8f9fa;
            padding: 20px;
            border-radius: 5px;
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <!-- ãƒãƒ¼ã‚¸ãƒ§ãƒ³æƒ…å ± -->
    <div class="version-info">
        Version 2.1.4 - Build 2025.07.14.005 - 3æ®µå€‹åˆ¥è¡Œæ•°èª¿æ•´æ©Ÿèƒ½
    </div>
    
    <div class="container">
        <h1>ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ–‡å­—èµ·ã“ã—ã‚·ã‚¹ãƒ†ãƒ </h1>
        
        <div id="status" class="status connecting">
            <strong>æ¥ç¶šçŠ¶æ³:</strong> <span id="statusText">ã‚µãƒ¼ãƒãƒ¼ã«æ¥ç¶šä¸­...</span>
        </div>
                
        <!-- å‚åŠ å‰ã®ç”»é¢ -->
        <div id="loginSection" class="login-section">
            <h3>å‚åŠ è€…åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„</h3>
            <div class="input-group">
                <input type="text" id="nameInput" placeholder="ä¾‹: ã‚ªãƒšãƒ¬ãƒ¼ã‚¿ãƒ¼1" maxlength="20">
                <button id="joinBtn">å‚åŠ </button>
            </div>
        </div>
        
        <!-- å‚åŠ å¾Œã®ç”»é¢ -->
        <div id="mainSection" class="main-section" style="display: none;">
            <!-- 3æ®µè¡¨ç¤ºã‚¨ãƒªã‚¢ -->
            <div class="three-tier-layout">
                <!-- ä¸Šæ®µï¼šå‰ã®äººã®å…¥åŠ›çŠ¶æ³ -->
                <div class="tier-panel tier-previous">
                    <div class="tier-header">
                        <span id="previousUserName" class="tier-user-name">å‰ã®äºº</span>
                        <div class="input-lines-control">
                            <label for="previousLinesNumber">è¡Œæ•°:</label>
                            <input type="number" id="previousLinesNumber" min="2" max="15" value="4" style="width: 45px; padding: 2px 4px; border: 1px solid #ccc; border-radius: 3px; font-size: 11px; margin: 0 3px;">
                        </div>
                    </div>
                    <div id="previousUserInput" class="tier-content">
                        å¾…æ©Ÿä¸­...
                    </div>
                </div>
                
                <!-- ä¸­æ®µï¼šè‡ªåˆ†ã®å…¥åŠ›ã‚¨ãƒªã‚¢ -->
                <div class="tier-panel tier-current">
                    <div class="tier-header">
                        <span id="currentUserName" class="tier-user-name">ã‚ãªãŸ</span>
                        <div class="input-lines-control">
                            <label for="currentLinesNumber">è¡Œæ•°:</label>
                            <input type="number" id="currentLinesNumber" min="3" max="20" value="7" style="width: 45px; padding: 2px 4px; border: 1px solid #ccc; border-radius: 3px; font-size: 11px; margin: 0 3px;">
                        </div>
                        <span id="charCounter" class="char-counter">0æ–‡å­—</span>
                        <span id="currentInputStatus" class="tier-status">å…¥åŠ›å¯èƒ½ãƒ»é€ä¿¡æ¨©å¾…ã¡</span>
                    </div>
                    
                    <div class="tier-input-area">
                        <textarea id="textInput" placeholder="ã“ã“ã«æ–‡å­—èµ·ã“ã—å†…å®¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„..."></textarea>
                        <div class="tier-input-controls">
                            <span class="keyboard-hint">Ctrl+Enter ã¾ãŸã¯ F12 ã§é€ä¿¡</span>
                        </div>
                    </div>
                </div>
                
                <!-- ä¸‹æ®µï¼šæ¬¡ã®äººã®å…¥åŠ›çŠ¶æ³ -->
                <div class="tier-panel tier-next">
                    <div class="tier-header">
                        <span id="nextUserName" class="tier-user-name">æ¬¡ã®äºº</span>
                        <div class="input-lines-control">
                            <label for="nextLinesNumber">è¡Œæ•°:</label>
                            <input type="number" id="nextLinesNumber" min="2" max="15" value="4" style="width: 45px; padding: 2px 4px; border: 1px solid #ccc; border-radius: 3px; font-size: 11px; margin: 0 3px;">
                        </div>
                    </div>
                    <div id="nextUserInput" class="tier-content">
                        å¾…æ©Ÿä¸­...
                    </div>
                </div>
            </div>
            
            <!-- è¨­å®šãƒœã‚¿ãƒ³ -->
            <button id="settingsToggleBtn" class="settings-toggle-btn">âš™ï¸ è¨­å®š</button>
            
            <!-- è¨­å®šã‚¨ãƒªã‚¢ -->
            <div id="settingsArea" class="settings-area hidden">
                <!-- æ–‡å­—æ•°ã‚¬ã‚¤ãƒ‰è¡¨ç¤ºè¨­å®š -->
                <div class="char-guide-panel">
                <h3>ğŸ¯ æ–‡å­—æ•°ã‚¬ã‚¤ãƒ‰è¨­å®š</h3>
                <div class="char-guide-controls">
                    <label class="char-guide-checkbox">
                        <input type="checkbox" id="charGuideEnabled"> æ–‡å­—æ•°ã‚¬ã‚¤ãƒ‰è¡¨ç¤º
                    </label>
                    <div class="char-guide-setting">
                        <label>ç›®å®‰: </label>
                        <input type="number" id="charGuideLimit" value="20" min="0.5" max="100" step="0.5" style="width: 60px;">
                        <span>æ–‡å­—ï¼ˆå…¨è§’åŸºæº–ï¼‰</span>
                    </div>
                </div>
            </div>
            
            <!-- ãƒ­ã‚°è¡¨ç¤ºãƒ‘ãƒãƒ«ï¼ˆæ—§ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒ‘ãƒãƒ«ï¼‰ -->
            <div class="log-panel">
                <h3>é€ä¿¡æ¸ˆã¿ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ç®¡ç†</h3>
                <div class="log-controls">
                    <button id="logShowBtn" class="log-show-btn">ğŸ“‹ ãƒ­ã‚°è¡¨ç¤º</button>
                    <button id="exportTextBtn" class="export-btn">ãƒ†ã‚­ã‚¹ãƒˆã®ã¿ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</button>
                    <button id="exportTimecodeBtn" class="export-btn">ã‚¿ã‚¤ãƒ ã‚³ãƒ¼ãƒ‰ä»˜ãã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</button>
                    <button id="clearLogBtn" class="clear-log-btn">ãƒ­ã‚°ã‚¯ãƒªã‚¢</button>
                    <span id="logStats" class="log-stats">ãƒ­ã‚°: 0ä»¶</span>
                </div>
            </div>
            
            <!-- ã‚¢ã‚¯ã‚»ã‚¹æ–¹æ³• -->
            <div class="info-box">
                <h3>ã‚¢ã‚¯ã‚»ã‚¹æ–¹æ³•</h3>
                <p>ä»–ã®ãƒ‡ãƒã‚¤ã‚¹ã‹ã‚‰ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹å ´åˆã¯ã€ä»¥ä¸‹ã®URLã‚’ä½¿ç”¨ã—ã¦ãã ã•ã„ã€‚</p>
                <div class="connection-info">
                    å‚åŠ å¾Œã«å®Ÿéš›ã®URLãŒè¡¨ç¤ºã•ã‚Œã¾ã™
                </div>
                
                <!-- QRã‚³ãƒ¼ãƒ‰è¡¨ç¤ºã‚¨ãƒªã‚¢ã‚’è¿½åŠ  -->
                <div class="qr-section" style="margin-top: 20px; border-top: 1px solid #ddd; padding-top: 15px;">
                    <h4 style="color: #495057; margin-bottom: 10px; font-size: 14px;">è¡¨ç¤ºç”¨ç”»é¢ QRã‚³ãƒ¼ãƒ‰</h4>
                    <div id="qrcode" style="text-align: center; margin: 10px 0;"></div>
                    <p style="font-size: 12px; color: #666; text-align: center;">
                        ã‚¹ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒ³ã‚„ã‚¿ãƒ–ãƒ¬ãƒƒãƒˆã§èª­ã¿å–ã£ã¦è¡¨ç¤ºç”¨ç”»é¢ã«ã‚¢ã‚¯ã‚»ã‚¹
                    </p>
                </div>
            </div>
            </div>
            <!-- è¨­å®šã‚¨ãƒªã‚¢çµ‚äº† -->
        </div>
    </div>
    
    <script src="/socket.io/socket.io.js"></script>
    <script>
        // âœ… ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã«roomIdã‚’ä¿æŒ
        let currentRoomId = null;
        
        // URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‹ã‚‰roomIdã‚’å–å¾—ã—ã¦ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã«ä¿å­˜
        const urlParams = new URLSearchParams(window.location.search);
        currentRoomId = urlParams.get('room');  // â† constã§ã¯ãªãcurrentRoomIdã«ä»£å…¥
        
        if (!currentRoomId) {  // â† roomIdã§ã¯ãªãcurrentRoomId
            alert('ãƒ«ãƒ¼ãƒ IDãŒæŒ‡å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚ãƒ«ãƒ¼ãƒ ç®¡ç†ç”»é¢ã«ç§»å‹•ã—ã¾ã™ã€‚');
            window.location.href = '/room-manager';
        }
        
        console.log('index.html - ãƒ«ãƒ¼ãƒ ID:', currentRoomId);  // â† ç¢ºèªç”¨ãƒ­ã‚°è¿½åŠ 
        
        const socket = io();
        const statusDiv = document.getElementById('status');
        const statusText = document.getElementById('statusText');        
        const loginSection = document.getElementById('loginSection');
        const mainSection = document.getElementById('mainSection');
        const nameInput = document.getElementById('nameInput');
        const joinBtn = document.getElementById('joinBtn');
        
        const textInput = document.getElementById('textInput');
        
        // ãƒ­ã‚°é–¢é€£ã®è¦ç´ 
        const logShowBtn = document.getElementById('logShowBtn');
        const exportTextBtn = document.getElementById('exportTextBtn');
        const exportTimecodeBtn = document.getElementById('exportTimecodeBtn');
        const clearLogBtn = document.getElementById('clearLogBtn');
        const logStats = document.getElementById('logStats');
        
        // 3æ®µè¡¨ç¤ºç”¨ã®è¦ç´ 
        const previousUserName = document.getElementById('previousUserName');
        const previousUserInput = document.getElementById('previousUserInput');
        const currentUserName = document.getElementById('currentUserName');
        const currentInputStatus = document.getElementById('currentInputStatus');
        const nextUserName = document.getElementById('nextUserName');
        const nextUserInput = document.getElementById('nextUserInput');
        const tierCurrent = document.querySelector('.tier-current');
        const charCounter = document.getElementById('charCounter');
        
        let isJoined = false;
        let myParticipant = null;
        let currentSender = null;
        let typingUsers = new Map(); // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å…¥åŠ›çŠ¶æ³ã‚’ç®¡ç†
        let typingTimeout = null;
        let allParticipants = []; // å…¨å‚åŠ è€…ã‚’ä¿æŒ
        let messageCount = 0; // ãƒ­ã‚°ä»¶æ•°ã‚’ãƒˆãƒ©ãƒƒã‚­ãƒ³ã‚°
        let logWindow = null; // ãƒ­ã‚°ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã®å‚ç…§
        // currentRoomIdã¯æ—¢ã«705è¡Œç›®ã§å®£è¨€æ¸ˆã¿ï¼ˆé‡è¤‡å‰Šé™¤ï¼‰
        
        // å…¥åŠ›è¡Œæ•°è¨­å®šï¼ˆ3æ®µãã‚Œãã‚Œå€‹åˆ¥ï¼‰
        let inputLinesSettings = {
            previous: 4,  // å‰ã®äººã®è¡¨ç¤ºè¡Œæ•°
            current: 7,   // è‡ªåˆ†ã®å…¥åŠ›è¡Œæ•°
            next: 4       // æ¬¡ã®äººã®è¡¨ç¤ºè¡Œæ•°
        };
        
        // æ–‡å­—æ•°ã‚¬ã‚¤ãƒ‰è¨­å®š
        let charGuideSettings = {
            enabled: false,
            charLimit: 20.0
        };
        
        // è¨­å®šã‚¨ãƒªã‚¢ã®è¡¨ç¤º/éè¡¨ç¤º
        const settingsToggleBtn = document.getElementById('settingsToggleBtn');
        const settingsArea = document.getElementById('settingsArea');
        let settingsVisible = false;
        
        // LocalStorageã‹ã‚‰è¨­å®šã®è¡¨ç¤ºçŠ¶æ…‹ã‚’èª­ã¿è¾¼ã¿
        const savedSettingsVisibility = localStorage.getItem('settingsVisible');
        if (savedSettingsVisibility === 'true') {
            settingsVisible = true;
            settingsArea.classList.remove('hidden');
            settingsArea.classList.add('visible');
            settingsToggleBtn.classList.add('active');
        }
        
        settingsToggleBtn.addEventListener('click', () => {
            settingsVisible = !settingsVisible;
            
            if (settingsVisible) {
                settingsArea.classList.remove('hidden');
                settingsArea.classList.add('visible');
                settingsToggleBtn.classList.add('active');
            } else {
                settingsArea.classList.remove('visible');
                settingsArea.classList.add('hidden');
                settingsToggleBtn.classList.remove('active');
            }
            
            // LocalStorageã«ä¿å­˜
            localStorage.setItem('settingsVisible', settingsVisible);
        });
        
        // Socket.ioæ¥ç¶šã‚¤ãƒ™ãƒ³ãƒˆ
        socket.on('connect', () => {
            statusDiv.className = 'status';
            statusText.textContent = 'ã‚µãƒ¼ãƒãƒ¼ã«æ¥ç¶šã•ã‚Œã¾ã—ãŸ';
            
            console.log('Socket.ioæ¥ç¶šæˆåŠŸ:', socket.id);
        });
        
        socket.on('disconnect', () => {
            statusDiv.className = 'status error';
            statusText.textContent = 'ã‚µãƒ¼ãƒãƒ¼ã¨ã®æ¥ç¶šãŒåˆ‡æ–­ã•ã‚Œã¾ã—ãŸ';
            
            console.log('Socket.ioæ¥ç¶šåˆ‡æ–­');
        });
        
        socket.on('connect_error', (error) => {
            statusDiv.className = 'status error';
            statusText.textContent = 'ã‚µãƒ¼ãƒãƒ¼ã«æ¥ç¶šã§ãã¾ã›ã‚“ã§ã—ãŸ';
            
            console.error('Socket.ioæ¥ç¶šã‚¨ãƒ©ãƒ¼:', error);
        });
        
        // å‚åŠ é–¢é€£ã®ã‚¤ãƒ™ãƒ³ãƒˆ
        socket.on('joined', (data) => {
            if (data.success) {
                isJoined = true;
                myParticipant = data.participant;
                loginSection.style.display = 'none';
                mainSection.style.display = 'block';
                
                // è‡ªåˆ†ã®åå‰ã‚’è¡¨ç¤º
                currentUserName.textContent = data.participant.name;
                
                // å®Ÿéš›ã®URLã‚’è¡¨ç¤ºã¨QRã‚³ãƒ¼ãƒ‰ç”Ÿæˆ
                if (data.serverInfo) {
                    updateConnectionInfo(data.serverInfo);
                    generateDisplayQR(data.serverInfo.displayUrl);
                }
                
                // âœ… ã“ã®è¡Œã‚’è¿½åŠ : å‚åŠ æ™‚ã«ãƒ­ã‚°çµ±è¨ˆã‚’å–å¾—
                updateLogStats();
                
                // å‚åŠ å®Œäº†å¾Œã€æ–‡å­—æ•°ã‚¬ã‚¤ãƒ‰ã®èƒŒæ™¯ã‚’æ›´æ–°
                setTimeout(() => {
                    updateCharGuideBackground();
                }, 100);
                
                console.log('å‚åŠ å®Œäº†:', data.participant);
            }
        });
        
        socket.on('participants_updated', (data) => {
            allParticipants = data.participants;
            updateParticipantsList(data.participants, data.currentSender);
            updateSenderInfo(data.currentSender);
            updateInputState(data.currentSender);
            updateThreeTierDisplay(data.participants, data.currentSender);
            
            if (data.participants.length >= 1 && data.currentSender) {
            }
        });
        
        socket.on('sender_updated', (data) => {
            updateSenderInfo(data.currentSender);
            updateInputState(data.currentSender);
            updateParticipantsList(null, data.currentSender); // å‚åŠ è€…ä¸€è¦§ã¯æ›´æ–°ã›ãšé€ä¿¡æ¨©è¡¨ç¤ºã®ã¿æ›´æ–°
            updateThreeTierDisplay(allParticipants, data.currentSender);
        });
        
        // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å—ä¿¡
        socket.on('text_received', (message) => {
            console.log('âœ… æ–°ã—ã„ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å—ä¿¡:', message);
            
            // âœ… ãƒ­ã‚°ä»¶æ•°ã‚’å¢—ã‚„ã™
            messageCount++;
            console.log(`ãƒ­ã‚°ä»¶æ•°ã‚¤ãƒ³ã‚¯ãƒªãƒ¡ãƒ³ãƒˆ: ${messageCount}ä»¶`);
            
            // âœ… çµ±è¨ˆã‚’æ›´æ–°
            updateLogStats();
            
            // ãƒ­ã‚°ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ãŒé–‹ã„ã¦ã„ã‚‹å ´åˆã€ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¿½åŠ 
            if (logWindow && !logWindow.closed) {
                logWindow.addMessageToLog(message);
            }
        });
        

        // ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ å…¥åŠ›ã®å—ä¿¡
        socket.on('user_typing', (data) => {
            console.log('ä»–ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å…¥åŠ›å—ä¿¡:', data);
            updateThreeTierTyping(data);
        });
        
        // å…¥åŠ›ã‚¯ãƒªã‚¢ã®å—ä¿¡
        socket.on('user_clear_typing', (data) => {
            console.log('ä»–ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å…¥åŠ›ã‚¯ãƒªã‚¢:', data);
            clearThreeTierTyping(data.userId);
        });
        
        // ãƒ­ã‚°è¡¨ç¤ºã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã‚’é–‹ã
        function openLogWindow() {
            // âœ… ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã®currentRoomIdã‚’ä½¿ç”¨ï¼ˆURLã‹ã‚‰å†å–å¾—ã—ãªã„ï¼‰
            if (!currentRoomId) {
                alert('ãƒ«ãƒ¼ãƒ IDãŒå–å¾—ã§ãã¾ã›ã‚“');
                return;
            }
            
            const logUrl = window.location.origin + '/logs?room=' + currentRoomId;  // â† roomIdã‚’currentRoomIdã«å¤‰æ›´
            
            // æ—¢å­˜ã®ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ãŒã‚ã‚‹å ´åˆã¯é–‰ã˜ã‚‹
            if (logWindow && !logWindow.closed) {
                logWindow.close();
            }
            
            // æ–°ã—ã„ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã‚’é–‹ã
            logWindow = window.open(
                logUrl,
                'transcription-logs',
                'width=1000,height=700,scrollbars=yes,resizable=yes,menubar=no,toolbar=no,location=no,status=no'
            );
            
            if (!logWindow) {
                alert('ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ãŒãƒ–ãƒ­ãƒƒã‚¯ã•ã‚Œã¾ã—ãŸã€‚ãƒ–ãƒ©ã‚¦ã‚¶ã®è¨­å®šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
                return;
            }
            
            // ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ãŒé–‰ã˜ã‚‰ã‚ŒãŸå ´åˆã®å‡¦ç†
            const checkClosed = setInterval(() => {
                if (logWindow.closed) {
                    clearInterval(checkClosed);
                    logWindow = null;
                }
            }, 1000);
            
            console.log('ãƒ­ã‚°ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã‚’é–‹ãã¾ã—ãŸ:', logUrl);
        }
        
        // å…¥åŠ›è¡Œæ•°è¨­å®šã‚’èª­ã¿è¾¼ã¿
        function loadInputLinesSettings() {
            try {
                const saved = localStorage.getItem('inputLinesSettings');
                if (saved) {
                    const parsed = JSON.parse(saved);
                    Object.assign(inputLinesSettings, parsed);
                }
            } catch (error) {
                console.error('å…¥åŠ›è¡Œæ•°è¨­å®šã®èª­ã¿è¾¼ã¿ã«å¤±æ•—:', error);
            }
            
            // UIã«åæ˜ 
            document.getElementById('previousLinesNumber').value = inputLinesSettings.previous;
            document.getElementById('currentLinesNumber').value = inputLinesSettings.current;
            document.getElementById('nextLinesNumber').value = inputLinesSettings.next;
            
            // ãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒªã‚¢ã®é«˜ã•ã‚’æ›´æ–°
            updateTextAreaHeight();
            
            console.log('å…¥åŠ›è¡Œæ•°è¨­å®šèª­ã¿è¾¼ã¿å®Œäº†:', inputLinesSettings);
        }
        
        // å…¥åŠ›è¡Œæ•°è¨­å®šã‚’ä¿å­˜
        function saveInputLinesSettings() {
            try {
                localStorage.setItem('inputLinesSettings', JSON.stringify(inputLinesSettings));
                console.log('å…¥åŠ›è¡Œæ•°è¨­å®šä¿å­˜å®Œäº†:', inputLinesSettings);
            } catch (error) {
                console.error('å…¥åŠ›è¡Œæ•°è¨­å®šã®ä¿å­˜ã«å¤±æ•—:', error);
            }
        }
        
        // ãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒªã‚¢ã®é«˜ã•ã‚’æ›´æ–°ï¼ˆå€‹åˆ¥å¯¾å¿œï¼‰
        function updateTextAreaHeight() {
            const lineHeight = 20; // 1è¡Œã‚ãŸã‚Šã®é«˜ã•ï¼ˆpxï¼‰
            const inputPadding = 24; // å…¥åŠ›ã‚¨ãƒªã‚¢ã®ä¸Šä¸‹ãƒ‘ãƒ‡ã‚£ãƒ³ã‚°åˆè¨ˆ
            const contentPadding = 24; // è¡¨ç¤ºã‚¨ãƒªã‚¢ã®ä¸Šä¸‹ãƒ‘ãƒ‡ã‚£ãƒ³ã‚°åˆè¨ˆ
            
            // è‡ªåˆ†ã®å…¥åŠ›ã‚¨ãƒªã‚¢ï¼ˆãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒªã‚¢ï¼‰
            const currentHeight = (inputLinesSettings.current * lineHeight) + inputPadding;
            const textInput = document.getElementById('textInput');
            if (textInput) {
                textInput.style.height = `${currentHeight}px`;
            }
            
            // å‰ã®äººã®è¡¨ç¤ºã‚¨ãƒªã‚¢
            const previousHeight = (inputLinesSettings.previous * lineHeight) + contentPadding;
            const previousUserInput = document.getElementById('previousUserInput');
            if (previousUserInput) {
                previousUserInput.style.minHeight = `${previousHeight - contentPadding}px`;
                previousUserInput.style.maxHeight = `${previousHeight - contentPadding}px`;
                previousUserInput.style.overflow = 'auto';
            }
            
            // æ¬¡ã®äººã®è¡¨ç¤ºã‚¨ãƒªã‚¢
            const nextHeight = (inputLinesSettings.next * lineHeight) + contentPadding;
            const nextUserInput = document.getElementById('nextUserInput');
            if (nextUserInput) {
                nextUserInput.style.minHeight = `${nextHeight - contentPadding}px`;
                nextUserInput.style.maxHeight = `${nextHeight - contentPadding}px`;
                nextUserInput.style.overflow = 'auto';
            }
            
            console.log(`ãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒªã‚¢é«˜ã•æ›´æ–°:`, {
                previous: `${inputLinesSettings.previous}è¡Œ = ${previousHeight-contentPadding}px`,
                current: `${inputLinesSettings.current}è¡Œ = ${currentHeight}px`,
                next: `${inputLinesSettings.next}è¡Œ = ${nextHeight-contentPadding}px`
            });
        }
        function countCharacters(text) {
            let count = 0;
            for (let i = 0; i < text.length; i++) {
                const char = text[i];
                // å…¨è§’æ–‡å­—ï¼ˆã²ã‚‰ãŒãªã€ã‚«ã‚¿ã‚«ãƒŠã€æ¼¢å­—ã€å…¨è§’è¨˜å·ãªã©ï¼‰ã¯1æ–‡å­—
                // åŠè§’æ–‡å­—ï¼ˆè‹±æ•°å­—ã€åŠè§’è¨˜å·ãªã©ï¼‰ã¯0.5æ–‡å­—ã¨ã—ã¦ã‚«ã‚¦ãƒ³ãƒˆ
                if (char.match(/[^\x00-\x7F]/)) {
                    count += 1; // å…¨è§’æ–‡å­—
                } else {
                    count += 0.5; // åŠè§’æ–‡å­—
                }
            }
            return count; // å°æ•°ç‚¹ä»¥ä¸‹ã‚‚ä¿æŒ
        }
        
        // ã‚«ãƒ¼ã‚½ãƒ«ä½ç½®ã®è¡Œã®æ–‡å­—æ•°ã‚’å–å¾—
        function getCurrentLineCharCount() {
            const textarea = textInput;
            const text = textarea.value;
            const cursorPos = textarea.selectionStart;
            
            // ã‚«ãƒ¼ã‚½ãƒ«ä½ç½®ã‚ˆã‚Šå‰ã®æœ€å¾Œã®æ”¹è¡Œã‚’è¦‹ã¤ã‘ã‚‹
            const beforeCursor = text.substring(0, cursorPos);
            const lastNewline = beforeCursor.lastIndexOf('\n');
            
            // ã‚«ãƒ¼ã‚½ãƒ«ä½ç½®ã‚ˆã‚Šå¾Œã®æœ€åˆã®æ”¹è¡Œã‚’è¦‹ã¤ã‘ã‚‹
            const afterCursor = text.substring(cursorPos);
            const nextNewline = afterCursor.indexOf('\n');
            
            // ç¾åœ¨ã®è¡Œã®ãƒ†ã‚­ã‚¹ãƒˆã‚’å–å¾—
            const lineStart = lastNewline + 1;
            const lineEnd = nextNewline === -1 ? text.length : cursorPos + nextNewline;
            const currentLine = text.substring(lineStart, lineEnd);
            
            return countCharacters(currentLine);
        }
        
        // æ–‡å­—æ•°è¡¨ç¤ºã‚’æ›´æ–°
        function updateCharCounter() {
            const charCount = getCurrentLineCharCount();
            // æ•´æ•°ã®å ´åˆã¯ã€Œ6æ–‡å­—ã€ã€å°æ•°ã®å ´åˆã¯ã€Œ6.5æ–‡å­—ã€ã¨è¡¨ç¤º
            const displayCount = charCount % 1 === 0 ? charCount.toString() : charCount.toString();
            charCounter.textContent = `ç¾åœ¨è¡Œ: ${displayCount}æ–‡å­—`;
        }
        
        // æ–‡å­—æ•°ã‚¬ã‚¤ãƒ‰è¨­å®šã‚’èª­ã¿è¾¼ã¿
        function loadCharGuideSettings() {
            try {
                const saved = localStorage.getItem('charGuideSettings');
                if (saved) {
                    const parsed = JSON.parse(saved);
                    Object.assign(charGuideSettings, parsed);
                }
            } catch (error) {
                console.error('æ–‡å­—æ•°ã‚¬ã‚¤ãƒ‰è¨­å®šã®èª­ã¿è¾¼ã¿ã«å¤±æ•—:', error);
            }
            
            // UIã«åæ˜ 
            document.getElementById('charGuideEnabled').checked = charGuideSettings.enabled;
            document.getElementById('charGuideLimit').value = charGuideSettings.charLimit;
            
            console.log('æ–‡å­—æ•°ã‚¬ã‚¤ãƒ‰è¨­å®šèª­ã¿è¾¼ã¿å®Œäº†:', charGuideSettings);
            
            // èµ·å‹•æ™‚ã«èƒŒæ™¯ã‚’é©ç”¨ï¼ˆé…å»¶å®Ÿè¡Œã§ç¢ºå®Ÿã«é©ç”¨ï¼‰
            setTimeout(() => {
                updateCharGuideBackground();
                console.log('èµ·å‹•æ™‚èƒŒæ™¯æ›´æ–°å®Ÿè¡Œ');
            }, 100);
        }
        
        // æ–‡å­—æ•°ã‚¬ã‚¤ãƒ‰è¨­å®šã‚’ä¿å­˜
        function saveCharGuideSettings() {
            try {
                localStorage.setItem('charGuideSettings', JSON.stringify(charGuideSettings));
            } catch (error) {
                console.error('æ–‡å­—æ•°ã‚¬ã‚¤ãƒ‰è¨­å®šã®ä¿å­˜ã«å¤±æ•—:', error);
            }
        }
        
        // æ–‡å­—æ•°ã‚¬ã‚¤ãƒ‰èƒŒæ™¯ã‚’æ›´æ–°
        function updateCharGuideBackground() {
            const textarea = textInput;
            
            if (!textarea) {
                console.warn('ãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒªã‚¢ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                return;
            }
            
            if (!charGuideSettings.enabled) {
                textarea.classList.remove('char-guide-background');
                textarea.style.removeProperty('--guide-percentage');
                console.log('æ–‡å­—æ•°ã‚¬ã‚¤ãƒ‰ç„¡åŠ¹åŒ–');
                return;
            }
            
            // ãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒªã‚¢ãŒéè¡¨ç¤ºã®å ´åˆã¯ã‚¹ã‚­ãƒƒãƒ—ï¼ˆå‚åŠ å‰ãªã©ï¼‰
            if (textarea.offsetParent === null) {
                console.log('ãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒªã‚¢ãŒéè¡¨ç¤ºã®ãŸã‚å‡¦ç†ã‚’ã‚¹ã‚­ãƒƒãƒ—');
                return;
            }
            
            // DOMè¦ç´ ãŒå®Œå…¨ã«æç”»ã•ã‚Œã‚‹ã¾ã§å¾…æ©Ÿï¼ˆæœ€å¤§10å›ã¾ã§ï¼‰
            if (textarea.clientWidth === 0) {
                // å†è©¦è¡Œã‚«ã‚¦ãƒ³ã‚¿ãƒ¼ã‚’è¿½åŠ 
                if (!textarea.dataset.retryCount) {
                    textarea.dataset.retryCount = '0';
                }
                const retryCount = parseInt(textarea.dataset.retryCount);
                
                if (retryCount < 10) {
                    textarea.dataset.retryCount = String(retryCount + 1);
                    console.log(`ãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒªã‚¢æœªæç”»ã®ãŸã‚å†è©¦è¡Œ (${retryCount + 1}/10)`);
                    setTimeout(updateCharGuideBackground, 50);
                    return;
                } else {
                    console.warn('ãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒªã‚¢ã®æç”»å¾…æ©ŸãŒã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã—ã¾ã—ãŸ');
                    textarea.dataset.retryCount = '0';
                    return;
                }
            }
            
            // æç”»æˆåŠŸã—ãŸã‚‰ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼ã‚’ãƒªã‚»ãƒƒãƒˆ
            textarea.dataset.retryCount = '0';
            
            // ã‚ˆã‚Šæ­£ç¢ºãªæ–‡å­—å¹…è¨ˆç®—
            const style = window.getComputedStyle(textarea);
            const fontSize = parseFloat(style.fontSize);
            const fontFamily = style.fontFamily;
            
            // Canvas ã‚’ä½¿ç”¨ã—ã¦å®Ÿéš›ã®æ–‡å­—å¹…ã‚’æ¸¬å®š
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            ctx.font = `${fontSize}px ${fontFamily}`;
            
            // å…¨è§’æ–‡å­—ã®å¹…ã‚’æ¸¬å®š
            const fullWidthChar = 'ã‚';
            const fullWidthCharWidth = ctx.measureText(fullWidthChar).width;
            
            // ãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒªã‚¢ã®å®Ÿéš›ã®å¹…ã‚’å–å¾—
            const textareaStyle = window.getComputedStyle(textarea);
            const paddingLeft = parseFloat(textareaStyle.paddingLeft) || 0;
            const paddingRight = parseFloat(textareaStyle.paddingRight) || 0;
            const textareaWidth = textarea.clientWidth - paddingLeft - paddingRight;
            
            // è¨­å®šæ–‡å­—æ•°åˆ†ã®å®Ÿéš›ã®å¹…ã‚’è¨ˆç®—ï¼ˆå…¨è§’æ–‡å­—åŸºæº–ï¼‰
            const targetWidth = charGuideSettings.charLimit * fullWidthCharWidth;
            const limitPercentage = Math.min((targetWidth / textareaWidth) * 100, 100);
            
            textarea.classList.add('char-guide-background');
            textarea.style.setProperty('--guide-percentage', `${limitPercentage}%`);
            
            console.log('æ–‡å­—æ•°ã‚¬ã‚¤ãƒ‰æ›´æ–°ï¼ˆæ”¹å–„ç‰ˆï¼‰:', {
                charLimit: charGuideSettings.charLimit,
                fontSize: fontSize,
                fullWidthCharWidth: fullWidthCharWidth,
                textareaWidth: textareaWidth,
                targetWidth: targetWidth,
                limitPercentage: `${limitPercentage}%`,
                enabled: charGuideSettings.enabled
            });
        }
        
        function updateConnectionInfo(serverInfo) {
            const connectionInfo = document.querySelector('.connection-info');
            if (connectionInfo) {
                connectionInfo.innerHTML = `
                    <strong>ã‚ªãƒšãƒ¬ãƒ¼ã‚¿ãƒ¼ç”»é¢:</strong> ${serverInfo.operatorUrl}<br>
                    <strong>è¡¨ç¤ºç”¨ç”»é¢:</strong> ${serverInfo.displayUrl}
                `;
            }
        }
        
        // QRã‚³ãƒ¼ãƒ‰ç”Ÿæˆé–¢æ•°ï¼ˆä¿®æ­£ç‰ˆï¼‰
        function generateDisplayQR(displayUrl) {
            const qrCodeElement = document.getElementById('qrcode');
            if (qrCodeElement) {
                // ã‚·ãƒ³ãƒ—ãƒ«ãªURLç”Ÿæˆ
                const qrImageUrl = `https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=${encodeURIComponent(displayUrl)}`;
                
                qrCodeElement.innerHTML = `
                    <img src="${qrImageUrl}" 
                         alt="QRã‚³ãƒ¼ãƒ‰" 
                         style="border: 1px solid #ddd; border-radius: 4px;"
                         onload="console.log('QRç”»åƒèª­ã¿è¾¼ã¿æˆåŠŸ')"
                         onerror="console.log('QRç”»åƒèª­ã¿è¾¼ã¿å¤±æ•—'); this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTUwIiBoZWlnaHQ9IjE1MCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMTUwIiBoZWlnaHQ9IjE1MCIgZmlsbD0iI2Y5ZjlmOSIvPjx0ZXh0IHg9Ijc1IiB5PSI3NSIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZmlsbD0iIzk5OSI+UVLjgrPjg7zjg4njgZfjga7jgozjgb7jgZvjgpM8L3RleHQ+PC9zdmc+';">
                `;
                
                console.log('QRã‚³ãƒ¼ãƒ‰ç”Ÿæˆå®Œäº†:', displayUrl);
                console.log('QRã‚³ãƒ¼ãƒ‰URL:', qrImageUrl);
            }
        }
        
        // é€ä¿¡æ¨©æƒ…å ±ã‚’æ›´æ–°
        function updateSenderInfo(sender) {
            currentSender = sender;
            console.log('é€ä¿¡æ¨©æƒ…å ±æ›´æ–°:', sender);
        }
        
        // å‚åŠ è€…ä¸€è¦§ã‚’æ›´æ–°
        function updateParticipantsList(participants, sender) {
            // å‚åŠ è€…ä¸€è¦§ã¯å‰Šé™¤ã•ã‚ŒãŸãŸã‚ã€ã“ã®é–¢æ•°ã¯ä½•ã‚‚ã—ãªã„
        }
        
        // å…¥åŠ›çŠ¶æ…‹ã‚’æ›´æ–°
        function updateInputState(sender) {
            console.log('å…¥åŠ›çŠ¶æ…‹æ›´æ–°:', sender);
            console.log('è‡ªåˆ†:', myParticipant);
            
            const hasSenderPermission = myParticipant && sender && sender.id === myParticipant.id;
            console.log('é€ä¿¡æ¨©ãƒã‚§ãƒƒã‚¯çµæœ:', hasSenderPermission);
            
            if (hasSenderPermission) {
                console.log('é€ä¿¡æ¨©ã‚ã‚Š - UIæ›´æ–°');
                textInput.disabled = false;
                currentInputStatus.textContent = 'é€ä¿¡å¯èƒ½';
                currentInputStatus.className = 'tier-status';
                textInput.className = 'has-permission';
            } else {
                console.log('é€ä¿¡æ¨©ãªã— - UIæ›´æ–°');
                textInput.disabled = false; // é€ä¿¡æ¨©ãŒãªãã¦ã‚‚å…¥åŠ›ã¯å¯èƒ½
                currentInputStatus.textContent = 'é€ä¿¡æ¨©å¾…ã¡';
                currentInputStatus.className = 'tier-status waiting';
                textInput.className = '';
            }
        }
        
        // é€ä¿¡å‡¦ç†ï¼ˆã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆã®ã¿ï¼‰
        function sendText() {
            const text = textInput.value.trim();
            
            // é€ä¿¡æ¨©ãƒã‚§ãƒƒã‚¯
            const hasSenderPermission = myParticipant && currentSender && currentSender.id === myParticipant.id;
            if (!hasSenderPermission) {
                console.log('é€ä¿¡æ¨©ãŒãªã„ãŸã‚é€ä¿¡ã§ãã¾ã›ã‚“');
                return;
            }
            
            if (!text) {
                // ãƒ†ã‚­ã‚¹ãƒˆãŒç©ºã®å ´åˆã¯ã€é€ä¿¡æ¨©ã®ã¿æ¬¡ã«ç§»ã™ï¼ˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡ãªã—ï¼‰
                socket.emit('next_sender');
            } else {
                // ãƒ†ã‚­ã‚¹ãƒˆãŒã‚ã‚‹å ´åˆã¯ã€é€šå¸¸ã®é€ä¿¡å‡¦ç†
                socket.emit('send_text', { text: text });
            }
            
            // é€ä¿¡æ™‚ã«å…¥åŠ›ã‚¯ãƒªã‚¢ã‚’é€šçŸ¥
            socket.emit('clear_typing');
            
            textInput.value = ''; // é€ä¿¡å¾Œã«ã‚¯ãƒªã‚¢
            updateCharCounter(); // æ–‡å­—æ•°ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼ã‚’ãƒªã‚»ãƒƒãƒˆ
            // èƒŒæ™¯è‰²ã¯å…¥åŠ›æ™‚ã«è‡ªå‹•æ›´æ–°ã•ã‚Œã‚‹ãŸã‚ã€ã“ã“ã§ã¯å‘¼ã°ãªã„
        }
        
        // Enterã‚­ãƒ¼ï¼ˆCtrl+Enterï¼‰ã§é€ä¿¡
        textInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && e.ctrlKey) {
                e.preventDefault();
                sendText();
            }
        });
        
        // IMEï¼ˆæ—¥æœ¬èªå…¥åŠ›ï¼‰å¯¾ç­–
        let isComposing = false;
        
        textInput.addEventListener('compositionstart', () => {
            isComposing = true;
            console.log('IMEå¤‰æ›é–‹å§‹');
        });
        
        textInput.addEventListener('compositionupdate', (e) => {
            console.log('IMEå¤‰æ›ä¸­:', e.data);
        });
        
        textInput.addEventListener('compositionend', () => {
            isComposing = false;
            console.log('IMEå¤‰æ›çµ‚äº†');
            updateCharCounter();
            updateCharGuideBackground();
        });
        
        // F12ã‚­ãƒ¼ã§é€ä¿¡ï¼ˆã‚°ãƒ­ãƒ¼ãƒãƒ«ï¼‰
        document.addEventListener('keydown', (e) => {
            if (e.key === 'F12') {
                e.preventDefault();
                sendText();
            }
        });
        
        // æ–‡å­—æ•°ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼ã®æ›´æ–°
        textInput.addEventListener('input', () => {
            updateCharCounter();
            updateCharGuideBackground(); // å…¥åŠ›æ™‚ã«èƒŒæ™¯ã‚’æ›´æ–°
        });
        textInput.addEventListener('keyup', updateCharCounter);
        textInput.addEventListener('click', updateCharCounter);
        
        // å…¥åŠ›è¡Œæ•°è¨­å®šã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ï¼ˆå€‹åˆ¥å¯¾å¿œï¼‰
        document.getElementById('previousLinesNumber').addEventListener('change', (e) => {
            const value = parseInt(e.target.value);
            if (value >= 2 && value <= 15) {
                inputLinesSettings.previous = value;
                saveInputLinesSettings();
                updateTextAreaHeight();
            } else {
                e.target.value = inputLinesSettings.previous;
            }
        });
        
        document.getElementById('currentLinesNumber').addEventListener('change', (e) => {
            const value = parseInt(e.target.value);
            if (value >= 3 && value <= 20) {
                inputLinesSettings.current = value;
                saveInputLinesSettings();
                updateTextAreaHeight();
            } else {
                e.target.value = inputLinesSettings.current;
            }
        });
        
        document.getElementById('nextLinesNumber').addEventListener('change', (e) => {
            const value = parseInt(e.target.value);
            if (value >= 2 && value <= 15) {
                inputLinesSettings.next = value;
                saveInputLinesSettings();
                updateTextAreaHeight();
            } else {
                e.target.value = inputLinesSettings.next;
            }
        });
        
        // æ–‡å­—æ•°ã‚¬ã‚¤ãƒ‰è¨­å®šã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
        document.getElementById('charGuideEnabled').addEventListener('change', (e) => {
            charGuideSettings.enabled = e.target.checked;
            saveCharGuideSettings();
            updateCharGuideBackground();
        });
        
        document.getElementById('charGuideLimit').addEventListener('change', (e) => {
            const value = parseFloat(e.target.value);
            if (value >= 0.5 && value <= 100) {
                charGuideSettings.charLimit = value;
                saveCharGuideSettings();
                updateCharGuideBackground();
            }
        });
        
        // ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ãƒªã‚µã‚¤ã‚ºæ™‚ã«èƒŒæ™¯ã‚’å†è¨ˆç®—
        window.addEventListener('resize', () => {
            setTimeout(updateCharGuideBackground, 100);
        });
        
        // ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ å…¥åŠ›ã‚’æ›´æ–°
        function updateTypingUser(data) {
            if (data.text.trim() === '') {
                // ç©ºã®å ´åˆã¯å‰Šé™¤
                typingUsers.delete(data.userId);
            } else {
                // ãƒ†ã‚­ã‚¹ãƒˆãŒã‚ã‚‹å ´åˆã¯æ›´æ–°
                typingUsers.set(data.userId, {
                    userName: data.userName,
                    text: data.text,
                    timestamp: data.timestamp
                });
            }
        }
        
        // è‡ªåˆ†ã®å…¥åŠ›ã‚’ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ é€ä¿¡ï¼ˆæœ€é€Ÿè¨­å®šï¼‰
        textInput.addEventListener('input', () => {
            if (typingTimeout) {
                clearTimeout(typingTimeout);
            }
            
            // 20msé…å»¶ï¼ˆé«˜é€Ÿãƒ¬ã‚¹ãƒãƒ³ã‚¹ï¼‰
            typingTimeout = setTimeout(() => {
                if (isJoined) {
                    socket.emit('typing', { text: textInput.value });
                }
            }, 20);
        });
        
        // 3æ®µè¡¨ç¤ºã‚’æ›´æ–°
        function updateThreeTierDisplay(participants, currentSender) {
            console.log('3æ®µè¡¨ç¤ºæ›´æ–° - å‚åŠ è€…æ•°:', participants.length);
            console.log('è‡ªåˆ†ã®æƒ…å ±:', myParticipant);
            console.log('é€ä¿¡æ¨©è€…:', currentSender);
            
            if (!myParticipant || participants.length === 0) {
                previousUserName.textContent = 'å‰ã®äºº';
                previousUserInput.textContent = 'å¾…æ©Ÿä¸­...';
                previousUserInput.className = 'tier-content empty';
                document.querySelector('.tier-previous').className = 'tier-panel tier-previous';
                
                currentUserName.textContent = 'ã‚ãªãŸ';
                
                nextUserName.textContent = 'æ¬¡ã®äºº';
                nextUserInput.textContent = 'å¾…æ©Ÿä¸­...';
                nextUserInput.className = 'tier-content empty';
                document.querySelector('.tier-next').className = 'tier-panel tier-next';
                return;
            }
            
            // ç¾åœ¨ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ä½ç½®ã‚’ç‰¹å®š
            const myIndex = participants.findIndex(p => p.id === myParticipant.id);
            console.log('è‡ªåˆ†ã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹:', myIndex);
            
            if (myIndex === -1) return;
            
            // å‰ã®äººã‚’å–å¾—ï¼ˆå¾ªç’°ï¼‰
            const previousIndex = (myIndex - 1 + participants.length) % participants.length;
            const previousUser = participants[previousIndex];
            
            // æ¬¡ã®äººã‚’å–å¾—ï¼ˆå¾ªç’°ï¼‰
            const nextIndex = (myIndex + 1) % participants.length;
            const nextUser = participants[nextIndex];
            
            console.log('å‰ã®äºº:', previousUser.name, 'æ¬¡ã®äºº:', nextUser.name);
            
            // 1äººã®å ´åˆã®ç‰¹åˆ¥å‡¦ç†
            if (participants.length === 1) {
                previousUserName.textContent = 'ã‚ãªãŸï¼ˆå‰ã®é †ç•ªï¼‰';
                previousUserInput.textContent = '1äººãƒ¢ãƒ¼ãƒ‰ã§ã™';
                previousUserInput.className = 'tier-content empty';
                document.querySelector('.tier-previous').className = 'tier-panel tier-previous';
                
                nextUserName.textContent = 'ã‚ãªãŸï¼ˆæ¬¡ã®é †ç•ªï¼‰';
                nextUserInput.textContent = '1äººãƒ¢ãƒ¼ãƒ‰ã§ã™';
                nextUserInput.className = 'tier-content empty';
                document.querySelector('.tier-next').className = 'tier-panel tier-next';
            } else {
                // å‰ã®äºº
                previousUserName.textContent = previousUser.name;
                const previousTyping = typingUsers.get(previousUser.id);
                if (previousTyping && previousTyping.text.trim()) {
                    previousUserInput.textContent = previousTyping.text;
                    previousUserInput.className = 'tier-content';
                } else {
                    previousUserInput.textContent = 'å¾…æ©Ÿä¸­...';
                    previousUserInput.className = 'tier-content empty';
                }
                
                // å‰ã®äººãŒé€ä¿¡æ¨©ã‚’æŒã£ã¦ã„ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
                const previousHasSender = currentSender && currentSender.id === previousUser.id;
                document.querySelector('.tier-previous').className = previousHasSender 
                    ? 'tier-panel tier-previous has-sender-permission' 
                    : 'tier-panel tier-previous';
                
                // æ¬¡ã®äºº
                nextUserName.textContent = nextUser.name;
                const nextTyping = typingUsers.get(nextUser.id);
                if (nextTyping && nextTyping.text.trim()) {
                    nextUserInput.textContent = nextTyping.text;
                    nextUserInput.className = 'tier-content';
                } else {
                    nextUserInput.textContent = 'å¾…æ©Ÿä¸­...';
                    nextUserInput.className = 'tier-content empty';
                }
                
                // æ¬¡ã®äººãŒé€ä¿¡æ¨©ã‚’æŒã£ã¦ã„ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
                const nextHasSender = currentSender && currentSender.id === nextUser.id;
                document.querySelector('.tier-next').className = nextHasSender 
                    ? 'tier-panel tier-next has-sender-permission' 
                    : 'tier-panel tier-next';
            }
            
            // è‡ªåˆ†ã®åå‰ã‚’æ›´æ–°
            currentUserName.textContent = myParticipant.name;
            
            // è‡ªåˆ†ãŒé€ä¿¡æ¨©ã‚’æŒã£ã¦ã„ã‚‹ã‹ãƒã‚§ãƒƒã‚¯ï¼ˆä¸­æ®µç”¨ï¼‰
            const iHaveSender = currentSender && currentSender.id === myParticipant.id;
            tierCurrent.className = iHaveSender 
                ? 'tier-panel tier-current has-sender-permission' 
                : 'tier-panel tier-current';
        }
        
        // 3æ®µè¡¨ç¤ºã®ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ å…¥åŠ›ã‚’æ›´æ–°
        function updateThreeTierTyping(data) {
            console.log('3æ®µè¡¨ç¤ºæ›´æ–°:', data);
            
            if (!myParticipant || allParticipants.length === 0) {
                console.log('å‚åŠ è€…æƒ…å ±ãŒãªã„');
                return;
            }
            
            const myIndex = allParticipants.findIndex(p => p.id === myParticipant.id);
            if (myIndex === -1) {
                console.log('è‡ªåˆ†ãŒå‚åŠ è€…ãƒªã‚¹ãƒˆã«ã„ãªã„');
                return;
            }
            
            const previousIndex = (myIndex - 1 + allParticipants.length) % allParticipants.length;
            const nextIndex = (myIndex + 1) % allParticipants.length;
            
            const previousUser = allParticipants[previousIndex];
            const nextUser = allParticipants[nextIndex];
            
            console.log('å‰ã®äºº:', previousUser.name, 'ID:', previousUser.id);
            console.log('æ¬¡ã®äºº:', nextUser.name, 'ID:', nextUser.id);
            console.log('å…¥åŠ›è€…ID:', data.userId);
            
            // å‰ã®äººã®å…¥åŠ›æ›´æ–°
            if (data.userId === previousUser.id) {
                console.log('å‰ã®äººã®å…¥åŠ›æ›´æ–°:', data.text);
                if (data.text.trim()) {
                    previousUserInput.textContent = data.text;
                    previousUserInput.className = 'tier-content';
                } else {
                    previousUserInput.textContent = 'å¾…æ©Ÿä¸­...';
                    previousUserInput.className = 'tier-content empty';
                }
            }
            
            // æ¬¡ã®äººã®å…¥åŠ›æ›´æ–°
            if (data.userId === nextUser.id) {
                console.log('æ¬¡ã®äººã®å…¥åŠ›æ›´æ–°:', data.text);
                if (data.text.trim()) {
                    nextUserInput.textContent = data.text;
                    nextUserInput.className = 'tier-content';
                } else {
                    nextUserInput.textContent = 'å¾…æ©Ÿä¸­...';
                    nextUserInput.className = 'tier-content empty';
                }
            }
        }
        
        // 3æ®µè¡¨ç¤ºã®å…¥åŠ›ã‚¯ãƒªã‚¢
        function clearThreeTierTyping(userId) {
            if (!myParticipant || allParticipants.length === 0) return;
            
            const myIndex = allParticipants.findIndex(p => p.id === myParticipant.id);
            if (myIndex === -1) return;
            
            const previousIndex = (myIndex - 1 + allParticipants.length) % allParticipants.length;
            const nextIndex = (myIndex + 1) % allParticipants.length;
            
            const previousUser = allParticipants[previousIndex];
            const nextUser = allParticipants[nextIndex];
            
            // å‰ã®äººã®å…¥åŠ›ã‚¯ãƒªã‚¢
            if (userId === previousUser.id) {
                previousUserInput.textContent = 'å¾…æ©Ÿä¸­...';
                previousUserInput.className = 'tier-content empty';
            }
            
            // æ¬¡ã®äººã®å…¥åŠ›ã‚¯ãƒªã‚¢
            if (userId === nextUser.id) {
                nextUserInput.textContent = 'å¾…æ©Ÿä¸­...';
                nextUserInput.className = 'tier-content empty';
            }
        }
        
        // ãƒ­ã‚°çµ±è¨ˆæƒ…å ±ã‚’æ›´æ–°
        async function updateLogStats() {
            try {
                // âœ… roomIdã‚’ã‚¯ã‚¨ãƒªãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã«å«ã‚ã‚‹
                const response = await fetch(`/api/log-stats?room=${currentRoomId}`);
                
                if (response.ok) {
                    const stats = await response.json();
                    
                    if (stats.success) {
                        messageCount = stats.totalMessages;
                        console.log('ã‚µãƒ¼ãƒãƒ¼ãƒ­ã‚°çµ±è¨ˆ:', stats);
                    } else {
                        console.log('ãƒ­ã‚°çµ±è¨ˆå–å¾—å¤±æ•—:', stats.error);
                    }
                } else {
                    console.log('ãƒ­ã‚°çµ±è¨ˆå–å¾—å¤±æ•—ã€ãƒ­ãƒ¼ã‚«ãƒ«ã‚«ã‚¦ãƒ³ãƒˆã‚’ä½¿ç”¨');
                }
            } catch (error) {
                console.log('ãƒ­ã‚°çµ±è¨ˆå–å¾—ã‚¨ãƒ©ãƒ¼ã€ãƒ­ãƒ¼ã‚«ãƒ«ã‚«ã‚¦ãƒ³ãƒˆã‚’ä½¿ç”¨:', error);
            }
            
            logStats.textContent = `ãƒ­ã‚°: ${messageCount}ä»¶`;
            
            // ãƒœã‚¿ãƒ³ã®æœ‰åŠ¹/ç„¡åŠ¹ã‚’åˆ‡ã‚Šæ›¿ãˆ
            const hasMessages = messageCount > 0;
            exportTextBtn.disabled = !hasMessages;
            exportTimecodeBtn.disabled = !hasMessages;
            clearLogBtn.disabled = !hasMessages;
            
            console.log(`ãƒ­ã‚°ä»¶æ•°æ›´æ–°: ${messageCount}ä»¶, ãƒœã‚¿ãƒ³æœ‰åŠ¹: ${hasMessages}`);
        }
        
        // CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
        async function downloadCSV(type) {
            console.log(`ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰é–‹å§‹: ${type}, ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸æ•°: ${messageCount}`);
            
            if (messageCount === 0) {
                alert('ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã™ã‚‹ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“');
                return;
            }
            
            try {
                // âœ… currentRoomIdã‚’ä½¿ç”¨
                if (!currentRoomId) {
                    alert('ãƒ«ãƒ¼ãƒ IDãŒå–å¾—ã§ãã¾ã›ã‚“');
                    return;
                }
                
                // âœ… roomIdã‚’ã‚¯ã‚¨ãƒªãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã«å«ã‚ã‚‹
                const url = `/api/export/${type}?room=${currentRoomId}`;
                console.log(`ãƒªã‚¯ã‚¨ã‚¹ãƒˆURL: ${url}`);
                
                const response = await fetch(url);
                console.log('ãƒ¬ã‚¹ãƒãƒ³ã‚¹å—ä¿¡:', response.status, response.statusText);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const blob = await response.blob();
                console.log('Blobä½œæˆ:', blob.size, blob.type);
                
                // ãƒ•ã‚¡ã‚¤ãƒ«åã‚’ç”Ÿæˆ
                const timestamp = new Date().toISOString().slice(0, 19).replace(/[:-]/g, '');
                const filename = type === 'text-only' 
                    ? `transcription_text_${timestamp}.csv`
                    : `transcription_timecode_${timestamp}.csv`;
                
                // ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰å®Ÿè¡Œ
                const downloadUrl = window.URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = downloadUrl;
                link.download = filename;
                link.style.display = 'none';
                
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                window.URL.revokeObjectURL(downloadUrl);
                
                console.log(`ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰å®Œäº†: ${filename}`);
                
            } catch (error) {
                console.error('ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã‚¨ãƒ©ãƒ¼:', error);
                alert(`ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã«å¤±æ•—ã—ã¾ã—ãŸ: ${error.message}`);
            }
        }
        
        // ãƒ­ã‚°ã‚¯ãƒªã‚¢
        async function clearLog() {
            if (messageCount === 0) {
                alert('ã‚¯ãƒªã‚¢ã™ã‚‹ãƒ­ã‚°ãŒã‚ã‚Šã¾ã›ã‚“');
                return;
            }
            
            if (!confirm('ã™ã¹ã¦ã®ãƒ­ã‚°ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã™ã‹?ã“ã®æ“ä½œã¯å…ƒã«æˆ»ã›ã¾ã›ã‚“ã€‚')) {
                return;
            }
            
            try {
                // âœ… currentRoomIdã‚’ä½¿ç”¨
                if (!currentRoomId) {
                    alert('ãƒ«ãƒ¼ãƒ IDãŒå–å¾—ã§ãã¾ã›ã‚“');
                    return;
                }
                
                // âœ… roomIdã‚’ãƒœãƒ‡ã‚£ã«å«ã‚ã‚‹
                const response = await fetch('/api/clear-log', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ roomId: currentRoomId })
                });
                
                if (response.ok) {
                    messageCount = 0;
                    updateLogStats();
                    
                    // ãƒ­ã‚°ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ãŒé–‹ã„ã¦ã„ã‚‹å ´åˆã€ãƒ­ã‚°ã‚‚ã‚¯ãƒªã‚¢
                    if (logWindow && !logWindow.closed) {
                        logWindow.clearAllLogs();
                    }
                    
                    alert('ãƒ­ã‚°ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸ');
                    console.log('ãƒ­ã‚°ã‚¯ãƒªã‚¢å®Œäº†');
                } else {
                    throw new Error('ãƒ­ã‚°ã‚¯ãƒªã‚¢ã«å¤±æ•—ã—ã¾ã—ãŸ');
                }
            } catch (error) {
                console.error('ãƒ­ã‚°ã‚¯ãƒªã‚¢ã‚¨ãƒ©ãƒ¼:', error);
                alert('ãƒ­ã‚°ã‚¯ãƒªã‚¢ã«å¤±æ•—ã—ã¾ã—ãŸ');
            }
        }
        
        // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼è¨­å®š
        joinBtn.addEventListener('click', () => {
            const name = nameInput.value.trim();
            
            if (!name) {
                alert('å‚åŠ è€…åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }
            
            if (name.length > 20) {
                alert('å‚åŠ è€…åã¯20æ–‡å­—ä»¥å†…ã§å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }
            
            joinBtn.disabled = true;
            joinBtn.textContent = 'å‚åŠ ä¸­...';
            
            socket.emit('join', { 
                name: name,
                roomId: currentRoomId 
            });
        });
        
        // Enterã‚­ãƒ¼ã§ã‚‚å‚åŠ ã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹
        nameInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                joinBtn.click();
            }
        });
        
        // ãƒ­ã‚°è¡¨ç¤ºãƒœã‚¿ãƒ³
        logShowBtn.addEventListener('click', () => {
            console.log('ãƒ­ã‚°è¡¨ç¤ºãƒœã‚¿ãƒ³ãŒã‚¯ãƒªãƒƒã‚¯ã•ã‚Œã¾ã—ãŸ');
            openLogWindow();
        });
        
        // ãƒ­ã‚°ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼è¨­å®š
        exportTextBtn.addEventListener('click', async () => {
            console.log('ãƒ†ã‚­ã‚¹ãƒˆã®ã¿ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆãƒœã‚¿ãƒ³ãŒã‚¯ãƒªãƒƒã‚¯ã•ã‚Œã¾ã—ãŸ');
            await downloadCSV('text-only');
        });

        exportTimecodeBtn.addEventListener('click', async () => {
            console.log('ã‚¿ã‚¤ãƒ ã‚³ãƒ¼ãƒ‰ä»˜ãã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆãƒœã‚¿ãƒ³ãŒã‚¯ãƒªãƒƒã‚¯ã•ã‚Œã¾ã—ãŸ');
            await downloadCSV('with-timecode');
        });

        clearLogBtn.addEventListener('click', async () => {
            console.log('ãƒ­ã‚°ã‚¯ãƒªã‚¢ãƒœã‚¿ãƒ³ãŒã‚¯ãƒªãƒƒã‚¯ã•ã‚Œã¾ã—ãŸ');
            await clearLog();
        });

        // åˆæœŸåŒ–æ™‚ã«ãƒ­ã‚°çµ±è¨ˆã‚’æ›´æ–°
        updateLogStats();
        
        // è¨­å®šã‚’èª­ã¿è¾¼ã¿ï¼ˆDOMå®Œæˆå¾Œã«å®Ÿè¡Œï¼‰
        document.addEventListener('DOMContentLoaded', () => {
            console.log('DOMèª­ã¿è¾¼ã¿å®Œäº† - è¨­å®šåˆæœŸåŒ–é–‹å§‹');
            loadInputLinesSettings();
            loadCharGuideSettings();
        });
        
        // DOMContentLoadedãŒæ—¢ã«ç™ºç«ã—ã¦ã„ã‚‹å ´åˆã®å¯¾å¿œ
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', () => {
                console.log('DOMèª­ã¿è¾¼ã¿å®Œäº† - è¨­å®šåˆæœŸåŒ–é–‹å§‹');
                loadInputLinesSettings();
                loadCharGuideSettings();
            });
        } else {
            // æ—¢ã«DOMå®Œæˆã—ã¦ã„ã‚‹å ´åˆã¯å³åº§ã«å®Ÿè¡Œ
            console.log('DOMæ—¢ã«å®Œæˆ - è¨­å®šåˆæœŸåŒ–é–‹å§‹');
            setTimeout(() => {
                loadInputLinesSettings();
                loadCharGuideSettings();
            }, 50);
        }
    </script>
</body>
</html>