# サーバー再起動機能の実装手順

## 1. ファイルの配置

### 更新したファイル
- `main-server.js` - サーバー再起動機能を追加
- `public/room-manager.html` - サーバー管理画面を追加

## 2. Herokuでの環境変数設定（重要）

管理者トークンを設定して、不正な再起動を防ぎます。

### 方法1: Heroku Web管理画面から設定
1. Herokuダッシュボード(https://dashboard.heroku.com/)にログイン
2. アプリを選択
3. 「Settings」タブをクリック
4. 「Config Vars」セクションで「Reveal Config Vars」をクリック
5. 以下を追加:
   - KEY: `ADMIN_TOKEN`
   - VALUE: `ランダムで長い文字列` (例: `a7d9f3k2m5n8p1q4r6t9`)
6. 「Add」をクリック

### 方法2: Heroku CLIから設定
```bash
heroku config:set ADMIN_TOKEN=あなたの秘密のトークン -a アプリ名
```

### トークンの生成方法（推奨）UZYFcVjrNX5U
安全なランダム文字列を生成:
```bash
# PowerShellの場合
-join ((48..57) + (65..90) + (97..122) | Get-Random -Count 32 | ForEach-Object {[char]$_})

# オンラインツール
https://passwordsgenerator.net/
```

## 3. room-manager.htmlの設定

`room-manager.html` の以下の行を修正してください:

```javascript
// 修正前
const ADMIN_TOKEN = 'your-admin-token-here';

// 修正後（Herokuで設定した値と同じにする）
const ADMIN_TOKEN = 'a7d9f3k2m5n8p1q4r6t9'; // ← 実際のトークンに置き換え
```

**重要**: このトークンは秘密にしてください。GitHubにプッシュする場合は注意が必要です。

## 4. デプロイ手順

### GitHub Desktopを使用
1. GitHub Desktopで変更をコミット
2. コミットメッセージ: "サーバー再起動機能を追加"
3. 「Push origin」をクリック
4. Herokuで自動デプロイ（設定している場合）

### 手動デプロイ（Heroku Web管理画面）
1. Herokuダッシュボードでアプリを選択
2. 「Deploy」タブをクリック
3. 「Manual deploy」セクションで「Deploy Branch」をクリック

## 5. 動作確認

### 5-1. 接続確認
1. `https://あなたのアプリ.herokuapp.com/room-manager.html` にアクセス
2. 右上に「接続済み」と表示されることを確認
3. 「サーバー稼働時間」が表示されることを確認

### 5-2. 再起動テスト
1. 「サーバー管理」セクションの「サーバーを今すぐ再起動」ボタンをクリック
2. 確認ダイアログで「OK」をクリック
3. 「再起動まで X 秒...」というカウントダウンが表示される
4. 30秒ほど待つと自動的に再接続される
5. 稼働時間が0時間にリセットされていることを確認

## 6. 機能説明

### 稼働時間監視
- サーバーの起動時刻から経過時間を表示
- 23時間を超えるとアラートを表示
- デスクトップ通知で警告（許可が必要）

### 手動再起動
- 「サーバーを今すぐ再起動」ボタンで即座に再起動
- 全ユーザーに30秒前通知
- 再起動後は自動的に再接続

### 自動復帰（SIGTERM対応）
- Herokuの24時間サイクルで自動再起動
- 再起動時に全クライアントに通知
- room-managerが自動的にルームを再作成

## 7. 運用のコツ

### 推奨タイミング
- **作業開始前**: 長時間作業を始める前に再起動
- **休憩時**: 昼休みや長めの休憩時に再起動
- **23時間経過時**: アラートが出たら早めに再起動

### 避けるべきタイミング
- 本番配信中
- 研修の最中
- オペレーターが作業中

### トラブルシューティング

#### 再起動ボタンが効かない
- ブラウザのコンソールでエラーを確認
- `ADMIN_TOKEN`が正しく設定されているか確認
- Herokuの環境変数とHTMLのトークンが一致しているか確認

#### 23時間で通知が出ない
- ブラウザの通知許可を確認
- ページを開きっぱなしにしているか確認

#### 再接続に失敗する
- Herokuのログを確認: `heroku logs --tail -a アプリ名`
- サーバーが正常に起動しているか確認

## 8. セキュリティ注意事項

### トークンの管理
- ✅ Herokuの環境変数に保存
- ✅ 定期的に変更（3ヶ月に1回程度）
- ❌ GitHubにプッシュしない
- ❌ 他人に共有しない

### より安全な方法（オプション）
環境変数からトークンを動的に取得する方法:

```javascript
// room-manager.htmlで環境変数を参照（要サーバー側実装）
fetch('/api/admin-token')
  .then(res => res.json())
  .then(data => ADMIN_TOKEN = data.token);
```

## 9. コストについて

この機能による追加コストは**ありません**:
- 既存のdynoを使用
- 再起動は通常のHeroku機能
- 追加のアドオン不要

## 10. 今後の改善案

- [ ] ログに再起動履歴を記録
- [ ] 再起動のスケジュール機能
- [ ] より詳細なサーバー統計情報
- [ ] モバイル対応の改善
